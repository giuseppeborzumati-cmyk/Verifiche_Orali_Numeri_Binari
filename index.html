<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Verifiche di Informatica</title>
    <!-- Carica Tailwind CSS e un font accattivante -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#10b981', // Smeraldo vivace per l'accento
                        'secondary-orange': '#f97316',
                        'light-bg': '#e0f7fa',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; }

        .card-container {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .animated-btn {
            transition: all 0.2s ease;
            box-shadow: 0 4px #047857; /* Sombra verde scuro */
            transform: translateY(0);
        }
        .animated-btn:hover {
            box-shadow: 0 2px #047857;
            transform: translateY(2px);
        }
        .animated-btn:active {
            box-shadow: 0 0 #047857;
            transform: translateY(4px);
        }

        /* --- STILI DI STAMPA PDF/Verifica (MOLTO COLORATO) --- */
        @media print {
            body { 
                background-color: #ffffff !important; 
                margin: 0 !important; 
                padding: 0 !important;
            }
            #main-page, #correction-page, #app-container, #link-feedback {
                display: none !important;
            }

            .print-area {
                display: block !important;
                padding: 20mm 15mm;
                color: #1f2937; /* Grigio scuro per il testo */
            }

            .header-print {
                border-bottom: 5px solid #10b981; /* Bordo verde */
                padding-bottom: 10px;
                margin-bottom: 20px;
                background-color: #e0f7fa; /* Sfondo carta intestata leggero */
                padding: 15px;
                border-radius: 8px;
            }

            .exercise-item {
                border-left: 5px solid #f97316; /* Bordo arancione per ogni esercizio */
                padding-left: 10px;
                margin-bottom: 15px;
                page-break-inside: avoid;
            }
            .solution-text {
                color: #ef4444; /* Rosso chiaro per le soluzioni */
                font-weight: 600;
            }
            .student-info-print {
                display: flex;
                justify-content: space-between;
                margin-bottom: 20px;
                padding: 10px;
                border: 1px dashed #9ca3af;
                border-radius: 4px;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center bg-light-bg">

    <div id="app-container" class="w-full max-w-4xl">
        <h1 class="text-4xl font-black text-primary-blue mb-8 text-center drop-shadow-md">
            <span class="text-secondary-orange">V.I.T.A.</span> - Verifiche di Informatica Tecnica Assistita
        </h1>
        
        <!-- Vista Principale (Input e Selezione) -->
        <div id="main-page" class="card-container bg-white p-6 md:p-10 rounded-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Dati Studente e Tipo Verifica</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <input type="text" id="nome-studente" placeholder="Nome" class="input-field">
                <input type="text" id="cognome-studente" placeholder="Cognome" class="input-field">
                <input type="text" id="classe-studente" placeholder="Classe (es. 4IA)" class="input-field">
                <input type="date" id="data-verifica" class="input-field">
            </div>

            <div class="mb-8 p-4 bg-gray-50 rounded-lg">
                <p class="font-semibold text-gray-700">Docente:</p>
                <p class="text-lg font-mono text-primary-blue">Giuseppe Borzumati</p>
                <p class="text-sm text-gray-500">Argomento: I Sistemi di Numerazione Binaria</p>
            </div>
            
            <p class="text-lg font-semibold text-gray-800 mb-4">Scegli la Tipologia di Verifica:</p>

            <!-- Contenitori per le Verifiche -->
            <div id="quiz-blocks" class="space-y-6">
                <!-- Blocco Verifica 1 -->
                <div class="p-4 rounded-xl border border-primary-blue/50 bg-primary-blue/10">
                    <h3 class="text-xl font-bold text-primary-blue mb-3">Verifica 1: Conversione & Aritmetica</h3>
                    <p class="text-gray-700 text-sm mb-4">Focus su: Conversione incrociata tra Basi (2, 10, 8, 16), Operazioni Aritmetiche, Numeri Romani.</p>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button onclick="generateAndSaveQuiz('BinarioAritmetica')"
                                class="animated-btn bg-primary-blue hover:bg-emerald-600 text-white font-bold py-3 px-5 rounded-lg flex-1">
                            Genera & Scarica PDF Alunno
                        </button>
                        <button onclick="generateAndSaveQuiz('BinarioAritmetica', true)"
                                class="animated-btn bg-secondary-orange hover:bg-orange-600 text-white font-bold py-3 px-5 rounded-lg flex-1">
                            Genera & Scarica PDF Docente (Soluzioni)
                        </button>
                    </div>
                </div>

                <!-- Blocco Verifica 2 -->
                <div class="p-4 rounded-xl border border-secondary-orange/50 bg-secondary-orange/10">
                    <h3 class="text-xl font-bold text-secondary-orange mb-3">Verifica 2: Indirizzi IP & Binario</h3>
                    <p class="text-gray-700 text-sm mb-4">Focus su: Conversione, Numeri Binari con la Virgola, Esercizi sugli Indirizzi IP (Network/Broadcast/Host).</p>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button onclick="generateAndSaveQuiz('IPBinario')"
                                class="animated-btn bg-primary-blue hover:bg-emerald-600 text-white font-bold py-3 px-5 rounded-lg flex-1">
                            Genera & Scarica PDF Alunno
                        </button>
                        <button onclick="generateAndSaveQuiz('IPBinario', true)"
                                class="animated-btn bg-secondary-orange hover:bg-orange-600 text-white font-bold py-3 px-5 rounded-lg flex-1">
                            Genera & Scarica PDF Docente (Soluzioni)
                        </button>
                    </div>
                </div>

                <!-- Blocco Verifica 3 -->
                <div class="p-4 rounded-xl border border-blue-500/50 bg-blue-500/10">
                    <h3 class="text-xl font-bold text-blue-700 mb-3">Verifica 3: Mantissa, IP & Binario Completo</h3>
                    <p class="text-gray-700 text-sm mb-4">Focus su: Conversione in Notazione Esponenziale (Virgola Mobile), IP Addressing, Esercizi con Numeri Romani.</p>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button onclick="generateAndSaveQuiz('MantissaCompleto')"
                                class="animated-btn bg-primary-blue hover:bg-emerald-600 text-white font-bold py-3 px-5 rounded-lg flex-1">
                            Genera & Scarica PDF Alunno
                        </button>
                        <button onclick="generateAndSaveQuiz('MantissaCompleto', true)"
                                class="animated-btn bg-secondary-orange hover:bg-orange-600 text-white font-bold py-3 px-5 rounded-lg flex-1">
                            Genera & Scarica PDF Docente (Soluzioni)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Feedback Link Correzione -->
            <div id="link-feedback" class="mt-8 p-4 rounded-xl bg-yellow-100 text-yellow-800 font-medium text-center hidden">
                <p class="mb-3">Verifica generata e salvata. Scarica il PDF e poi...</p>
                <button id="open-correction-btn" onclick="openCorrectionPage()"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-lg w-full transition duration-300">
                    VAI ALLA PAGINA DI CORREZIONE
                </button>
            </div>
            
            <div id="auth-status" class="mt-6 p-3 rounded-lg text-sm text-center">Inizializzazione Firebase...</div>
            
        </div>

        <!-- PiÃ¨ di pagina -->
        <div class="mt-6 text-center text-sm text-gray-500">
            &copy; 2025 Riservato. Giuseppe Borzumati Docente di Informatica.
        </div>

    </div>

    <!-- Vista di Correzione (Simulata su stessa pagina con hash) -->
    <div id="correction-page" class="w-full max-w-4xl hidden mt-8">
        <h2 class="text-3xl font-extrabold text-blue-800 mb-6 text-center">Correzione Verifica in Tempo Reale</h2>
        <div id="correction-content" class="card-container bg-white p-6 md:p-10 rounded-2xl">
            <div id="correction-header" class="mb-6 p-4 bg-blue-50 rounded-lg">
                <p class="text-lg font-bold text-blue-700" id="corr-title"></p>
                <p class="text-sm text-gray-600" id="corr-student-info"></p>
                <p class="text-sm text-gray-500 mt-2">ID Verifica: <code id="corr-quiz-id" class="text-xs bg-gray-200 p-1 rounded"></code></p>
            </div>

            <div id="exercises-form" class="space-y-6">
                <p class="text-center text-gray-500">Caricamento esercizi...</p>
            </div>

            <div class="mt-8 pt-4 border-t border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Risultati:</h3>
                    <button onclick="showCorrection()" class="animated-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                        Visualizza Correzione
                    </button>
                </div>

                <div id="results-summary" class="space-y-2">
                    <p id="total-points" class="text-lg font-semibold text-gray-700">Punti Totali Ottenuti: <span id="points-value" class="text-2xl font-extrabold text-secondary-orange">0</span> / 20</p>
                    
                    <div class="flex items-center space-x-4">
                        <label for="oral-score" class="font-medium">Voto Orale (0-10):</label>
                        <input type="number" id="oral-score" value="6" min="0" max="10" step="0.5" 
                               onchange="calculateFinalGrade()"
                               class="w-20 p-2 border border-gray-300 rounded-lg text-lg text-center">
                    </div>

                    <p id="final-grade" class="mt-4 p-3 bg-green-100 border border-green-300 rounded-lg text-xl font-bold">
                        Voto Finale (su 10): <span id="grade-value" class="text-3xl text-green-700">N/A</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports & JS Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Imposta il livello di log
        setLogLevel('error');

        // Variabili Globali (MANDATORIE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let currentQuizData = null; // Memorizza i dati della verifica generata

        const DB_COLLECTION = `/artifacts/${appId}/public/data/verifiche_informatica`;

        // Elementi UI
        const mainPageEl = document.getElementById('main-page');
        const correctionPageEl = document.getElementById('correction-page');
        const authStatusEl = document.getElementById('auth-status');
        const linkFeedbackEl = document.getElementById('link-feedback');
        const openCorrectionBtn = document.getElementById('open-correction-btn');
        const exercisesFormEl = document.getElementById('exercises-form');
        const corrTitleEl = document.getElementById('corr-title');
        const corrStudentInfoEl = document.getElementById('corr-student-info');
        const corrQuizIdEl = document.getElementById('corr-quiz-id');

        // Funzioni di Supporto Generiche
        const RND = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const RND_FLOAT = (min, max, decimals = 2) => (Math.random() * (max - min) + min).toFixed(decimals);

        // --- AUTHENTICATION & INITIALIZATION ---
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                authStatusEl.textContent = 'Autenticazione in corso...';
                
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (error) {
                        console.error("Errore token custom. Fallback anonimo:", error.message);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `Connesso come: ${userId.substring(0, 8)}...`;
                        authStatusEl.className = 'mt-6 p-3 rounded-lg text-sm text-center bg-green-100 text-green-800';
                        // Controlla se caricare la pagina di correzione
                        checkUrlForCorrection();
                    } else {
                        userId = null;
                        authStatusEl.textContent = 'Disconnesso. Riprova.';
                        authStatusEl.className = 'mt-6 p-3 rounded-lg text-sm text-center bg-red-100 text-red-800';
                    }
                });
            } catch (error) {
                console.error("Errore irreversibile nell'inizializzazione Firebase:", error);
                authStatusEl.textContent = `Errore critico: ${error.message}`;
                authStatusEl.className = 'mt-6 p-3 rounded-lg text-sm text-center bg-red-100 text-red-800';
            }
        }

        // --- ROUTING / VISTE ---
        function checkUrlForCorrection() {
            const hash = window.location.hash.substring(1); // Ottiene il quizId dall'URL
            if (hash && hash.startsWith('quiz=')) {
                const quizId = hash.substring(5);
                loadCorrectionPage(quizId);
            } else {
                mainPageEl.style.display = 'block';
                correctionPageEl.style.display = 'none';
            }
        }

        function openCorrectionPage() {
            if (currentQuizData && currentQuizData.quizId) {
                const quizId = currentQuizData.quizId;
                // Simula il routing a una nuova pagina usando l'hash URL
                const newUrl = window.location.origin + window.location.pathname + `#quiz=${quizId}`;
                window.open(newUrl, '_blank');
                linkFeedbackEl.classList.add('hidden'); // Nasconde il pulsante temporaneo
            }
        }

        // --- GENERAZIONE ESERCIZI (Logica) ---
        
        // Esercizi Numeri Romani
        function generateRoman() {
            const num = RND(100, 3999);
            const symbols = { 1000: 'M', 900: 'CM', 500: 'D', 400: 'CD', 100: 'C', 90: 'XC', 50: 'L', 40: 'XL', 10: 'X', 9: 'IX', 5: 'V', 4: 'IV', 1: 'I' };
            let result = '';
            let n = num;
            for (const value in symbols) {
                while (n >= parseInt(value)) {
                    result += symbols[value];
                    n -= parseInt(value);
                }
            }
            return {
                question: `Converti il numero Romano ${result} in base 10 e determina la sua posizione nel sistema (numero decimale a 32 bit).`,
                solution: num.toString(),
                punteggio: 2
            };
        }

        // Esercizi di Conversione Base
        function generateConversion(from, to) {
            let num, question, solution;
            const decimal = RND(16, 512);

            switch (`${from}-${to}`) {
                case 'Dec-Bin':
                    num = decimal;
                    solution = num.toString(2);
                    question = `Converti il numero Decimale ${num} in base 2 (Binario).`;
                    break;
                case 'Bin-Dec':
                    num = decimal.toString(2);
                    solution = decimal.toString();
                    question = `Converti il numero Binario ${num} in base 10 (Decimale).`;
                    break;
                case 'Bin-Hex':
                    num = decimal.toString(2).padStart(8, '0');
                    solution = decimal.toString(16).toUpperCase();
                    question = `Converti il numero Binario ${num} in base 16 (Esadecimale).`;
                    break;
                case 'Hex-Dec':
                    num = decimal.toString(16).toUpperCase();
                    solution = decimal.toString();
                    question = `Converti il numero Esadecimale ${num} in base 10 (Decimale).`;
                    break;
                case 'Oct-Bin':
                    num = decimal.toString(8);
                    solution = decimal.toString(2);
                    question = `Converti il numero Ottale ${num} in base 2 (Binario).`;
                    break;
                case 'Bin-Oct':
                    num = decimal.toString(2);
                    solution = decimal.toString(8);
                    question = `Converti il numero Binario ${num} in base 8 (Ottale).`;
                    break;
                default:
                    return null;
            }
            
            return {
                question: `${question} Determina la posizione del bit meno significativo (LSB) nel risultato.`,
                solution: solution,
                punteggio: 1
            };
        }

        // Esercizi Operazioni (Binario)
        function generateOperation(op) {
            const dec1 = RND(8, 32);
            const dec2 = RND(2, 7);
            const bin1 = dec1.toString(2).padStart(8, '0');
            const bin2 = dec2.toString(2).padStart(8, '0');
            let result, question;

            switch (op) {
                case 'Addizione':
                    result = dec1 + dec2;
                    question = `Esegui l'Addizione tra i numeri Binari ${bin1} + ${bin2}. Scrivi il risultato in binario e decimale.`;
                    break;
                case 'Sottrazione':
                    result = dec1 - dec2;
                    question = `Esegui la Sottrazione tra i numeri Binari ${bin1} - ${bin2} usando il complemento a due. Scrivi il risultato in binario e decimale.`;
                    break;
                case 'Moltiplicazione':
                    result = dec1 * dec2;
                    question = `Esegui la Moltiplicazione tra i numeri Binari ${bin1} * ${bin2}. Scrivi il risultato in binario e decimale.`;
                    break;
                default:
                    return null;
            }

            return {
                question: question,
                solution: `${result.toString(2)} (${result.toString(10)})`,
                punteggio: 2
            };
        }

        // Esercizi con la Virgola (Float)
        function generateFloatConversion() {
            const decPart = RND(1, 15);
            const fracPart = RND(1, 99) / 100; // Es. 0.45
            const decNum = decPart + fracPart;
            const binDecPart = decPart.toString(2);

            // Per la parte frazionaria, convertiamo solo un paio di bit per non renderla troppo lunga
            let fracBin = '';
            let tempFrac = fracPart;
            for (let i = 0; i < 4; i++) {
                tempFrac *= 2;
                fracBin += Math.floor(tempFrac);
                tempFrac -= Math.floor(tempFrac);
            }
            const binNum = `${binDecPart}.${fracBin}`;
            
            return {
                question: `Dato il numero Binario con la virgola ${binNum}, convertilo in base 10 (Decimale). Determina la posizione del punto binario.`,
                solution: decNum.toFixed(2),
                punteggio: 3
            };
        }

        // Esercizi Mantissa/Notazione Esponenziale
        function generateMantissa() {
            const exponent = RND(-7, -3);
            const base = RND(10, 30).toString(2); 
            const binNum = `${base}.101 * 2^${exponent}`; // Es. 10101.101 * 2^-5

            // Calcolo approssimativo per la soluzione
            const decValue = parseInt(base, 2) + 0.625; // 0.101 Ã¨ 0.5 + 0.125
            const solution = (decValue * Math.pow(2, exponent)).toPrecision(4);
            
            return {
                question: `Dato il numero in Notazione Esponenziale ${binNum} (IEEE-754 semplificato), convertilo nel suo valore Decimale. Spiega cosa rappresenta il valore ${exponent}.`,
                solution: solution,
                punteggio: 3
            };
        }

        // Esercizi Indirizzi IP
        function generateIP() {
            const octet1 = RND(192, 223); // Classe C o D
            const octet2 = RND(168, 170);
            const octet3 = RND(0, 255);
            const host = RND(1, 254);
            const cidr = RND(24, 29);
            
            const ipAddress = `${octet1}.${octet2}.${octet3}.${host}`;
            
            // Calcolo Semplificato (assumiamo un calcolo standard per la soluzione)
            const networkBits = cidr;
            const hostBits = 32 - networkBits;
            const mask = (0xFFFFFFFF << (32 - cidr)) >>> 0;
            const networkAddrInt = (ipToInteger(ipAddress) & mask) >>> 0;
            const broadcastAddrInt = (networkAddrInt | (~mask)) >>> 0;
            
            const networkAddr = integerToIP(networkAddrInt);
            const broadcastAddr = integerToIP(broadcastAddrInt);
            
            const firstHost = networkAddr.substring(0, networkAddr.lastIndexOf('.')) + '.' + (parseInt(networkAddr.split('.').pop()) + 1);
            const lastHost = broadcastAddr.substring(0, broadcastAddr.lastIndexOf('.')) + '.' + (parseInt(broadcastAddr.split('.').pop()) - 1);


            return {
                question: `Dato l'indirizzo IP ${ipAddress}/${cidr}, determina: 1) L'Indirizzo di Rete, 2) L'Indirizzo di Broadcast, 3) Il primo e l'ultimo indirizzo Host utilizzabile.`,
                solution: `Rete: ${networkAddr}, Broadcast: ${broadcastAddr}, Primo Host: ${firstHost}, Ultimo Host: ${lastHost}`,
                punteggio: 4
            };
        }

        function ipToInteger(ip) {
            return ip.split('.').reduce((int, octet) => (int << 8) + parseInt(octet, 10), 0);
        }

        function integerToIP(int) {
            return [
                (int >>> 24) & 0xFF,
                (int >>> 16) & 0xFF,
                (int >>> 8) & 0xFF,
                int & 0xFF
            ].join('.');
        }


        // --- LOGICA DI GENERAZIONE COMPLETA ---
        function generateQuizExercises(quizType) {
            let exercises = [];
            const conversions = ['Bin-Dec', 'Dec-Bin', 'Bin-Hex', 'Hex-Dec', 'Oct-Bin', 'Bin-Oct'];
            let conversionIndex = 0;

            const totalExercises = 20;

            for (let i = 1; i <= totalExercises; i++) {
                let exercise;
                let isSpecial = false;

                // Alternanza di esercizi e complessitÃ 
                if (quizType === 'BinarioAritmetica') {
                    if (i % 4 === 0) {
                        exercise = generateOperation(['Addizione', 'Sottrazione', 'Moltiplicazione'][RND(0, 2)]);
                    } else if (i % 7 === 0) {
                        exercise = generateRoman();
                    } else {
                        exercise = generateConversion(conversions[conversionIndex % conversions.length].split('-')[0], conversions[conversionIndex % conversions.length].split('-')[1]);
                        conversionIndex++;
                    }
                } else if (quizType === 'IPBinario') {
                    if (i % 3 === 0) {
                        exercise = generateIP();
                        isSpecial = true;
                    } else if (i % 5 === 0) {
                        exercise = generateFloatConversion();
                    } else {
                        exercise = generateConversion(conversions[conversionIndex % conversions.length].split('-')[0], conversions[conversionIndex % conversions.length].split('-')[1]);
                        conversionIndex++;
                    }
                } else if (quizType === 'MantissaCompleto') {
                    if (i % 3 === 0) {
                        exercise = generateMantissa();
                        isSpecial = true;
                    } else if (i % 5 === 0) {
                        exercise = generateIP();
                    } else if (i % 7 === 0) {
                        exercise = generateRoman();
                    } else {
                        exercise = generateConversion(conversions[conversionIndex % conversions.length].split('-')[0], conversions[conversionIndex % conversions.length].split('-')[1]);
                        conversionIndex++;
                    }
                }
                
                if (exercise) {
                    exercises.push({
                        id: i,
                        domanda: exercise.question,
                        soluzione: exercise.solution.toString(),
                        punteggio: isSpecial ? exercise.punteggio : 1 // Punteggio variabile
                    });
                }
            }

            return exercises;
        }

        // --- FUNZIONE PRINCIPALE: Genera, Salva, e Stampa PDF ---
        async function generateAndSaveQuiz(quizType, isTeacher = false) {
            if (!userId) {
                alert('Attendere l\'autenticazione a Firebase...');
                return;
            }

            const datiStudente = {
                nome: document.getElementById('nome-studente').value.trim(),
                cognome: document.getElementById('cognome-studente').value.trim(),
                classe: document.getElementById('classe-studente').value.trim(),
                data: document.getElementById('data-verifica').value || new Date().toLocaleDateString('it-IT'),
            };

            if (!datiStudente.nome || !datiStudente.cognome) {
                alert('Inserisci Nome e Cognome dello studente prima di generare il PDF!');
                return;
            }

            // 1. Genera Esercizi e Dati
            const exercises = generateQuizExercises(quizType);
            const quizId = crypto.randomUUID();
            const totalPoints = exercises.reduce((sum, ex) => sum + ex.punteggio, 0);

            currentQuizData = {
                quizId: quizId,
                datiStudente: datiStudente,
                esercizi: exercises,
                metadati: {
                    docente: "Giuseppe Borzumati",
                    argomento: "I Sistemi di Numerazione Binaria",
                    tipoVerifica: quizType,
                    puntiMax: totalPoints
                },
                timestamp: serverTimestamp()
            };

            // 2. Salva Soluzione nel Database
            try {
                await setDoc(doc(db, DB_COLLECTION, quizId), currentQuizData);
                console.log("Verifica salvata con ID:", quizId);
            } catch (e) {
                console.error("Errore salvataggio Firestore:", e);
                alert("Errore nel salvataggio della verifica su Firebase. Controlla la console.");
                return;
            }

            // 3. Genera e Scarica il PDF (Simulato con Stampa)
            generatePrintArea(currentQuizData, isTeacher);

            // 4. Mostra Pulsante Correzione (Solo per lo studente)
            if (!isTeacher) {
                openCorrectionBtn.onclick = () => openCorrectionPage();
                linkFeedbackEl.classList.remove('hidden');
            } else {
                linkFeedbackEl.classList.add('hidden');
            }
        }

        // --- STAMPA PDF (HTML-to-PDF via window.print) ---
        function generatePrintArea(quizData, isTeacher) {
            const totalPoints = quizData.metadati.puntiMax;
            
            // Crea un'area temporanea per la stampa
            let printArea = document.querySelector('.print-area');
            if (printArea) printArea.remove();
            
            printArea = document.createElement('div');
            printArea.className = 'print-area hidden';
            
            // Header Colorato e Dettagliato
            let htmlContent = `
                <div class="header-print">
                    <h1 style="color:#10b981; font-size: 24pt; font-weight: 900; margin: 0;">VERIFICA DI INFORMATICA</h1>
                    <p style="margin: 5px 0 0; font-size: 10pt; color: #f97316; font-weight: 600;">DOCENTE: Giuseppe Borzumati</p>
                    <p style="margin: 0; font-size: 9pt; color: #4b5563;">Argomento: ${quizData.metadati.argomento} (Punti Max: ${totalPoints})</p>
                </div>

                <div class="student-info-print">
                    <p><strong>Nome:</strong> ${quizData.datiStudente.nome}</p>
                    <p><strong>Cognome:</strong> ${quizData.datiStudente.cognome}</p>
                    <p><strong>Classe:</strong> ${quizData.datiStudente.classe}</p>
                    <p><strong>Data:</strong> ${quizData.datiStudente.data}</p>
                </div>
                
                ${isTeacher ? '<h2 style="color:#ef4444; font-size: 18pt; margin-bottom: 20px;">SOLUZIONI PER IL DOCENTE</h2>' : '<h2 style="color:#1f2937; font-size: 18pt; margin-bottom: 20px;">Tracce Esercizi</h2>'}
                
                <ol style="list-style-type: decimal; padding-left: 20px;">
            `;

            quizData.esercizi.forEach(ex => {
                const solutionHtml = isTeacher 
                    ? `<br><span class="solution-text">SOLUZIONE: ${ex.soluzione}</span> (Punti: ${ex.punteggio})` 
                    : ` (Punti: ${ex.punteggio})`;

                htmlContent += `
                    <li class="exercise-item">
                        <p style="font-weight: 600; margin-bottom: 5px;">${ex.domanda}${solutionHtml}</p>
                        ${!isTeacher ? `<p style="min-height: 25px; border-bottom: 1px dashed #cccccc; margin-bottom: 15px;">Risposta:</p>` : ''}
                    </li>
                `;
            });

            htmlContent += `</ol>`;

            printArea.innerHTML = htmlContent;
            document.body.appendChild(printArea);

            // Stampa e cleanup
            window.print();
            
            // Rinomina il file scaricato automaticamente dal browser
            const fileName = isTeacher 
                ? `VERIFICA_DOCENTE_SOLUZIONI_${quizData.datiStudente.cognome}_${quizData.datiStudente.nome}.pdf`
                : `VERIFICA_STUDENTE_${quizData.datiStudente.cognome}_${quizData.datiStudente.nome}.pdf`;
            
            // Nota: La ridenominazione automatica diretta in JS non Ã¨ possibile
            // ma l'utente puÃ² salvare con il nome desiderato.

            setTimeout(() => {
                printArea.remove(); // Rimuove l'area di stampa dal DOM
            }, 100);
        }

        // --- PAGINA DI CORREZIONE (Logica) ---
        async function loadCorrectionPage(quizId) {
            mainPageEl.style.display = 'none';
            correctionPageEl.style.display = 'block';

            corrQuizIdEl.textContent = quizId;
            exercisesFormEl.innerHTML = '<p class="text-center text-blue-500 font-semibold">Caricamento delle soluzioni dal Database...</p>';
            
            try {
                const docRef = doc(db, DB_COLLECTION, quizId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    exercisesFormEl.innerHTML = '<p class="text-center text-red-500 font-semibold">Verifica non trovata nel database.</p>';
                    return;
                }

                const quiz = docSnap.data();
                currentQuizData = quiz; // Aggiorna i dati per la correzione

                corrTitleEl.textContent = `Verifica: ${quiz.metadati.tipoVerifica.replace(/([A-Z])/g, ' $1').trim()}`;
                corrStudentInfoEl.textContent = `Studente: ${quiz.datiStudente.nome} ${quiz.datiStudente.cognome} | Classe: ${quiz.datiStudente.classe} | Data: ${quiz.datiStudente.data}`;
                
                renderCorrectionForm(quiz.esercizi);

            } catch (e) {
                console.error("Errore caricamento verifica:", e);
                exercisesFormEl.innerHTML = `<p class="text-center text-red-500 font-semibold">Errore di connessione o lettura: ${e.message}</p>`;
            }
        }

        function renderCorrectionForm(exercises) {
            exercisesFormEl.innerHTML = ''; // Pulisce il caricamento
            exercises.forEach((ex, index) => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 rounded-lg bg-white shadow-sm';
                div.innerHTML = `
                    <p class="font-bold text-gray-800 mb-2">Esercizio ${index + 1} (${ex.punteggio} Punti)</p>
                    <p class="text-gray-700 mb-3">${ex.domanda}</p>
                    <input type="text" id="answer-${ex.id}" data-solution="${ex.soluzione}" data-points="${ex.punteggio}" 
                           oninput="updateCorrection(${ex.id})"
                           placeholder="Inserisci la tua risposta qui..."
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                    <p id="feedback-${ex.id}" class="mt-2 text-sm font-semibold"></p>
                    <p id="solution-${ex.id}" class="mt-2 text-sm font-semibold text-green-700 hidden">Soluzione Corretta: ${ex.soluzione}</p>
                `;
                exercisesFormEl.appendChild(div);
            });
            // Calcola il voto iniziale (solo orale)
            calculateFinalGrade(); 
        }

        function updateCorrection(id) {
            const inputEl = document.getElementById(`answer-${id}`);
            const feedbackEl = document.getElementById(`feedback-${id}`);
            const solution = inputEl.getAttribute('data-solution').toLowerCase().replace(/\s/g, '');
            const answer = inputEl.value.trim().toLowerCase().replace(/\s/g, '');

            if (answer === '') {
                feedbackEl.textContent = '';
                inputEl.classList.remove('border-green-500', 'border-red-500');
            } else if (answer === solution || solution.includes(answer)) { // Correzione piÃ¹ flessibile
                feedbackEl.textContent = 'Corretto!';
                feedbackEl.className = 'mt-2 text-sm font-semibold text-green-700';
                inputEl.classList.add('border-green-500');
                inputEl.classList.remove('border-red-500');
            } else {
                feedbackEl.textContent = 'Non Corretto.';
                feedbackEl.className = 'mt-2 text-sm font-semibold text-red-600';
                inputEl.classList.add('border-red-500');
                inputEl.classList.remove('border-green-500');
            }

            calculateFinalGrade();
        }
        
        function showCorrection() {
            // Mostra le soluzioni corrette e nasconde il pulsante di correzione
            document.querySelectorAll('[id^="solution-"]').forEach(el => el.classList.remove('hidden'));
            document.querySelector('.pt-4 .flex button').classList.add('hidden');
        }

        function calculateFinalGrade() {
            if (!currentQuizData) return;
            
            let pointsScored = 0;
            const maxPoints = currentQuizData.metadati.puntiMax;
            
            currentQuizData.esercizi.forEach(ex => {
                const inputEl = document.getElementById(`answer-${ex.id}`);
                if (inputEl) {
                    const solution = inputEl.getAttribute('data-solution').toLowerCase().replace(/\s/g, '');
                    const answer = inputEl.value.trim().toLowerCase().replace(/\s/g, '');
                    
                    if (answer === solution || solution.includes(answer)) {
                        pointsScored += ex.punteggio;
                    }
                }
            });

            // Calcolo Punti
            const oralScore = parseFloat(document.getElementById('oral-score').value) || 0;
            const writtenScore = (pointsScored / maxPoints) * 10; // Voto teorico su base 10
            
            // Calcolo Voto Finale (Proporzione basata sui 20 punti + Orale)
            // Usiamo il 70% per lo scritto e il 30% per l'orale
            const finalGrade = (writtenScore * 0.7) + (oralScore * 0.3);
            const finalGradeClamped = Math.max(0, Math.min(10, finalGrade)).toFixed(1);

            document.getElementById('points-value').textContent = pointsScored;
            document.getElementById('grade-value').textContent = finalGradeClamped;

            const finalGradeEl = document.getElementById('final-grade');
            if (finalGradeClamped >= 6.0) {
                finalGradeEl.className = 'mt-4 p-3 bg-green-100 border border-green-300 rounded-lg text-xl font-bold';
            } else {
                finalGradeEl.className = 'mt-4 p-3 bg-red-100 border border-red-300 rounded-lg text-xl font-bold';
            }
        }

        // Avvia l'app
        initFirebase();
    </script>
</body>
</html>
