<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Verifiche Informatica - Borzumati</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .code-font { font-family: 'Roboto Mono', monospace; }

        /* Stili per la stampa PDF (ottimizzazione A4) */
        @media print {
            body { font-family: sans-serif !important; font-size: 10pt; }
            body > *:not(.print-container) { display: none !important; }
            
            /* Il contenitore di stampa deve essere l'unico visibile */
            .print-container {
                display: block !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                height: auto;
                background-color: white;
            }
            @page { margin: 1cm; size: A4; }
            
            .print-header h1 { font-size: 16pt !important; }
            .print-header p { font-size: 9pt !important; }
            
            /* Forza le due colonne per gli esercizi */
            .print-list { 
                columns: 2; 
                column-gap: 20px; 
                list-style-position: inside;
            } 
            .print-list li { 
                break-inside: avoid; 
                margin-bottom: 0.8rem !important; 
                padding-bottom: 0.3rem; 
                border-bottom: 1px dashed #ccc;
            } 
            .print-list p { margin-top: 0.2rem !important; } 
            .print-list span { height: 1.5em !important; }
            
            .print-table { page-break-before: always; }
        }

        /* Stili per i pulsanti animati (Effetto Olografico/Shine) */
        .action-button {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-weight: 700;
            position: relative;
            overflow: hidden;
        }
        .action-button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
        .action-button::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: skewX(-20deg);
            transition: all 0.7s;
        }
        .action-button:hover::before { left: 100%; }

        /* Gradienti personalizzati per i pulsanti */
        .bg-gradient-blue { background-image: linear-gradient(to right, #4c66ff 0%, #00c6ff 100%); }
        .bg-gradient-green { background-image: linear-gradient(to right, #10b981 0%, #1d7c4c 100%); }
        .bg-gradient-red { background-image: linear-gradient(to right, #ef4444 0%, #b91c1c 100%); }
        .bg-gradient-yellow { background-image: linear-gradient(to right, #facc15 0%, #d97706 100%); }

        /* Stili per la vista Correzione */
        .feedback-correct { border: 3px solid #10b981; background-color: #d1fae5; }
        .feedback-wrong { border: 3px solid #ef4444; background-color: #fee2e2; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 sm:p-8">

    <!-- Sezione Dati Studente/Docente e Introduzione -->
    <div id="main-view" class="w-full max-w-7xl mx-auto bg-white rounded-xl shadow-[0_25px_50px_-12px_rgba(0,0,0,0.5)] p-6 sm:p-12 mb-8 space-y-10">
        <header class="text-center pb-6 border-b-4 border-indigo-500">
            <h1 class="text-4xl sm:text-6xl font-black leading-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-purple-600">
                    GENERATORE VERIFICHE INFORMATICA
                </span>
            </h1>
            <p class="text-xl text-gray-700 mt-2">Prof. Giuseppe Borzumati | Argomento: Sistemi di Numerazione & Networking Avanzato</p>
        </header>

        <!-- Dati Studente per la Generazione (Globali) -->
        <div class="bg-indigo-50 p-8 rounded-2xl shadow-inner border border-indigo-200">
            <h2 class="text-2xl font-bold text-indigo-800 mb-5 flex items-center">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 mr-2 text-indigo-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                 </svg>
                Dati Studente per la Verifica
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <input type="text" id="nome-studente" placeholder="Nome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <p class="text-xs text-indigo-500 mt-1">Nome obbligatorio per il link.</p>
                </div>
                <div>
                    <input type="text" id="cognome-studente" placeholder="Cognome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <p class="text-xs text-indigo-500 mt-1">Cognome obbligatorio per il link.</p>
                </div>
                <div>
                    <input type="text" id="classe-studente" placeholder="Classe (es. 4B)" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <p class="text-xs text-indigo-500 mt-1">Es. 3A, 4B, ecc.</p>
                </div>
                <div>
                    <input type="date" id="data-verifica" value="" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <p class="text-xs text-indigo-500 mt-1">Data di svolgimento.</p>
                </div>
            </div>
        </div>

        <!-- Contenitore delle Verifiche (4 Blocchi) -->
        <div class="space-y-12">
            
            <!-- BLOCCO 1: Verifiche Numeriche PURE -->
            <div id="blocco-verifica-a" class="p-8 bg-red-50 border-t-8 border-t-red-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-red-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¢</span> VERIFICA A: Base & Operazioni Binarie
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Binario, Decimale, Ottale, Esadecimale, Divisione/Moltiplicazione Binaria (2 Punti).</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" 
                            onclick="handleGeneration('A', true)">
                        Genera PDF Alunno
                    </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" 
                            onclick="handleGeneration('A', false)">
                        Genera PDF Docente
                    </button>
                </div>
                <div id="link-container-A" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-red-600 border-b border-red-300 pb-1">Link Attivi per Correzione (Verifica A):</h4>
                </div>
            </div>

            <!-- BLOCCO 2: Indirizzamento IP (Subnetting) + Conversione Avanzata -->
            <div id="blocco-verifica-b" class="p-8 bg-purple-50 border-t-8 border-t-purple-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-purple-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üåê</span> VERIFICA B: Networking e Sistemi di Numerazione
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Subnetting (Network ID, Broadcast ID, Maschera) e mix di conversioni numeriche Basi 2, 8, 10, 16.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" 
                            onclick="handleGeneration('B', true)">
                        Genera PDF Alunno
                    </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" 
                            onclick="handleGeneration('B', false)">
                        Genera PDF Docente
                    </button>
                </div>
                <div id="link-container-B" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-purple-600 border-b border-purple-300 pb-1">Link Attivi per Correzione (Verifica B):</h4>
                </div>
            </div>

            <!-- BLOCCO 3: Complemento a Due, IP e Floating Point -->
            <div id="blocco-verifica-c" class="p-8 bg-teal-50 border-t-8 border-t-teal-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-teal-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¨</span> VERIFICA C: Complemento a Due, Floating Point e IP Avanzato
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Rappresentazione in Complemento a Due (8 bit), Esponente/Mantissa e Subnetting complesso.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" 
                            onclick="handleGeneration('C', true)">
                        Genera PDF Alunno
                    </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" 
                            onclick="handleGeneration('C', false)">
                        Genera PDF Docente
                    </button>
                </div>
                <div id="link-container-C" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-teal-600 border-b border-teal-300 pb-1">Link Attivi per Correzione (Verifica C):</h4>
                </div>
            </div>

            <!-- BLOCCO 4: VERIFICA D - COMPLESSA E COMPLETA -->
            <div id="blocco-verifica-d" class="p-8 bg-yellow-50 border-t-8 border-t-yellow-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-yellow-800 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">‚≠ê</span> VERIFICA D: Complessa (FULL ADVANCED)
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Mix di TUTTE le tracce avanzate, incluse Base Ignota e ASCII. Ideale per la valutazione sommativa.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" 
                            onclick="handleGeneration('D', true)">
                        Genera PDF Alunno
                    </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" 
                            onclick="handleGeneration('D', false)">
                        Genera PDF Docente
                    </button>
                </div>
                <div id="link-container-D" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-yellow-700 border-b border-yellow-300 pb-1">Link Attivi per Correzione (Verifica D):</h4>
                </div>
            </div>

        </div>

        <footer class="text-center pt-8 text-gray-500 text-sm border-t border-gray-200">
            <p>&copy; Materiale didattico per l'Insegnante Giuseppe Borzumati. Sistema v6.0 - Aggiornato con Divisione Binaria e Correzione Sicura.</p>
        </footer>
    </div>

    <!-- VISTA DI CORREZIONE (Caricata tramite link condivisibile) -->
    <div id="correction-view" class="hidden w-full max-w-5xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10 mb-8 space-y-8">
        <header class="text-center pb-4 border-b-4 border-green-500">
            <h1 class="text-4xl font-extrabold text-green-700 leading-tight">Area Risposte Studente</h1>
            <p class="text-lg text-gray-600 mt-1">Studente: <span id="corr-student-name" class="font-extrabold text-indigo-600"></span> - Verifica <span id="corr-title"></span></p>
        </header>
        
        <!-- Tabella Punteggio e Voto (Visibile subito per il voto scritto NON modificabile) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 bg-yellow-50 p-6 rounded-xl border-2 border-yellow-300 shadow-lg">
            <div class="col-span-1 lg:col-span-3">
                <h2 class="text-2xl font-bold text-yellow-800 mb-2 border-b border-yellow-400 pb-1">Griglia di Valutazione (Punti Max: 11)</h2>
            </div>
            
            <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-blue-800">Punti Ottenuti (Scritto):</p>
                <p class="text-4xl font-extrabold text-blue-600 mt-1"><span id="corr-points">0</span> / 11</p>
            </div>
            
            <!-- Voto Orale e Voto Finale sono nascosti e sbloccati solo dopo l'inserimento della password docente -->
            <div id="teacher-inputs" class="lg:col-span-2 grid grid-cols-2 gap-4">
                <div class="bg-purple-100 p-4 rounded-lg shadow-md">
                    <p class="text-sm font-semibold text-purple-800">Voto Orale (Impostato dal Docente):</p>
                    <input type="number" id="voto-orale" min="0" max="10" step="0.5" value="6.0" onchange="updateFinalGrade()" 
                           class="p-2 border-2 border-purple-500 rounded-lg w-full mt-1 text-xl font-bold">
                </div>
                
                <div class="bg-red-100 p-4 rounded-lg shadow-md">
                    <p class="text-sm font-semibold text-red-800">Voto Finale (50% Scritto + 50% Orale):</p>
                    <p class="text-4xl font-extrabold text-red-600 mt-1"><span id="corr-grade-floored">0</span> / 10</p>
                </div>
            </div>

            <div class="col-span-1 lg:col-span-3 bg-gray-100 p-4 rounded-lg border border-gray-300" id="conversion-explanation">
                <p class="text-sm font-bold text-gray-700">Il voto finale √® una media ponderata: 50% Scritto + 50% Orale.</p>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded">
                    Voto Scritto Base 10 = (0 / 11) * 10 = 0.00
                </code>
            </div>
        </div>

        <!-- Esercizi con Input Studente -->
        <div id="correction-form" class="space-y-6">
            <!-- Gli esercizi e i campi di input saranno popolati qui dal JS -->
        </div>

        <!-- Pulsante Download (Protetta da password) -->
        <button id="download-results-btn" class="action-button bg-gray-700 hover:bg-gray-800 text-white py-4 px-8 rounded-xl text-lg mt-8 w-full" 
                onclick="promptPasswordAndDownload()">
            Scarica PDF dei Risultati (Riservato Docente - Richiede Password)
        </button>
        
        <button class="action-button bg-gray-400 hover:bg-gray-500 text-gray-900 py-3 px-6 rounded-lg text-lg w-full" 
                onclick="showMainView()">
            Torna alla Generazione Verifiche
        </button>
    </div>

    <!-- Contenitore Nascosto per la Stampa PDF (Stile ottimizzato per PDF) -->
    <div id="print-area" class="print-container hidden"></div>

    <script>
        // -------------------------------------------------------------------------
        // VARIABILI GLOBALI E UTILIT√Ä
        // -------------------------------------------------------------------------

        const STORAGE_KEY = 'borzumati_exams_v6';
        const MAX_EXERCISES = 10;
        const MAX_POINTS = 11; // Punti effettivi per la valutazione
        const TEACHER_PASSWORD = "DOCENTE"; // Password fittizia per sbloccare la correzione

        let currentExamData = null; 
        let isTeacherMode = false; // Flag per abilitare la visualizzazione delle correzioni

        // Funzione per generare un ID unico
        const generateUniqueID = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 5);

        // Funzioni di caricamento/salvataggio (modificate per salvare il PDF HTML)
        function loadExams() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : { A: [], B: [], C: [], D: [] };
            } catch (e) {
                console.error("Errore nel caricamento da localStorage", e);
                return { A: [], B: [], C: [], D: [] };
            }
        }
        function saveExams(exams) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(exams));
                updateLinkContainers();
            } catch (e) {
                console.error("Errore nel salvataggio su localStorage", e);
            }
        }
        
        // Funzione per convertire IP a binario (32 bit)
        function ipToBinary(ip) {
             return ip.split('.').map(o => parseInt(o).toString(2).padStart(8, '0')).join('');
        }

        // Funzione per generare un numero binario con parte frazionaria
        function generateBinaryFractional(intBits, fracBits) {
            const integerPart = Math.floor(Math.random() * (Math.pow(2, intBits) - 1)) + 1;
            let fractionalPart = 0;
            for (let i = 0; i < fracBits; i++) {
                if (Math.random() > 0.5) { fractionalPart += Math.pow(2, -(i + 1)); }
            }
            
            let binInteger = integerPart.toString(2);
            let binFractional = '';
            let tempFrac = fractionalPart;
            for (let i = 0; i < fracBits; i++) {
                tempFrac *= 2;
                binFractional += Math.floor(tempFrac);
                tempFrac -= Math.floor(tempFrac);
            }
            
            const decimalValue = integerPart + fractionalPart;
            const binaryValue = binInteger + (binFractional.length > 0 ? '.' + binFractional : '');
            
            return { decimal: parseFloat(decimalValue.toFixed(4)), binary: binaryValue };
        }
        
        // Funzione per calcolare il Complemento a Due (8 bit)
        function toTwosComplement(num) {
            if (num < 0) {
                let bin = Math.abs(num).toString(2).padStart(8, '0');
                let inverted = [...bin].map(b => b === '0' ? '1' : '0').join('');
                let carry = 1;
                let twosComp = '';
                for (let i = 7; i >= 0; i--) {
                    let bit = parseInt(inverted[i], 10);
                    let sum = bit + carry;
                    twosComp = (sum % 2) + twosComp;
                    carry = Math.floor(sum / 2);
                }
                return twosComp;
            }
            return num.toString(2).padStart(8, '0');
        }

        // -------------------------------------------------------------------------
        // LOGICA DI GENERAZIONE ESERCIZI AVANZATI
        // -------------------------------------------------------------------------

        // Divisione Binaria (Output atteso: "Quoziente; Resto" - es: 1011; 10)
        function generateBinaryDivision() {
            const minDividend = 10;
            const maxDividend = 40;
            const minDivisor = 2;
            const maxDivisor = 7;

            const decDividend = Math.floor(Math.random() * (maxDividend - minDividend)) + minDividend;
            const decDivisor = Math.floor(Math.random() * (maxDivisor - minDivisor)) + minDivisor;

            const binDividend = decDividend.toString(2);
            const binDivisor = decDivisor.toString(2);
            
            const decQuotient = Math.floor(decDividend / decDivisor);
            const decRemainder = decDividend % decDivisor;

            const binQuotient = decQuotient.toString(2);
            const binRemainder = decRemainder.toString(2);

            const solution = `${binQuotient}; ${binRemainder}`;

            const questionText = `Esegui la **DIVISIONE BINARIA** tra il dividendo **${binDividend}** e il divisore **${binDivisor}**. (Vale 2 Punti). Fornisci il risultato nel formato: Quoziente; Resto (es. 1011; 10). Teoricamente, in quali casi questa operazione pu√≤ dare problemi rispetto alla divisione decimale?`;
            
            return { type: 'division', text: questionText, base: 'BIN; BIN', correct: solution, points: 2 };
        }

        // Moltiplicazione Binaria (Output atteso: "Risultato" )
        function generateBinaryMultiplication() {
            const num1Dec = Math.floor(Math.random() * 20) + 10;
            const num2Dec = Math.floor(Math.random() * 8) + 2;
            const num1Bin = num1Dec.toString(2);
            const num2Bin = num2Dec.toString(2).padStart(num1Bin.length, '0');
            
            const resultDec = num1Dec * num2Dec;
            const solution = resultDec.toString(2);

            const questionText = `Esegui l'operazione binaria di **MOLTIPLICAZIONE** tra **${num1Bin}** e **${num2Bin}**. (Vale 2 Punti). Fornisci il risultato in Binario. Qual √® il passo fondamentale che distingue questa operazione dall'addizione?`;
            
            return { type: 'multiplication', text: questionText, base: 2, correct: solution, points: 2 };
        }
        
        // Conversione con Base da Indivisuare
        function generateBaseIdentificationConversion(startBase) {
            const bases = [2, 8, 10, 16];
            const baseFrom = startBase || bases[Math.floor(Math.random() * bases.length)];
            const baseTo = bases.filter(b => b !== baseFrom)[Math.floor(Math.random() * (bases.length - 1))];
            
            const numDec = Math.floor(Math.random() * 512) + 128;
            
            let numInput;
            if (baseFrom === 10) numInput = numDec.toString();
            else if (baseFrom === 2) numInput = numDec.toString(2);
            else if (baseFrom === 8) numInput = numDec.toString(8);
            else if (baseFrom === 16) numInput = numDec.toString(16).toUpperCase();

            let solution = numDec.toString(baseTo).toUpperCase();
            
            const labelTo = baseTo === 10 ? "DECIMALE" : baseTo === 2 ? "BINARIO" : baseTo === 8 ? "OTTALE" : "ESADECIMALE";
            
            const questionText = startBase 
                ? `CONVERTI il numero ${numInput} (Base ${baseFrom}) in ${labelTo} (Base ${baseTo}). Come gestisci la conversione se la base di partenza fosse diversa da ${baseFrom}?`
                : `INDIVIDUA la base di partenza (2, 8, 10 o 16) del numero **${numInput}**. Successivamente, CONVERTI il numero in ${labelTo} (Base ${baseTo}). Fornisci il risultato nel formato: BasePartenza; Risultato (es. 10; 12C). Attenzione: se la base di partenza √® errata, l'intero esercizio √® errato.`;

            // La correzione sar√†: BasePartenza; Risultato
            const correctSolution = startBase ? solution : `${baseFrom}; ${solution}`;
            
            return { type: 'base_id_conversion', text: questionText, base: startBase ? baseTo : 'ID; RES', correct: correctSolution, points: 1, requiresId: !startBase, correctBase: baseFrom };
        }

        // -------------------------------------------------------------------------
        // LOGICA DI GENERAZIONE VERIFICA
        // -------------------------------------------------------------------------
        
        function generateExam(type) {
            const questions = [];
            let conversionsDone = 0;
            let baseIdCount = 0;

            const addConversion = (isBaseId = false, startBase = null) => {
                if (isBaseId && baseIdCount < 2) {
                    questions.push(generateBaseIdentificationConversion(startBase));
                    baseIdCount++;
                    conversionsDone++;
                } else if (!isBaseId) {
                     questions.push(generateBaseIdentificationConversion(startBase));
                     conversionsDone++;
                }
            };

            // Q1-Q5: 5 Punti (Conversioni, max 2 con Base ID)
            addConversion(true); // Base ID 1
            addConversion(true); // Base ID 2
            addConversion(false, 16); // Hex to Oct
            addConversion(false, 2);  // Bin to Dec
            addConversion(false, 10); // Dec to Bin
            
            // Q6: Moltiplicazione Binaria (2 Punti)
            questions.push(generateBinaryMultiplication());
            
            // Q7: Divisione Binaria (2 Punti)
            questions.push(generateBinaryDivision());

            // Q8: Complemento a Due / Frazione (1 Punto)
            if (type === 'A') {
                const fracNum = generateBinaryFractional(5, 5);
                const solution = fracNum.decimal.toFixed(2);
                const questionText = `Dato il binario con virgola **${fracNum.binary}**, calcola il suo equivalente in Base DECIMALE (2 cifre decimali, separatore punto). Qual √® il limite di precisione in questo tipo di rappresentazione?`;
                questions.push({ type: 'fraction', text: questionText, base: 10, correct: solution, points: 1 });
            } else {
                const numDec = Math.floor(Math.random() * 127) + 1;
                const sign = Math.random() > 0.5 ? 1 : -1;
                const numSigned = numDec * sign;
                const solution = toTwosComplement(numSigned);
                const questionText = `Rappresenta il decimale **${numSigned}** in **Complemento a Due** (8 bit). Come riconosci che il numero √® negativo basandoti solo sulla sua rappresentazione binaria?`;
                questions.push({ type: 'twos_complement', text: questionText, base: 'BIN', correct: solution, points: 1 });
            }

            // Q9: Floating Point / IP Avanzato (1 Punto)
            if (type === 'B' || type === 'D') {
                const oct1 = 192 + Math.floor(Math.random() * 10);
                const oct2 = Math.floor(Math.random() * 256);
                const oct3 = Math.floor(Math.random() * 256);
                const oct4 = Math.floor(Math.random() * 256);
                const mask = 24 + Math.floor(Math.random() * 5); 
                const ip = `${oct1}.${oct2}.${oct3}.${oct4}`;
                const ipBin = ipToBinary(ip);

                const netIDBinary = ipBin.substring(0, mask).padEnd(32, '0');
                let networkID = [];
                for (let n = 0; n < 4; n++) {
                    networkID.push(parseInt(netIDBinary.substring(n * 8, n * 8 + 8), 2));
                }
                const solution = `${networkID.join('.')}/${mask}`;
                const questionText = `Dato l'indirizzo IP: **${ip}/${mask}**, determina l'indirizzo di **Rete (Network ID)** in decimale con la maschera. Spiega in breve l'utilit√† di calcolare questo indirizzo.`;
                questions.push({ type: 'ip_net', text: questionText, base: 'IP', correct: solution, points: 1 });
            } else {
                 // Floating Point
                const numDec = (Math.random() * 30) + 1.0; 
                const binaryRepresentation = numDec.toString(2);
                
                let exponent;
                if (binaryRepresentation.includes('.')) {
                    const index = binaryRepresentation.indexOf('.');
                    exponent = index - 1;
                } else {
                    exponent = binaryRepresentation.length - 1;
                }
                const mantissa = binaryRepresentation.replace('.', '').substring(1, 15);
                const solution = `${exponent}; ${mantissa}`; 

                const questionText = `Dato il decimale **${numDec.toFixed(3)}**, indicalo in Notazione Scientifica Binaria (1.M * 2^E) e fornisci **Esponente (E) e i primi 14 bit della Mantissa (M)**, separati da un punto e virgola (E; M). Se volessi rappresentare un numero molto grande, quale parte dovrei aumentare?`;
                questions.push({ type: 'float', text: questionText, base: 'E; M', correct: solution, points: 1 });
            }

            // Q10: ASCII / Domanda complessa finale (1 Punto)
            if (type === 'C' || type === 'D') {
                const charCode = Math.floor(Math.random() * (90 - 65)) + 65; // Lettere maiuscole A-Z
                const char = String.fromCharCode(charCode);
                const solution = charCode.toString(16).toUpperCase().padStart(2, '0');
                const questionText = `Qual √® il valore **Esadecimale** (2 cifre) della rappresentazione ASCII del carattere **'${char}'**? In un sistema a 8 bit, quanti caratteri diversi si possono rappresentare?`;
                questions.push({ type: 'ascii', text: questionText, base: 16, correct: solution, points: 1 });
            } else {
                // Fallback: Conversione complessa (frazionaria)
                const fracNum = generateBinaryFractional(8, 8);
                const solution = fracNum.binary;
                const questionText = `CONVERTI il decimale **${fracNum.decimal.toFixed(2)}** in **Binario con la virgola** (8 bit parte intera, 8 bit parte frazionaria). Descrivi il procedimento per la parte frazionaria.`;
                questions.push({ type: 'fraction_to_bin', text: questionText, base: 2, correct: solution, points: 1 });
            }


            // Assicurati che siano esattamente 10 domande
            const finalQuestions = questions.slice(0, MAX_EXERCISES);

            // Calcola il punteggio totale effettivo per debug (dovrebbe essere 11)
            const totalPointsCheck = finalQuestions.reduce((sum, q) => sum + (q.points || 1), 0);
            
            // Creazione PDF HTML Docente/Studente per salvataggio locale
            const studentData = getStudentData();
            const studentPDFContent = createPDFContent(type, studentData, finalQuestions, true, totalPointsCheck);
            const teacherPDFContent = createPDFContent(type, studentData, finalQuestions, false, totalPointsCheck);

            return {
                questions: finalQuestions.map(q => ({...q, userAnswer: ''})), // Solo 10 che contano
                type: type,
                timestamp: Date.now(),
                id: generateUniqueID(),
                studentData: studentData,
                totalPoints: totalPointsCheck,
                studentPDF: studentPDFContent, // Salva PDF Alunno
                teacherPDF: teacherPDFContent // Salva PDF Docente
            };
        }

        // -------------------------------------------------------------------------
        // GESTIONE CORREZIONE E FEEDBACK
        // -------------------------------------------------------------------------

        // Verifica la risposta e aggiorna lo stato senza dare feedback allo studente
        function checkAnswer(qNum) {
            const inputElement = document.getElementById(`answer-${qNum}`);
            if (!inputElement) return;

            const baseIdInput = document.getElementById(`base-id-${qNum}`);
            
            const questionData = currentExamData.questions[qNum - 1];
            
            // Salva la risposta dello studente in tempo reale nell'oggetto dati
            questionData.userAnswer = inputElement.value.trim();
            if (baseIdInput) {
                questionData.userBaseId = baseIdInput.value.trim();
            }

            // Aggiorna lo stato dei dati nell'URL
            const encodedExam = btoa(JSON.stringify(currentExamData));
            window.location.hash = `examData=${encodedExam}`;
            
            // Se siamo in modalit√† docente, ricalcola il voto
            if (isTeacherMode) {
                updateFinalGrade();
                // Fornisci feedback visivo immediato solo in modalit√† docente
                renderCorrectionFeedback(qNum); 
            }
        }
        
        // Rende il feedback visivo per il docente
        function renderCorrectionFeedback(qNum) {
            const inputElement = document.getElementById(`answer-${qNum}`);
            const feedbackElement = document.getElementById(`feedback-${qNum}`);
            const questionData = currentExamData.questions[qNum - 1];
            
            if (!feedbackElement) return;

            const isCorrect = isAnswerCorrect(questionData);
            const points = isCorrect ? (questionData.points || 1) : 0;
            const statusClass = isCorrect ? 'feedback-correct text-green-800' : 'feedback-wrong text-red-800';
            
            feedbackElement.className = `mt-2 sm:mt-0 p-2 rounded-lg text-sm font-bold w-full sm:w-64 transition-all duration-200 ${statusClass}`;
            feedbackElement.innerHTML = isCorrect 
                ? `‚úÖ CORRETTA! (${points} Pts)` 
                : `‚ùå ERRATA. (0 Pts)`;

            const commentElement = document.getElementById(`comment-${qNum}`);
            const commentText = isCorrect 
                ? `Ottimo. Risposta: ${questionData.correct}` 
                : `Soluzione: ${questionData.correct}. ${generateComment(questionData.type, questionData.base)}`;
                
            commentElement.innerHTML = `<span class="font-bold text-gray-700">SOLUZIONE:</span> ${commentText}`;
        }

        // Logica centrale per la correzione
        function isAnswerCorrect(questionData) {
            const userAnswer = questionData.userAnswer.toUpperCase().trim();
            const correctAnswer = questionData.correct.toUpperCase().trim();
            
            // Funzione per pulire la risposta (rimuove spazi, accetta punto e virgola come separatori)
            const clean = (s) => s.replace(/[^A-Z0-9\.\/;\-\+\s]/g, '').replace(/\s+/g, '');
            
            const cleanedUser = clean(userAnswer);
            const cleanedCorrect = clean(correctAnswer);

            if (cleanedUser === '') return false;

            // 1. Logica per Base Identification
            if (questionData.type === 'base_id_conversion' && questionData.requiresId) {
                const userBase = questionData.userBaseId ? questionData.userBaseId.trim() : '';
                const correctBase = questionData.correctBase.toString();
                
                // Controllo se la base √® corretta (se la base √® sbagliata, l'intero esercizio √® 0 punti)
                if (userBase !== correctBase) {
                    return false;
                }
                // Se la base √® corretta, controlla la conversione (Base ID; Risultato)
                return cleanedUser === cleanedCorrect;
            }
            
            // 2. Logica per tutte le altre conversioni e operazioni (Divisione, Moltiplicazione, ecc.)
            return cleanedUser === cleanedCorrect;
        }

        // Genera il commento didattico in base all'errore
        function generateComment(qType, base) {
             if (qType === 'division') return "Verifica il procedimento: la divisione binaria segue la sottrazione ripetuta. Controlla quoziente e resto.";
             if (qType === 'multiplication') return "Controlla i riporti e gli shift per il prodotto finale. Moltiplicare per 0 √® 0, per 1 √® il moltiplicando.";
             if (qType === 'twos_complement') return "Hai sbagliato il Complemento a Due. Verifica l'inversione dei bit e la somma di 1, assicurandoti che l'ottavo bit sia il bit di segno.";
             if (qType === 'ip_net') return "L'errore √® nel Network ID. Esegui l'AND logico tra IP e Maschera binaria per isolare la parte di rete (Host a 0).";
             if (qType === 'float') return "Controlla lo spostamento della virgola per la normalizzazione (1.M * 2^E). Ricorda che l'Esponente √® il numero di spostamenti.";
             if (qType === 'ascii') return "Verifica la tabella ASCII. Controlla la conversione dal decimale (ASCII Code) all'Esadecimale.";
             return "Rivedi la metodologia di conversione tra le basi. Un piccolo errore pu√≤ propagarsi.";
        }


        // Raccolta risultati e calcolo voto finale
        function gatherFinalResults() {
            let correctCount = 0;
            const resultsArray = [];

            currentExamData.questions.forEach((q, index) => {
                const isCorrect = isAnswerCorrect(q);
                correctCount += isCorrect ? (q.points || 1) : 0;
                
                let commentText;
                if (q.userAnswer.trim() === '') {
                    commentText = 'Risposta non fornita. Esercizio non valutato.';
                } else if (isCorrect) {
                    commentText = `Risposta esatta. Punti: ${q.points || 1}.`;
                } else {
                    commentText = `Risposta errata. Soluzione corretta: **${q.correct}**. ${generateComment(q.type, q.base)}`;
                }

                resultsArray.push({
                    qNum: index + 1,
                    isCorrect: isCorrect,
                    points: q.points || 1,
                    userAnswer: q.userAnswer || 'N.D.',
                    comment: commentText
                });
            });

            // Voto orale impostato dal docente
            const votoOrale = parseFloat(document.getElementById('voto-orale').value) || 0;
            
            // Calcolo Voto Scritto in base 10
            const gradeVerification = (correctCount / currentExamData.totalPoints) * 10;
            
            // Calcolo Voto Finale 50/50
            const finalGradeUnrounded = (gradeVerification * 0.5) + (votoOrale * 0.5);
            const finalGradeFloored = Math.floor(finalGradeUnrounded);

            return {
                gradeFloored: finalGradeFloored.toFixed(0),
                gradeUnrounded: finalGradeUnrounded.toFixed(2),
                points: correctCount,
                maxPoints: currentExamData.totalPoints,
                writtenGrade: gradeVerification.toFixed(2),
                votoOrale: votoOrale.toFixed(1),
                writtenFormula: `Voto Scritto Base 10 = (${correctCount} / ${currentExamData.totalPoints}) * 10 = ${gradeVerification.toFixed(2)}`,
                results: resultsArray,
                studentName: currentExamData.studentData.nome + ' ' + currentExamData.studentData.cognome,
                examType: currentExamData.type,
                examDate: currentExamData.studentData.data
            };
        }

        function updateFinalGrade() {
            const results = gatherFinalResults();

            document.getElementById('corr-points').textContent = results.points;
            
            // Questi si aggiornano solo in modalit√† docente
            if(isTeacherMode) {
                document.getElementById('corr-grade-floored').textContent = results.gradeFloored;
                document.querySelector('#conversion-explanation code').innerHTML = `
                    Voto Scritto Base 10 = (${results.points} / ${currentExamData.totalPoints}) * 10 = ${results.writtenGrade}
                    <br>
                    Voto Finale = (${results.writtenGrade} * 0.5) + (${results.votoOrale} * 0.5) = ${results.gradeUnrounded}
                `;
            }
        }
        
        function getStudentData() {
            const nome = document.getElementById('nome-studente').value.trim();
            const cognome = document.getElementById('cognome-studente').value.trim();
            const classe = document.getElementById('classe-studente').value.trim();
            const data = document.getElementById('data-verifica').value;
            return { nome, cognome, classe, data };
        }

        // -------------------------------------------------------------------------
        // GESTIONE VISTE E DOWNLOAD PDF
        // -------------------------------------------------------------------------

        function initApp() {
            const hash = window.location.hash;
            if (hash.startsWith('#examData=')) {
                try {
                    const encodedData = hash.substring(10);
                    const examJson = atob(encodedData);
                    const exam = JSON.parse(examJson);
                    
                    currentExamData = exam;
                    // L'alunno non ha la password, quindi inizia in modalit√† studente
                    isTeacherMode = false; 
                    showCorrectionView();
                } catch (e) {
                    console.error("Errore nel caricamento dei dati dall'URL. Ritorno alla vista principale.", e);
                    showMainView();
                }
            } else {
                updateLinkContainers();
                showMainView();
            }

            // Imposta la data di default
            const dateInput = document.getElementById('data-verifica');
            if (dateInput.value === "") {
                dateInput.value = new Date().toISOString().substring(0, 10);
            }
        }

        function showCorrectionView() {
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('correction-view').classList.remove('hidden');
            
            document.getElementById('corr-title').textContent = currentExamData.type;
            document.getElementById('corr-student-name').textContent = `${currentExamData.studentData.nome} ${currentExamData.studentData.cognome}`;

            populateCorrectionForm(currentExamData.questions);
            updateCorrectionViewMode();
            updateFinalGrade();
        }

        function updateCorrectionViewMode() {
             const teacherElements = document.getElementById('teacher-inputs');
             const formElements = document.getElementById('correction-form');

             if (isTeacherMode) {
                // Modalit√† Docente: Mostra tutti gli input di voto e feedback
                teacherElements.classList.remove('hidden');
                document.getElementById('voto-orale').disabled = false;
                
                // Fornisci il feedback per ogni domanda
                currentExamData.questions.forEach((q, index) => renderCorrectionFeedback(index + 1));
             } else {
                // Modalit√† Studente: Nasconde gli input di voto e feedback docente
                teacherElements.classList.add('hidden');
                document.getElementById('voto-orale').disabled = true;
                
                // Nasconde tutti i feedback
                formElements.querySelectorAll('[id^="feedback-"]').forEach(el => {
                    el.className = 'mt-2 sm:mt-0 p-2 rounded-lg text-sm font-bold w-full sm:w-64 border border-gray-300 bg-gray-100 transition-all duration-200';
                    el.innerHTML = 'Risposta registrata.';
                });
                formElements.querySelectorAll('[id^="comment-"]').forEach(el => el.classList.add('hidden'));
             }
        }

        function showMainView() {
            window.location.hash = ''; 
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('correction-view').classList.add('hidden');
            currentExamData = null;
        }

        // Popola la griglia di correzione
        function populateCorrectionForm(questions) {
            const formContainer = document.getElementById('correction-form');
            formContainer.innerHTML = '';
            
            questions.forEach((q, index) => {
                const qNum = index + 1;
                
                const questionBlock = document.createElement('div');
                questionBlock.className = 'bg-white p-4 rounded-xl shadow-lg border border-gray-200';
                
                // Aggiunge la domanda teorica nel testo
                const questionText = q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                const pointsText = `(Valore: ${q.points || 1} Punti)`;
                
                let baseIdInputHTML = '';
                if (q.requiresId) {
                    baseIdInputHTML = `
                        <input type="text" id="base-id-${qNum}" 
                            class="p-3 border-2 border-orange-300 rounded-lg code-font text-lg focus:ring-orange-500 focus:border-orange-500 w-32" 
                            placeholder="Base?"
                            value="${q.userBaseId || ''}"
                            oninput="checkAnswer(${qNum})">
                    `;
                }

                questionBlock.innerHTML = `
                    <p class="font-bold text-lg text-gray-800 mb-3">${qNum}. ${pointsText} ${questionText}</p>
                    
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        ${baseIdInputHTML}
                        <input type="text" id="answer-${qNum}" 
                               class="answer-input p-3 border-2 border-gray-300 rounded-lg flex-1 code-font text-lg focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="Risposta (Formato: ${q.base})..."
                               value="${q.userAnswer || ''}"
                               oninput="checkAnswer(${qNum})">
                        
                        <div id="feedback-${qNum}" class="mt-2 sm:mt-0 p-2 rounded-lg text-sm font-bold w-full sm:w-64 border transition-all duration-200">
                             In attesa...
                        </div>
                    </div>
                    <div id="comment-${qNum}" class="text-xs text-gray-600 mt-2 p-2 bg-gray-50 rounded-lg hidden">
                        <!-- Commento e soluzione del docente (visibile solo in TeacherMode) -->
                    </div>
                `;
                formContainer.appendChild(questionBlock);
            });
            
            // Inizializza le risposte precaricate
            questions.forEach((q, index) => {
                // Non chiamo checkAnswer direttamente qui perch√© aggiorniamo lo stato interno e la UI dopo l'inizializzazione del modo docente/studente.
            });
        }
        
        function promptPasswordAndDownload() {
            if (!currentExamData) return;
            
            const password = prompt("Inserisci la password per sbloccare la griglia di correzione e il PDF finale (Riservato Docente):");
            
            if (password === TEACHER_PASSWORD) {
                // Abilita la modalit√† docente per mostrare i feedback e il voto
                isTeacherMode = true;
                updateCorrectionViewMode();
                updateFinalGrade(); 
                
                // Genera e scarica il PDF dei risultati
                downloadResultsPDF();
            } else if (password !== null) {
                // Se la password √® sbagliata (e non ha annullato)
                // Usiamo un alert semplice per questa interazione (non √® un alert di errore di sistema)
                alert("Password errata. Non √® possibile scaricare il report finale senza le credenziali del docente.");
            }
        }

        // Genera il PDF dei risultati con commenti (Download Automatico)
        function downloadResultsPDF() {
            if (!currentExamData) return;

            // Raccogli i risultati attuali dal modulo
            const finalResults = gatherFinalResults();
            const studentName = currentExamData.studentData.nome + ' ' + currentExamData.studentData.cognome;
            
            // Genera il contenuto HTML per i risultati (Docente mode)
            const resultsHTML = createResultsPDFContent(finalResults, currentExamData.questions);
            
            const fileName = `Risultati_Verifica_${currentExamData.type}_${studentName.replace(/\s/g, '_')}_CORRETTA.html`;
            
            // Scarica il file HTML/Blob
            downloadFile(resultsHTML, fileName, 'text/html');

             alert(`Download del file "${fileName}" completato. Aprirlo e salvarlo come PDF (Stampa -> Salva come PDF) per la conservazione!`);
        }

        // Contenuto HTML per il PDF dei risultati
        function createResultsPDFContent(results, questions) {
            const { gradeFloored, points, maxPoints, writtenGrade, writtenFormula, studentName, examType, examDate, votoOrale, gradeUnrounded } = results;

            const exercisesHTML = results.results.map((result, index) => {
                const q = questions[index];
                const qNum = index + 1;
                
                const statusClass = result.isCorrect ? 'bg-green-100 border-green-600' : 'bg-red-100 border-red-600';
                const statusIcon = result.isCorrect ? 'CORRETTA' : 'ERRATA';
                
                return `
                    <div class="p-3 border-2 rounded-lg ${statusClass} mb-4 break-inside-avoid-page shadow-sm">
                        <p class="text-sm font-bold text-gray-800 mb-1">Esercizio ${qNum} (${q.points} Punti): ${q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                        <hr class="border-gray-300 my-1">
                        <p class="text-xs mb-1">Risposta Fornita: <span class="code-font font-medium bg-white p-1 rounded">${result.userAnswer}</span></p>
                        <p class="text-xs mb-1 text-green-700">Risposta Attesa: <span class="code-font font-medium">${q.correct}</span></p>
                        <p class="text-sm font-extrabold ${result.isCorrect ? 'text-green-700' : 'text-red-700'} mt-2">Valutazione: ${statusIcon} (Punti Ottenuti: ${result.isCorrect ? q.points : 0})</p>
                        <p class="text-xs font-semibold text-gray-600 mt-2 pt-1 border-t border-gray-400">Commento Docente: ${result.comment}</p>
                    </div>
                `;
            }).join('');
            
            // Contenuto HTML completo per il download
            return `
                <html>
                <head>
                    <title>Scheda di Valutazione - Verifica ${examType} - ${studentName}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Inter:wght@400;700;900&display=swap');
                        body { font-family: 'Inter', sans-serif; font-size: 10pt; margin: 0; padding: 0; background: #fff; }
                        .container { max-width: 21cm; margin: 0 auto; padding: 1.5cm 1cm; }
                        h1 { font-size: 22pt; color: #1e40af; border-bottom: 4px solid #1e40af; padding-bottom: 5px; margin-bottom: 10px;}
                        h2 { font-size: 14pt; margin-top: 20px; color: #4b5563; border-bottom: 1px solid #ccc; padding-bottom: 3px; }
                        p { margin-bottom: 5px; line-height: 1.4;}
                        .grid-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }
                        .box { padding: 12px; border-radius: 8px; font-weight: bold; border: 1px solid #ddd; }
                        .blue { background-color: #e0f2fe; color: #075985; border-color: #38bdf8; }
                        .red { background-color: #fee2e2; color: #991b1b; border-color: #f87171; }
                        .purple { background-color: #ede9fe; color: #5b21b6; border-color: #a78bfa; }
                        .code-font { font-family: 'Roboto Mono', monospace; }
                        .summary { margin-top: 20px; padding: 15px; background: #f3f4f6; border-left: 5px solid #6366f1; border-radius: 8px; }
                        .exercises { column-count: 2; column-gap: 20px; margin-top: 20px; }
                        .break-inside-avoid-page { break-inside: avoid; }
                        .border-red-600 { border-color: #dc2626; }
                        .border-green-600 { border-color: #059669; }

                        @media print {
                            .container { padding: 0.5cm; }
                            @page { margin: 1cm; }
                            .grid-summary { display: block; }
                            .box { margin-bottom: 10px; }
                            .exercises { column-count: 1; column-gap: 0; } /* 1 colonna per i risultati */
                            .exercises > div { margin-bottom: 10px !important; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>Scheda di Valutazione Finale - Verifica ${examType}</h1>
                        <p><strong>Studente:</strong> <span style="color:#1e40af">${studentName}</span> | <strong>Classe:</strong> ${currentExamData.studentData.classe}</p>
                        <p><strong>Data Verifica:</strong> ${examDate}</p>

                        <h2>Riepilogo Punteggio e Voto Finale</h2>
                        <div class="grid-summary">
                            <div class="box blue">Punti Scritto Ottenuti: ${points} / ${maxPoints}</div>
                            <div class="box purple">Voto Orale (Docente): ${votoOrale} / 10</div>
                            <div class="box red">Voto Finale Arrotondato: ${gradeFloored} / 10</div>
                        </div>

                        <div class="summary">
                            <p><strong>Voto Scritto (base 10):</strong> ${writtenGrade}</p>
                            <p><strong>Voto Finale Non Arrotondato:</strong> ${gradeUnrounded}</p>
                            <p><strong>Formula:</strong> (Scritto x 50%) + (Orale x 50%).</p>
                        </div>
                        
                        <h2>Dettaglio Esercizi e Feedback del Docente</h2>
                        <div class="exercises">
                            ${exercisesHTML}
                        </div>
                    </div>
                </body>
                </html>
            `;
        }
        
        // Funzione per il download automatico del file
        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleGeneration(type, isStudent) {
            const data = getStudentData();

            if (!data.nome || !data.cognome) {
                // Usiamo un alert semplice per questa interazione (non √® un alert di errore di sistema)
                alert('Attenzione: Inserisci NOME e COGNOME dello studente per generare il PDF e il link condivisibile.');
                return;
            }

            const exam = generateExam(type);
            exam.studentData = data;
            
            let exams = loadExams();
            exams[type].unshift(exam); 
            saveExams(exams);

            // Se √® studente, scarica il PDF stampabile (non correzione)
            if (isStudent) {
                downloadPrintablePDF(exam, true);
            } else {
                downloadPrintablePDF(exam, false);
            }
        }

        // Funzione per il download del PDF Alunno/Docente dal Local Storage
        function downloadPDFFromStorage(type, id, isStudent) {
             let exams = loadExams();
             const exam = exams[type].find(e => e.id === id);
             if (!exam) {
                 // Usiamo un alert semplice per questa interazione (non √® un alert di errore di sistema)
                 alert("File non trovato nel salvataggio locale.");
                 return;
             }
             
             const htmlContent = isStudent ? exam.studentPDF : exam.teacherPDF;
             const studentName = `${exam.studentData.nome}_${exam.studentData.cognome}`;
             const fileName = `Verifica_${type}_${studentName}_${isStudent ? 'ALUNNO' : 'DOCENTE'}.html`;

             downloadFile(htmlContent, fileName, 'text/html');
             // Usiamo un alert semplice per questa interazione (non √® un alert di errore di sistema)
             alert(`Download del file "${fileName}" completato. Aprirlo e salvarlo come PDF per la conservazione!`);
        }

        // Genera il PDF e lo manda in stampa (usato solo per la generazione iniziale)
        function downloadPrintablePDF(examData, isStudent) {
            const pdfHTML = isStudent ? examData.studentPDF : examData.teacherPDF;
            
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = pdfHTML;
            
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
        }

        // Funzione ottimizzata per il layout di stampa (A4)
        function createPDFContent(type, data, questions, isStudent, totalPoints) {
            const examTitle = type === 'A' ? 'Base & Operazioni Binarie' :
                              type === 'B' ? 'Networking e Sistemi Numerici' : 
                              type === 'C' ? 'Complemento a Due, Floating Point e IP' : 'Verifica Complessa (FULL ADVANCED)';
            
            const solutionListHTML = questions.map((q, index) => {
                const qNum = index + 1;
                // Sostituisce i grassetti Markdown con sottolineature per la stampa
                const qText = q.text.replace(/\*\*(.*?)\*\*/g, '<u>$1</u>');
                const pointsText = `(${q.points || 1} Pts)`;

                const answerArea = isStudent 
                    ? `<span class="border-b border-dashed border-gray-500 w-full inline-block h-6 mt-1"></span>`
                    : `<p class="mt-0.5 text-xs font-bold text-green-700">SOLUZIONE: ${q.correct}</p>`;
                
                let baseIdHtml = '';
                if (q.requiresId) {
                     baseIdHtml = isStudent 
                        ? `<span class="inline-block w-20 border-b border-dashed border-gray-500 h-6"></span> Base: `
                        : `<p class="mt-0.5 text-xs font-bold text-orange-700">Base Corretta: ${q.correctBase}</p>`;
                }
                
                return `
                    <li class="font-normal text-sm">
                        <span class="font-bold text-gray-800">${qNum}. ${pointsText}</span> ${qText}
                        <div class="mt-1 pb-0 flex items-center space-x-2">
                            ${baseIdHtml}
                            <span class="font-bold">${isStudent ? 'Risposta:' : ''}</span> ${answerArea}
                        </div>
                    </li>
                `;
            }).join('');
            
            // Tabella di conversione da includere (solo per lo studente)
            const conversionTableHTML = isStudent ? `
                <div class="mt-6 print-table break-before-page">
                    <h3 class="text-sm font-bold text-gray-700 mb-2 border-b border-gray-400">Tabella di Riferimento Rapida (ASCII/Esadecimale)</h3>
                    <table style="width:100%; border-collapse: collapse; font-family: 'Roboto Mono', monospace;" class="text-xs">
                        <thead>
                            <tr style="background-color: #e5e7eb;">
                                <th style="border: 1px solid #ddd; padding: 4px;">Dec</th>
                                <th style="border: 1px solid #ddd; padding: 4px;">Bin (8bit)</th>
                                <th style="border: 1px solid #ddd; padding: 4px;">Hex</th>
                                <th style="border: 1px solid #ddd; padding: 4px;">ASCII</th>
                                <th style="border: 1px solid #ddd; padding: 4px;">Dec</th>
                                <th style="border: 1px solid #ddd; padding: 4px;">Bin (8bit)</th>
                                <th style="border: 1px solid #ddd; padding: 4px;">Hex</th>
                                <th style="border: 1px solid #ddd; padding: 4px;">ASCII</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${[...Array(4).keys()].map(row => `
                                <tr>
                                    ${[...Array(2).keys()].map(col => {
                                        const dec1 = 48 + row + col * 4;
                                        const dec2 = 65 + row + col * 4;
                                        const bin1 = dec1.toString(2).padStart(8, '0');
                                        const hex1 = dec1.toString(16).toUpperCase().padStart(2, '0');
                                        const char1 = dec1 < 65 ? String.fromCharCode(dec1) : String.fromCharCode(dec1);
                                        const bin2 = dec2.toString(2).padStart(8, '0');
                                        const hex2 = dec2.toString(16).toUpperCase().padStart(2, '0');
                                        const char2 = String.fromCharCode(dec2);

                                        return `
                                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">${dec1}</td>
                                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">${bin1}</td>
                                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">${hex1}</td>
                                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">${char1}</td>
                                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">${dec2}</td>
                                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">${bin2}</td>
                                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">${hex2}</td>
                                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center;">${char2}</td>
                                        `;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : '';


            return `
                <div class="print-container p-4 w-full mx-auto text-gray-900" style="max-width: 21cm;">
                    <header class="text-center mb-4 pb-2 border-b-4 ${isStudent ? 'border-blue-600' : 'border-green-600'} print-header">
                        <h1 class="text-xl font-extrabold text-blue-800">VERIFICA DI INFORMATICA - ${type} (${isStudent ? 'STUDENTE' : 'DOCENTE - SOLUZIONI'})</h1>
                        <p class="text-sm text-gray-600">Docente: Giuseppe Borzumati | Argomento: ${examTitle}</p>
                    </header>
                    <div class="mb-5 grid grid-cols-4 gap-x-4 text-xs font-semibold p-3 rounded-lg border-2 border-gray-400 bg-gray-100 shadow-inner">
                        <p>Nome: <span class="font-normal border-b border-gray-600 w-full inline-block">${data.nome} ${data.cognome}</span></p>
                        <p>Classe: <span class="font-normal border-b border-gray-600 w-full inline-block">${data.classe}</span></p>
                        <p>Data: <span class="font-normal border-b border-gray-600 w-full inline-block">${data.data}</span></p>
                        <p>Punti Max: <span class="font-normal border-b border-gray-600 w-full inline-block">${totalPoints}</span></p>
                    </div>

                    <h2 class="text-base font-bold mb-4 ${isStudent ? 'text-gray-700' : 'text-green-700'}">Tracce degli Esercizi (Totale: ${MAX_EXERCISES})</h2>
                    
                    <ol class="list-decimal pl-5 space-y-3 print-list">
                        ${solutionListHTML}
                    </ol>

                    ${conversionTableHTML}

                    <footer class="mt-8 pt-3 border-t-2 border-gray-400 text-center text-xs text-gray-500">
                        <p>${isStudent ? 'Rispondere in modo ordinato. La Moltiplicazione e la Divisione Binaria valgono 2 Punti, gli altri 1 Punto. Totale 11 Punti.' : 'Griglia Soluzioni Docente. Voto calcolato su 11 Punti (50% Scritto / 50% Orale).'}
                        </p>
                        <p>&copy; Prof. B.</p>
                    </footer>
                </div>
            `;
        }


        function updateLinkContainers() {
            const exams = loadExams();
            
            ['A', 'B', 'C', 'D'].forEach(type => {
                const container = document.getElementById(`link-container-${type}`);
                const typeColor = type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'yellow';
                
                container.innerHTML = `<h4 class="text-lg font-semibold text-${typeColor}-600 border-b border-${typeColor}-300 pb-1">Link Attivi per Correzione (Verifica ${type}):</h4>`;

                if (exams[type].length === 0) {
                    container.innerHTML += `<p class="text-sm text-gray-500 mt-2">Nessuna verifica ${type} generata.</p>`;
                    return;
                }

                exams[type].forEach((exam) => {
                    const studentName = `${exam.studentData.nome} ${exam.studentData.cognome}`;
                    
                    const encodedExam = btoa(JSON.stringify(exam));
                    const shareableLink = `${window.location.origin}${window.location.pathname}#examData=${encodedExam}`;
                    
                    const linkHTML = `
                        <div class="flex flex-wrap items-center space-x-2 p-2 bg-gray-50 border border-${typeColor}-200 rounded-lg">
                            <span class="text-sm font-extrabold text-${typeColor}-700 min-w-[150px]">${studentName}</span>
                            
                            <!-- Pulsante per aprire il link di correzione -->
                            <a href="${shareableLink}" target="_blank"
                               class="action-button bg-gradient-blue text-white text-xs py-1 px-3 rounded">
                                Apri Link Risposte
                            </a>
                            
                            <!-- Pulsante per copiare il link -->
                            <button onclick="copyToClipboard('${shareableLink}')" 
                                    class="action-button bg-gray-700 text-white text-xs py-1 px-3 rounded">
                                Copia Link
                            </button>
                            
                            <!-- Pulsante per scaricare PDF Studente -->
                            <button onclick="downloadPDFFromStorage('${type}', '${exam.id}', true)"
                                    class="action-button bg-gradient-red text-white text-xs py-1 px-3 rounded">
                                PDF Alunno
                            </button>
                            
                            <!-- Pulsante per scaricare PDF Docente -->
                            <button onclick="downloadPDFFromStorage('${type}', '${exam.id}', false)"
                                    class="action-button bg-gradient-green text-white text-xs py-1 px-3 rounded">
                                PDF Docente
                            </button>

                            <button onclick="removeExam('${type}', '${exam.id}')"
                                    class="text-xs bg-red-100 hover:bg-red-200 text-red-700 py-1 px-2 rounded ml-auto">
                                X
                            </button>
                        </div>
                    `;
                    container.innerHTML += linkHTML;
                });
            });
        }
        
        function removeExam(type, id) {
            let exams = loadExams();
            exams[type] = exams[type].filter(exam => exam.id !== id);
            saveExams(exams);
        }

        // Funzione di fallback per la copia (necessaria in ambienti sandbox)
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                // Usiamo un alert semplice per questa interazione (non √® un alert di errore di sistema)
                alert('Link copiato negli appunti! Pronto per la condivisione con l\'alunno.');
            } catch (err) {
                console.error('Impossibile copiare il testo', err);
            }
            document.body.removeChild(textarea);
        }

        // Inizializza l'app al caricamento
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
