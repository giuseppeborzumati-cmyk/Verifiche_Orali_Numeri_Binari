<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Verifiche Informatica - Borzumati</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        
        /* Configurazione base e font per il codice/numeri */
        body { font-family: 'Inter', sans-serif; }
        .code-font { font-family: 'Roboto Mono', monospace; }

        /* Stili specifici per la stampa PDF */
        @media print {
            body > *:not(.print-container) { display: none !important; }
            .print-container {
                display: block !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
            }
            .page-break { page-break-before: always; }
        }

        /* Stili per i pulsanti animati */
        .action-button {
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-weight: 700;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .bg-gradient-blue { background-image: linear-gradient(to right, #4c66ff 0%, #00c6ff 100%); }
        .bg-gradient-green { background-image: linear-gradient(to right, #10b981 0%, #1d7c4c 100%); }
        .bg-gradient-red { background-image: linear-gradient(to right, #ef4444 0%, #b91c1c 100%); }

        /* Stili per la vista Correzione */
        .feedback-correct { border: 2px solid #10b981; background-color: #d1fae5; }
        .feedback-wrong { border: 2px solid #ef4444; background-color: #fee2e2; }
        .feedback-neutral { border: 2px solid #f59e0b; background-color: #fffbeb; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <!-- Sezione Dati Studente/Docente e Introduzione -->
    <div id="main-view" class="w-full max-w-6xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10 mb-8 space-y-8">
        <header class="text-center pb-4 border-b-4 border-blue-600">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 leading-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                    Sistema di Generazione Verifiche
                </span>
            </h1>
            <p class="text-xl text-gray-700 mt-2">Riservato al Prof. Giuseppe Borzumati, Docente di Informatica</p>
            <p class="text-sm text-gray-500 mt-1">Argomento: I Sistemi di Numerazione Binaria e Indirizzamento IP</p>
        </header>

        <!-- Dati Studente per la Stampa PDF (Globali) -->
        <div class="bg-indigo-50 p-6 rounded-xl shadow-inner border border-indigo-200">
            <h2 class="text-2xl font-bold text-indigo-800 mb-4 flex items-center">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                 </svg>
                Dati dello Studente
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <input type="text" id="nome-studente" placeholder="Nome" class="p-3 border border-indigo-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="text-xs text-indigo-500 mt-1">Inserisci il nome dello studente.</p>
                </div>
                <div>
                    <input type="text" id="cognome-studente" placeholder="Cognome" class="p-3 border border-indigo-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="text-xs text-indigo-500 mt-1">Inserisci il cognome dello studente.</p>
                </div>
                <div>
                    <input type="text" id="classe-studente" placeholder="Classe (es. 4B)" class="p-3 border border-indigo-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="text-xs text-indigo-500 mt-1">Es. 3A, 4B, ecc.</p>
                </div>
                <div>
                    <input type="date" id="data-verifica" value="" class="p-3 border border-indigo-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="text-xs text-indigo-500 mt-1">Data di svolgimento della prova.</p>
                </div>
            </div>
        </div>

        <!-- Contenitore delle Verifiche (3 Blocchi) -->
        <div class="space-y-12">
            
            <!-- BLOCCO 1: Verifiche Numeriche PURE -->
            <div id="blocco-verifica-a" class="p-6 bg-gray-50 border-t-8 border-t-red-500 rounded-xl shadow-2xl">
                <h3 class="text-3xl font-bold text-red-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¢</span> VERIFICA A: Sistemi di Numerazione & Conversione Incrociata
                </h3>
                <p class="text-gray-600 mb-6">Totale 20 Esercizi. Include conversioni **Binario, Decimale, Ottale, Esadecimale, Frazioni Binarie e Numeri Romani**.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-3 px-6 rounded-lg text-lg" 
                            onclick="handleGeneration('A', true)">
                        Genera e Scarica PDF Alunno
                    </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-3 px-6 rounded-lg text-lg" 
                            onclick="handleGeneration('A', false)">
                        Genera e Scarica PDF Docente (Soluzioni)
                    </button>
                </div>
                <div id="link-a" class="mt-4 text-center"></div>
            </div>

            <!-- BLOCCO 2: Indirizzamento IP + Conversione -->
            <div id="blocco-verifica-b" class="p-6 bg-gray-50 border-t-8 border-t-purple-500 rounded-xl shadow-2xl">
                <h3 class="text-3xl font-bold text-purple-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üåê</span> VERIFICA B: Indirizzi IP e Sistemi di Numerazione
                </h3>
                <p class="text-gray-600 mb-6">Totale 20 Esercizi. Include esercizi di **subnetting (Network ID, Broadcast, Range Host)** e conversioni numeriche miste.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-3 px-6 rounded-lg text-lg" 
                            onclick="handleGeneration('B', true)">
                        Genera e Scarica PDF Alunno
                    </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-3 px-6 rounded-lg text-lg" 
                            onclick="handleGeneration('B', false)">
                        Genera e Scarica PDF Docente (Soluzioni)
                    </button>
                </div>
                <div id="link-b" class="mt-4 text-center"></div>
            </div>

            <!-- BLOCCO 3: Mantissa/Esponente, IP e Conversioni -->
            <div id="blocco-verifica-c" class="p-6 bg-gray-50 border-t-8 border-t-teal-500 rounded-xl shadow-2xl">
                <h3 class="text-3xl font-bold text-teal-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¨</span> VERIFICA C: Floating Point, IP e Operazioni Binarie
                </h3>
                <p class="text-gray-600 mb-6">Totale 20 Esercizi. Esercizi avanzati con **notazione esponenziale binaria (Mantissa)**, Subnetting, **Operazioni (add/sott/moltipl.)** e conversioni miste.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-3 px-6 rounded-lg text-lg" 
                            onclick="handleGeneration('C', true)">
                        Genera e Scarica PDF Alunno
                    </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-3 px-6 rounded-lg text-lg" 
                            onclick="handleGeneration('C', false)">
                        Genera e Scarica PDF Docente (Soluzioni)
                    </button>
                </div>
                <div id="link-c" class="mt-4 text-center"></div>
            </div>

        </div>

        <footer class="text-center pt-8 text-gray-500 text-sm">
            <p>&copy; Tutti i diritti riservati. Materiale didattico per l'Insegnante Giuseppe Borzumati.</p>
        </footer>
    </div>

    <!-- VISTA DI CORREZIONE (Simulazione Pagina Separata) -->
    <div id="correction-view" class="hidden w-full max-w-5xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10 mb-8 space-y-8">
        <header class="text-center pb-4 border-b-4 border-green-500">
            <h1 class="text-4xl font-extrabold text-green-700 leading-tight">Pagina di Correzione in Tempo Reale</h1>
            <p class="text-lg text-gray-600 mt-1">Inserisci le risposte della verifica <span id="corr-title" class="font-extrabold text-indigo-600"></span></p>
        </header>
        
        <!-- Punteggio e Calcolo Voto -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 bg-yellow-50 p-6 rounded-xl border-2 border-yellow-300 shadow-lg">
            
            <div class="col-span-1 lg:col-span-3">
                <h2 class="text-2xl font-bold text-yellow-800 mb-2 border-b border-yellow-400 pb-1">Riepilogo e Calcolo Voto</h2>
            </div>
            
            <!-- Punteggio -->
            <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-blue-800">Punti Ottenuti (Max 17):</p>
                <p class="text-4xl font-extrabold text-blue-600 mt-1"><span id="corr-points">0</span> / 17</p>
                <p class="text-xs text-gray-600 mt-2">Ogni esercizio vale 1 punto.</p>
            </div>
            
            <!-- Voto Orale & Ponderazione -->
            <div class="bg-purple-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-purple-800">Voto Orale (Base 10):</p>
                <input type="number" id="voto-orale" min="0" max="10" step="0.1" value="6.0" onchange="updateFinalGrade()" 
                       class="p-2 border-2 border-purple-500 rounded-lg w-full mt-1 text-xl font-bold">
                <p class="text-xs text-gray-600 mt-2">Il voto finale √® una media ponderata (70% Scritto, 30% Orale).</p>
            </div>
            
            <!-- Voto Finale -->
            <div class="bg-red-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-red-800">Voto Finale (Arrotondato per Difetto):</p>
                <p class="text-4xl font-extrabold text-red-600 mt-1"><span id="corr-grade-floored">0</span> / 10</p>
                <p class="text-xs text-gray-600 mt-2">Voto non arrotondato: <span id="corr-grade-unrounded" class="font-bold">0.00</span></p>
            </div>

            <!-- Spiegazione Calcolo -->
            <div class="col-span-1 lg:col-span-3 bg-gray-100 p-4 rounded-lg border border-gray-300">
                <p class="text-sm font-bold text-gray-700">Formula di Conversione (Punti su 10):</p>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded">
                    Voto Scritto Base 10 = (Punti Corretti / 17) * 10
                </code>
                <p class="text-sm font-bold text-gray-700 mt-2">Calcolo Finale:</p>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded">
                    Voto Finale = (Voto Scritto * 0.7) + (Voto Orale * 0.3)
                </code>
            </div>
        </div>

        <!-- Esercizi con Correzione -->
        <div id="correction-form" class="space-y-6">
            <!-- Gli esercizi e i campi di input saranno popolati qui dal JS -->
        </div>
        
        <button class="action-button bg-gray-500 hover:bg-gray-700 text-white py-3 px-6 rounded-lg text-lg mt-8 w-full" 
                onclick="showMainView()">
            Torna alla Generazione Verifiche
        </button>
    </div>

    <!-- Contenitore Nascosto per la Stampa PDF -->
    <div id="print-area" class="print-container hidden"></div>

    <script>
        // -------------------------------------------------------------------------
        // VARIABILI GLOBALI E UTILIT√Ä
        // -------------------------------------------------------------------------

        // Oggetto per memorizzare i dati dell'ultima verifica generata per tipo (A, B, C)
        const generatedExamsData = {
            'A': null,
            'B': null,
            'C': null
        };
        const MAX_EXERCISES = 20;
        const MAX_POINTS = 17; // Punti effettivi per la valutazione

        // Funzione per generare un numero binario con parte frazionaria
        function generateBinaryFractional(intBits, fracBits) {
            let integerPart = Math.floor(Math.random() * (Math.pow(2, intBits) - 1)) + 1;
            let fractionalPart = 0;
            for (let i = 0; i < fracBits; i++) {
                if (Math.random() > 0.5) { fractionalPart += Math.pow(2, -(i + 1)); }
            }
            
            let binInteger = integerPart.toString(2);
            let binFractional = '';
            let tempFrac = fractionalPart;
            // Genera la parte frazionaria binaria
            for (let i = 0; i < fracBits; i++) {
                tempFrac *= 2;
                binFractional += Math.floor(tempFrac);
                tempFrac -= Math.floor(tempFrac);
            }
            
            const decimalValue = integerPart + fractionalPart;
            const binaryValue = binInteger + (binFractional.length > 0 ? '.' + binFractional : '');
            
            return { decimal: parseFloat(decimalValue.toFixed(4)), binary: binaryValue };
        }
        
        // Conversione Decimale a Romano (semplificata fino a 999)
        function decToRoman(num) {
            const map = { 1000: 'M', 900: 'CM', 500: 'D', 400: 'CD', 100: 'C', 90: 'XC', 50: 'L', 40: 'XL', 10: 'X', 9: 'IX', 5: 'V', 4: 'IV', 1: 'I' };
            let roman = '';
            for (let i of Object.keys(map).reverse()) {
                while (num >= parseInt(i)) {
                    roman += map[i];
                    num -= parseInt(i);
                }
            }
            return roman;
        }

        // -------------------------------------------------------------------------
        // LOGICA DI GENERAZIONE ESERCIZI
        // -------------------------------------------------------------------------

        function generateExam(type) {
            const questions = [];
            const solutions = [];
            let i = 1;

            // Tipi di conversione base (pi√π complessi)
            const conversionTypes = [
                { from: 10, to: 2, bits: 10 }, { from: 2, to: 10, bits: 10 }, // Dec-Bin / Bin-Dec (fino a 1023)
                { from: 8, to: 16, bits: 12 }, { from: 16, to: 8, bits: 12 }, // Oct-Hex / Hex-Oct
                { from: 2, to: 16, bits: 16 }, { from: 16, to: 2, bits: 16 }, // Bin-Hex / Hex-Bin (fino a 65535)
                { from: 10, to: 8, bits: 10 }, { from: 8, to: 10, bits: 10 }  // Dec-Oct / Oct-Dec
            ];

            const numConversions = type === 'A' ? 12 : 8; // Pi√π conversioni nella verifica A

            for (let k = 0; k < numConversions; k++) {
                const cType = conversionTypes[k % conversionTypes.length];

                let numDec, numInput, baseFrom, baseTo, labelFrom, labelTo;
                baseFrom = cType.from;
                baseTo = cType.to;
                
                // Genera numeri pi√π grandi
                const minVal = baseFrom === 2 ? 512 : 64; // Minimo per assicurare numeri lunghi
                numDec = Math.floor(Math.random() * (Math.pow(2, cType.bits) - minVal)) + minVal;
                
                if (baseFrom === 10) numInput = numDec;
                else if (baseFrom === 2) numInput = numDec.toString(2);
                else if (baseFrom === 8) numInput = numDec.toString(8);
                else if (baseFrom === 16) numInput = numDec.toString(16).toUpperCase();

                let solution;
                if (baseTo === 10) solution = numDec.toString();
                else if (baseTo === 2) solution = numDec.toString(2);
                else if (baseTo === 8) solution = numDec.toString(8);
                else if (baseTo === 16) solution = numDec.toString(16).toUpperCase();

                labelFrom = baseFrom === 10 ? "Decimale (base 10)" : baseFrom === 2 ? "Binario (base 2)" : baseFrom === 8 ? "Ottale (base 8)" : "Esadecimale (base 16)";
                labelTo = baseTo === 10 ? "DECIMALE (base 10)" : baseTo === 2 ? "BINARIO (base 2)" : baseTo === 8 ? "OTTALE (base 8)" : "ESADECIMALE (base 16)";

                const questionText = `CONVERTI il numero ${labelFrom}: **${numInput}** in ${labelTo}.`;
                questions.push({ type: 'conversion', text: questionText, base: baseTo });
                solutions.push(solution);
                i++;
            }

            // Esercizi Frazioni Binarie (3 esercizi)
            for (let j = 0; j < 3; j++) {
                const fracNum = generateBinaryFractional(6, 6); // 6 bit interi, 6 frazionari
                const questionText = `Dato il numero binario con la virgola **${fracNum.binary}**, calcola il suo equivalente in Base DECIMALE. Fornisci il risultato con due cifre decimali.`;
                questions.push({ type: 'fraction', text: questionText, base: 10 });
                solutions.push(fracNum.decimal.toFixed(2)); // Soluzione arrotondata
                i++;
            }

            // Esercizi Numeri Romani (2 esercizi)
            for (let j = 0; j < 2; j++) {
                const num = Math.floor(Math.random() * 999) + 1;
                const roman = decToRoman(num);
                const questionText = `CONVERTI IL NUMERO DECIMALE ${num} IN NUMERO ROMANO (base ROM).`;
                questions.push({ type: 'roman', text: questionText, base: 'ROM' });
                solutions.push(roman);
                i++;
            }
            
            // Esercizi Operazioni Binarie (2 esercizi - solo Verifica A e C)
            if (type === 'A' || type === 'C') {
                for (let j = 0; j < 2; j++) {
                    const op = j === 0 ? '+' : '*';
                    const num1Dec = Math.floor(Math.random() * 20) + 10;
                    const num2Dec = Math.floor(Math.random() * 8) + 2;
                    const num1Bin = num1Dec.toString(2);
                    const num2Bin = num2Dec.toString(2).padStart(num1Bin.length, '0'); // Allineamento
                    
                    let resultDec;
                    if (op === '+') resultDec = num1Dec + num2Dec;
                    if (op === '*') resultDec = num1Dec * num2Dec;

                    const questionText = `Esegui l'operazione binaria di ${op === '+' ? 'ADDIZIONE' : 'MOLTIPLICAZIONE'}: **${num1Bin} ${op} ${num2Bin}**. Fornisci il risultato in Binario (base 2).`;
                    questions.push({ type: 'operation', text: questionText, base: 2 });
                    solutions.push(resultDec.toString(2));
                    i++;
                }
            }

            // Esercizi IP Address (Solo Verifica B e C)
            if (type === 'B' || type === 'C') {
                for (let j = 0; j < 3; j++) { // 3 esercizi IP
                    const oct1 = 192 + Math.floor(Math.random() * 10);
                    const oct2 = Math.floor(Math.random() * 256);
                    const oct3 = Math.floor(Math.random() * 256);
                    const oct4 = Math.floor(Math.random() * 256);
                    const mask = 24 + Math.floor(Math.random() * 5); // /24 a /28
                    const ip = `${oct1}.${oct2}.${oct3}.${oct4}`;
                    
                    // Nota: Qui la soluzione √® solo il Network ID per la correzione rapida
                    const netBin = (ip.split('.').map(o => parseInt(o).toString(2).padStart(8, '0'))).join('');
                    const netIDBinary = netBin.substring(0, mask).padEnd(32, '0');
                    
                    let networkID = [];
                    for (let n = 0; n < 4; n++) {
                        networkID.push(parseInt(netIDBinary.substring(n * 8, n * 8 + 8), 2));
                    }
                    networkID = networkID.join('.');

                    const questionText = `Dato l'indirizzo IP: **${ip}/${mask}**, determina l'indirizzo di Rete (Network ID) in formato decimale con la maschera.`;
                    questions.push({ type: 'ip', text: questionText, base: 'IP' });
                    solutions.push(`${networkID}/${mask}`);

                    i++;
                }
            }
            
            // Esercizi Floating Point (Mantissa/Esponente - Solo Verifica C)
            if (type === 'C') {
                for (let j = 0; j < 3; j++) { // 3 esercizi Floating Point
                    const numDec = (Math.random() * 20) + 1.0; 
                    
                    const questionText = `Dato il numero decimale **${numDec.toFixed(3)}** in Base 10, esprimi il valore in Notazione Scientifica Binaria (Forma Normalizzata: 1.M * 2^E) e indica l'Esponente (E).`;
                    questions.push({ type: 'float', text: questionText, base: 'FLOAT' });
                    
                    // La soluzione qui √® l'esponente E (il pi√π facile da verificare)
                    const binaryRepresentation = numDec.toString(2);
                    let exponent;
                    if (binaryRepresentation.includes('.')) {
                        const index = binaryRepresentation.indexOf('.');
                        exponent = index - 1;
                    } else {
                        exponent = binaryRepresentation.length - 1;
                    }
                    solutions.push(exponent.toString()); 
                    i++;
                }
            }

            // Riempi fino a 20 esercizi totali, se necessario
            while (questions.length < MAX_EXERCISES) {
                 const typeIndex = Math.floor(Math.random() * conversionTypes.length);
                 const cType = conversionTypes[typeIndex];
                 
                 let numDec = Math.floor(Math.random() * 255) + 64;
                 let numInput = numDec.toString(cType.from);
                 let solution = numDec.toString(cType.to).toUpperCase();

                 let labelFrom = cType.from === 10 ? "Decimale (base 10)" : cType.from === 2 ? "Binario (base 2)" : cType.from === 8 ? "Ottale (base 8)" : "Esadecimale (base 16)";
                 let labelTo = cType.to === 10 ? "DECIMALE (base 10)" : cType.to === 2 ? "BINARIO (base 2)" : cType.to === 8 ? "OTTALE (base 8)" : "ESADECIMALE (base 16)";

                 const questionText = `CONVERTI il numero ${labelFrom}: **${numInput}** in ${labelTo}.`;
                 questions.push({ type: 'conversion', text: questionText, base: cType.to });
                 solutions.push(solution);
            }

            // Salva tutti i 20 esercizi, ma solo i primi 17 per la correzione in tempo reale
            const examData = {
                questions: questions.slice(0, MAX_POINTS),
                solutions: solutions.slice(0, MAX_POINTS),
                type: type,
                fullQuestions: questions,
                fullSolutions: solutions
            };
            
            generatedExamsData[type] = examData;

            return examData;
        }

        // -------------------------------------------------------------------------
        // GESTIONE VISTE E PDF
        // -------------------------------------------------------------------------

        function getStudentData() {
            const nome = document.getElementById('nome-studente').value.trim();
            const cognome = document.getElementById('cognome-studente').value.trim();
            const classe = document.getElementById('classe-studente').value.trim();
            const data = document.getElementById('data-verifica').value;
            return { nome, cognome, classe, data };
        }

        function handleGeneration(type, isStudent) {
            const data = getStudentData();

            if (!data.nome || !data.cognome) {
                alert('Attenzione: Inserisci NOME e COGNOME dello studente per la stampa!');
                return;
            }

            // Genera l'esame e salva i dati
            const exam = generateExam(type);

            // Genera il PDF
            generatePDF(type, data, exam.fullQuestions, exam.fullSolutions, isStudent);

            // Se √® la verifica dello studente, genera il link per la correzione (non resetta gli altri link)
            if (isStudent) {
                showCorrectionLink(type);
            }
        }

        function showCorrectionLink(type) {
            const linkDiv = document.getElementById(`link-${type.toLowerCase()}`);
            linkDiv.innerHTML = `
                <a href="#" onclick="showCorrectionView('${type}')"
                   class="inline-block mt-3 bg-gradient-red text-white py-2 px-6 rounded-lg text-lg action-button hover:ring-4 ring-red-300 transition-all duration-300">
                    Vai alla Correzione della Verifica ${type} (Link Attivo)
                </a>
            `;
        }

        function generatePDF(type, data, questions, solutions, isStudent) {
            const examTitle = type === 'A' ? 'Sistemi di Numerazione' :
                              type === 'B' ? 'IP e Sistemi Numerici' : 'Floating Point e IP (Avanzata)';
            
            const pdfHTML = createPDFContent(type, data, questions, solutions, isStudent, examTitle);
            
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = pdfHTML;
            
            // Simula il download automatico con il nome richiesto
            const fileName = isStudent 
                ? `verifica_studente_${data.nome}_${data.cognome}.pdf`
                : `verifica_docente_soluzioni_${data.nome}_${data.cognome}.pdf`;

            // Usa window.print() per generare il PDF
            const style = document.createElement('style');
            style.innerHTML = `@page { size: A4; margin: 1cm; }`;
            document.head.appendChild(style);

            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');

            document.head.removeChild(style);

            console.log(`PDF generato con successo: ${fileName}`);
        }

        function createPDFContent(type, data, questions, solutions, isStudent, examTitle) {
            let contentHTML = `
                <div class="print-container p-6 w-full mx-auto code-font text-sm">
                    <header class="text-center mb-6 pb-2 border-b-4 ${isStudent ? 'border-blue-600' : 'border-green-600'}">
                        <h1 class="text-3xl font-extrabold text-gray-900">VERIFICA DI INFORMATICA</h1>
                        <p class="text-xl text-gray-700">Docente: Giuseppe Borzumati</p>
                        <p class="text-lg font-bold text-gray-600">Argomento: ${examTitle}</p>
                    </header>

                    <div class="mb-6 grid grid-cols-2 gap-4 text-sm font-semibold border p-3 rounded-lg bg-gray-50">
                        <p>Nome: <span class="font-normal border-b border-gray-400 w-full inline-block">${data.nome} ${data.cognome}</span></p>
                        <p>Classe: <span class="font-normal border-b border-gray-400 w-full inline-block">${data.classe}</span></p>
                        <p>Data: <span class="font-normal border-b border-gray-400 w-full inline-block">${data.data}</span></p>
                        <p>Esercizi Totali: <span class="font-normal border-b border-gray-400 w-full inline-block">${MAX_EXERCISES}</span></p>
                    </div>

                    <h2 class="text-2xl font-bold mb-4 ${isStudent ? 'text-blue-800' : 'text-green-800'}">Tracce degli Esercizi</h2>
                    
                    <ol class="list-decimal pl-5 space-y-4">
            `;
            
            questions.forEach((q, index) => {
                const solution = solutions[index];
                const solutionDisplay = isStudent ? '' : `<p class="mt-1 text-xs font-bold text-green-700">Soluzione: ${solution}</p>`;
                
                contentHTML += `
                    <li class="font-semibold text-base">
                        ${q.text.replace(/\*\*(.*?)\*\*/g, '<u>$1</u>')}
                        <div class="mt-1 pb-4">
                            ${isStudent ? '<span class="border-b border-dashed border-gray-500 w-full inline-block h-8"></span>' : solutionDisplay}
                        </div>
                    </li>
                `;
                
                // Mantiene il layout compatto, ma rompe pagina se troppo lungo (max 10 per pagina)
                if (index > 0 && (index + 1) % 10 === 0 && index < questions.length - 1) {
                    contentHTML += '<div class="page-break"></div>';
                }
            });

            contentHTML += `
                    </ol>
                    <footer class="mt-10 pt-4 border-t text-center text-xs text-gray-500">
                        Buon lavoro e in bocca al lupo! - Prof. B.
                    </footer>
                </div>
            `;
            return contentHTML;
        }


        // -------------------------------------------------------------------------
        // VISTA CORREZIONE E LOGICA DI VOTO
        // -------------------------------------------------------------------------

        let currentExamData = null;

        // Mostra la vista di correzione
        function showCorrectionView(type) {
            currentExamData = generatedExamsData[type];
            if (!currentExamData) {
                alert('Errore: Dati della verifica non trovati. Genera prima il PDF dello studente.');
                return;
            }

            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('correction-view').classList.remove('hidden');
            
            document.getElementById('corr-title').textContent = type === 'A' ? 'Verifica A' : type === 'B' ? 'Verifica B' : 'Verifica C';
            
            populateCorrectionForm();
        }

        // Torna alla vista principale
        function showMainView() {
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('correction-view').classList.add('hidden');
        }

        function populateCorrectionForm() {
            const formContainer = document.getElementById('correction-form');
            formContainer.innerHTML = '';
            
            currentExamData.questions.forEach((q, index) => {
                const qNum = index + 1;
                
                const questionBlock = document.createElement('div');
                questionBlock.className = 'bg-white p-4 rounded-xl shadow-lg border border-gray-200';
                questionBlock.innerHTML = `
                    <p class="font-bold text-lg text-gray-800 mb-3">${qNum}. ${q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                    
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <input type="text" id="answer-${qNum}" 
                               class="answer-input p-3 border-2 border-gray-300 rounded-lg flex-1 code-font text-lg focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="Risposta in Base ${q.base === 'ROM' ? 'ROM' : q.base === 'IP' ? 'Dec.' : q.base}..."
                               oninput="checkAnswer(${qNum})">
                        
                        <div id="feedback-${qNum}" class="mt-2 sm:mt-0 p-2 rounded-lg text-sm font-bold text-gray-700 w-full sm:w-64 border border-yellow-400 bg-yellow-100 hidden">
                             In attesa... (0 Punti)
                        </div>
                    </div>
                `;
                formContainer.appendChild(questionBlock);
            });
            
            // Inizializza il punteggio a 0
            updateFinalGrade();
        }
        
        // Verifica la risposta in tempo reale
        function checkAnswer(qNum) {
            const inputElement = document.getElementById(`answer-${qNum}`);
            const feedbackElement = document.getElementById(`feedback-${qNum}`);
            // Rimuove classi vecchie
            feedbackElement.className = 'mt-2 sm:mt-0 p-2 rounded-lg text-sm font-bold w-full sm:w-64 transition-all duration-200';
            
            const userAnswer = inputElement.value.trim().toUpperCase();
            // Soluzioni per IP e FLOAT devono essere trattate diversamente (controllo parziale)
            const correctAnswer = currentExamData.solutions[qNum - 1].toUpperCase();

            feedbackElement.classList.remove('hidden');
            
            // Funzione di pulizia per numeri (es. 101.000 -> 101, 10.0 -> 10)
            const clean = (s) => s.replace(/[^A-Z0-9\.\/]/g, '').replace(/\.0+$/, '').replace(/\.$/, '');
            
            // Logica di confronto
            if (userAnswer === '') {
                feedbackElement.classList.add('border', 'border-yellow-400', 'bg-yellow-100', 'text-gray-700');
                feedbackElement.innerHTML = 'In attesa di risposta... (0 Punti)';
                inputElement.setAttribute('data-correct', '0');
            } else if (clean(userAnswer) === clean(correctAnswer)) {
                feedbackElement.classList.add('feedback-correct', 'text-green-800');
                feedbackElement.innerHTML = '‚úÖ Risposta **CORRETTA**! (1 Punto)';
                inputElement.setAttribute('data-correct', '1');
            } else {
                feedbackElement.classList.add('feedback-wrong', 'text-red-800');
                feedbackElement.innerHTML = '‚ùå Risposta **ERRATA**. (0 Punti)';
                inputElement.setAttribute('data-correct', '0');
            }
            
            updateFinalGrade();
        }

        // Calcola il punteggio e il voto finale
        function updateFinalGrade() {
            let correctCount = 0;

            document.querySelectorAll('.answer-input').forEach(input => {
                if (input.getAttribute('data-correct') === '1') {
                    correctCount++;
                }
            });

            // Punteggio Esercizi (Base 17)
            document.getElementById('corr-points').textContent = correctCount;
            
            // Voto Orale (Base 10)
            const votoOrale = parseFloat(document.getElementById('voto-orale').value) || 0;

            // Calcolo Voto Verifica (Conversione proporzionale da 17 a 10)
            const gradeVerification = (correctCount / MAX_POINTS) * 10;
            
            // Voto Finale (Media Ponderata - 70% verifica, 30% orale)
            const finalGradeUnrounded = (gradeVerification * 0.7) + (votoOrale * 0.3);
            
            // Arrotondamento per DIFETTO (Math.floor) all'intero pi√π vicino, come richiesto
            const finalGradeFloored = Math.floor(finalGradeUnrounded);

            document.getElementById('corr-grade-unrounded').textContent = finalGradeUnrounded.toFixed(2);
            document.getElementById('corr-grade-floored').textContent = finalGradeFloored.toFixed(0);

            // Per la visualizzazione della formula
            document.querySelector('#conversion-explanation code').innerHTML = `
                Voto Scritto Base 10 = (${correctCount} / ${MAX_POINTS}) * 10 = ${gradeVerification.toFixed(2)}
            `;
        }

        // Imposta la data di default al caricamento della pagina
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('data-verifica');
            if (dateInput.value === "") {
                dateInput.value = new Date().toISOString().substring(0, 10);
            }
        });

    </script>
</body>
</html>
