
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Verifiche Informatica - Borzumati</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .code-font { font-family: 'Roboto Mono', monospace; }
        .code-block { background-color: #1e293b; color: #f8fafc; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; }

        /* Stili per la stampa PDF (ottimizzazione 2 pagine A4) */
        @media print {
            body { font-family: sans-serif !important; font-size: 10pt; background: white !important; }
            body > *:not(.print-container) { display: none !important; }
            .print-container { 
                display: block !important; 
                max-width: none !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                box-shadow: none !important; 
                height: auto;
            }
            @page { margin: 1cm; }
            
            .print-header { border-bottom: 2px solid #6366f1; padding-bottom: 0.5rem; margin-bottom: 1rem; }
            .print-header h1 { font-size: 14pt !important; font-weight: bold; }
            .print-header p { font-size: 9pt !important; color: #374151; }
            
            .question-item { 
                margin-bottom: 1.2rem; 
                page-break-inside: avoid;
                border-left: 3px solid #6366f1;
                padding-left: 0.5rem;
            }
            .question-text { font-weight: 700; color: #1f2937; margin-bottom: 0.3rem; }
            .answer-line { 
                height: 1.2em; 
                display: block; 
                border-bottom: 1px dashed #9ca3af; 
                width: 100%; 
                margin-top: 0.2rem; 
            }
            .solution-box { 
                border: 1px solid #10b981; 
                background-color: #d1fae5; 
                padding: 0.2rem 0.5rem; 
                border-radius: 4px; 
                margin-top: 0.4rem; 
                font-size: 9pt;
            }
        }

        /* Stili per i pulsanti animati */
        .action-button { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); font-weight: 700; position: relative; overflow: hidden; }
        .action-button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
        .action-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.2); transform: skewX(-20deg); transition: all 0.7s; }
        .action-button:hover::before { left: 100%; }
        .bg-gradient-blue { background-image: linear-gradient(to right, #4c66ff 0%, #00c6ff 100%); }
        .bg-gradient-green { background-image: linear-gradient(to right, #10b981 0%, #1d7c4c 100%); }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 sm:p-8">

    <!-- Area di caricamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center hidden">
        <div class="text-center text-white">
            <svg class="animate-spin h-10 w-10 text-indigo-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold">Caricamento dati in corso... (Connessione a Firebase)</p>
        </div>
    </div>
    
    <!-- Sezione Dati Studente/Docente e Introduzione -->
    <div id="main-view" class="w-full max-w-7xl mx-auto bg-white rounded-xl shadow-[0_25px_50px_-12px_rgba(0,0,0,0.5)] p-6 sm:p-12 mb-8 space-y-10">
        <header class="text-center pb-6 border-b-4 border-indigo-500">
            <h1 class="text-4xl sm:text-6xl font-black leading-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-purple-600"> GENERATORE VERIFICHE INFORMATICA </span>
            </h1>
            <p class="text-xl text-gray-700 mt-2">Prof. Giuseppe Borzumati | Argomenti: Sistemi di Numerazione & Networking</p>
        </header>

        <!-- Dati Studente per la Generazione (Globali) -->
        <div class="bg-indigo-50 p-8 rounded-2xl shadow-inner border border-indigo-200">
            <h2 class="text-2xl font-bold text-indigo-800 mb-5 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 mr-2 text-indigo-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                </svg> 
                Dati Base
                <span id="teacher-id" class="code-font text-xs ml-4 p-1 bg-indigo-200 text-indigo-800 rounded"></span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div> <input type="text" id="nome-studente" placeholder="Nome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="text" id="cognome-studente" placeholder="Cognome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="text" id="classe-studente" placeholder="Classe (es. 4B)" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="date" id="data-verifica" value="" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
            </div>
            <p class="text-sm text-indigo-600 mt-4 font-semibold">Tutti i campi sono obbligatori per generare il link di correzione.</p>
        </div>

        <!-- Contenitore delle Verifiche (4 Blocchi) -->
        <div class="space-y-12">

            <!-- BLOCCO 1: Verifiche Numeriche PURE -->
            <div id="blocco-verifica-a" class="p-8 bg-red-50 border-t-8 border-t-red-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-red-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¢</span> VERIFICA A: Base, Frazioni, Operazioni (11 Domande)
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Conversione Base (2, 8, 10, 16), Frazioni Binarie, Numeri Romani, Addizione/Moltiplicazione/Divisione Binaria.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('A', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('A', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-A" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-red-600 border-b border-red-300 pb-1">Link di Correzione Generati (Verifica A):</h4>
                    <p class="text-sm text-gray-500" id="link-message-A">Nessuna verifica di Tipo A generata.</p>
                </div>
            </div>

            <!-- BLOCCO 2: Subnetting Semplice + Conversioni Miste -->
            <div id="blocco-verifica-b" class="p-8 bg-purple-50 border-t-8 border-t-purple-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-purple-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üåê</span> VERIFICA B: A + Networking Semplice (11 Domande)
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Contenuti della Verifica A + Subnetting (Network ID, Broadcast ID) e mix bilanciato di conversioni numeriche Basi 2, 8, 10, 16.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('B', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('B', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-B" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-purple-600 border-b border-purple-300 pb-1">Link di Correzione Generati (Verifica B):</h4>
                    <p class="text-sm text-gray-500" id="link-message-B">Nessuna verifica di Tipo B generata.</p>
                </div>
            </div>

            <!-- BLOCCO 3: Complemento a Due, Floating Point e IP Avanzato -->
            <div id="blocco-verifica-c" class="p-8 bg-teal-50 border-t-8 border-t-teal-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-teal-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¨</span> VERIFICA C: B + Complemento a Due e Floating Point (11 Domande)
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Contenuti della Verifica B + Rappresentazione in Complemento a Due (8 bit) e Notazione Floating Point (Esponente/Mantissa) semplificata.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('C', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('C', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-C" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-teal-600 border-b border-teal-300 pb-1">Link di Correzione Generati (Verifica C):</h4>
                    <p class="text-sm text-gray-500" id="link-message-C">Nessuna verifica di Tipo C generata.</p>
                </div>
            </div>
            
            <!-- BLOCCO 4: Riepilogo Completo e Problemi Critici (Verifica D) -->
            <div id="blocco-verifica-d" class="p-8 bg-yellow-50 border-t-8 border-t-yellow-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-yellow-800 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">‚≠ê</span> VERIFICA D: Riepilogo Completo & Subnetting Avanzato (11 Domande)
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Mix bilanciato di tutti gli argomenti (A, B, C) + Subnetting Avanzato (calcolo range di host utili, maschera decimale puntata).</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('D', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('D', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-D" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-yellow-600 border-b border-yellow-300 pb-1">Link di Correzione Generati (Verifica D):</h4>
                    <p class="text-sm text-gray-500" id="link-message-D">Nessuna verifica di Tipo D generata.</p>
                </div>
            </div>

        </div>

        <footer class="text-center pt-8 text-gray-500 text-sm border-t border-gray-200">
            <p>Sistema di Generazione Verifiche v5.1 | Per l'Insegnante Giuseppe Borzumati. Assicurati che il pop-up del browser sia consentito per scaricare il PDF.</p>
        </footer>
    </div>

    <!-- VISTA DI CORREZIONE (Caricata tramite link condivisibile) -->
    <div id="correction-view" class="hidden w-full max-w-5xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10 mb-8 space-y-8">
        <header class="text-center pb-4 border-b-4 border-green-500">
            <h1 class="text-4xl font-extrabold text-green-700 leading-tight">Griglia di Correzione Interattiva</h1>
            <p class="text-lg text-gray-600 mt-1">
                Studente: <span id="corr-student-name" class="font-extrabold text-indigo-600"></span> - 
                Classe: <span id="corr-class" class="font-extrabold text-indigo-600"></span> - 
                Verifica <span id="corr-title" class="font-bold"></span>
            </p>
        </header>

        <!-- Tabella Punteggio e Voto -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 bg-yellow-50 p-6 rounded-xl border-2 border-yellow-300 shadow-lg">
            <div class="col-span-1 lg:col-span-3">
                <h2 class="text-2xl font-bold text-yellow-800 mb-2 border-b border-yellow-400 pb-1">Valutazione</h2>
            </div>
            
            <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-blue-800">Punti Ottenuti:</p>
                <p class="text-4xl font-extrabold text-blue-600 mt-1"><span id="corr-points">0</span> / <span id="corr-max-points">11</span></p>
            </div>
            
            <div class="bg-purple-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-purple-800">Voto Orale (Base 10):</p>
                <input type="number" id="voto-orale" min="0" max="10" step="0.1" value="6.0" onchange="updateFinalGrade()" class="p-2 border-2 border-purple-500 rounded-lg w-full mt-1 text-xl font-bold">
            </div>
            
            <div class="bg-red-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-red-800">Voto Finale (Arrotondato per Difetto):</p>
                <p class="text-4xl font-extrabold text-red-600 mt-1"><span id="corr-grade-floored">0</span> / 10</p>
            </div>
            
            <div class="col-span-1 lg:col-span-3 bg-gray-100 p-4 rounded-lg border border-gray-300" id="conversion-explanation">
                <p class="text-sm font-bold text-gray-700">Formula di Calcolo:</p>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded"> Voto Scritto Base 10 = (Punti Ottenuti / 11) * 10 = <span id="voto-scritto-base">0.00</span> </code>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded"> Voto Finale = (Voto Scritto * 0.7) + (Voto Orale * 0.3) </code>
            </div>
        </div>

        <!-- Esercizi con Correzione -->
        <div id="correction-form" class="space-y-6"> 
            <!-- Gli esercizi e i campi di input saranno popolati qui dal JS -->
        </div>

        <button class="action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-lg mt-8 w-full" onclick="saveAndDownloadResultsPDF()"> Salva Risultati e Scarica PDF dei Commenti </button>
        <button class="action-button bg-gray-400 hover:bg-gray-500 text-gray-900 py-3 px-6 rounded-lg text-lg w-full" onclick="window.location.href = window.location.origin + window.location.pathname"> Torna alla Generazione Verifiche </button>
    </div>

    <!-- Contenitore Nascosto per la Stampa PDF (Stile ottimizzato per PDF) -->
    <div id="print-area" class="print-container hidden"></div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabili Globali del Modulo
        window.db = null;
        window.auth = null;
        window.teacherId = null;
        window.MAX_POINTS = 11; // Punti massimi per la verifica (Aggiornato a 11)

        // Configurazione Firebase fornita dall'utente
        // NOTA: Ho mantenuto la configurazione Firebase fornita nel codice originale
        const firebaseConfig = {
            apiKey: "AIzaSyDtruKdnoFjMqob-1zf-Zw0hXn8j_YwVio",
            authDomain: "verifichenumeribinari.firebaseapp.com",
            projectId: "verifichenumeribinari",
            storageBucket: "verifichenumeribinari.firebasestorage.app",
            messagingSenderId: "648812468179",
            appId: "1:648812468179:web:1a0e2d65cb1aae28e60126",
            measurementId: "G-K5SL1808G4"
        };

        // Funzione di Inizializzazione Firebase
        async function initializeFirebase() {
            try {
                // 1. Inizializzazione App
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // 2. Autenticazione Anonima
                await signInAnonymously(window.auth);
                window.teacherId = window.auth.currentUser.uid;
                
                // 3. Nascondi Overlay e Avvia l'app
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('teacher-id').textContent = `Docente ID: ${window.teacherId.substring(0, 8)}...`;

                // 4. Carica i link di correzione esistenti
                await window.updateLinkContainers();

                // 5. Verifica se √® una vista di correzione
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('examId');
                if (examId) {
                    window.showLoading();
                    await window.loadCorrectionView(examId);
                } else {
                    window.showMainView();
                }

            } catch (error) {
                console.error("Errore fatale nell'inizializzazione di Firebase e Auth:", error);
                document.getElementById('loading-overlay').classList.add('hidden');
                // Ho rimosso l'alert per evitare interruzioni nell'iframe, ma ho lasciato il log console.
            }
        }

        // ESPORTA LE FUNZIONI DI FIRESTORE NEL CONTESTO GLOBALE
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.doc = doc;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;

        // Esegui l'inizializzazione al caricamento
        window.addEventListener('load', () => {
            initializeFirebase();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data-verifica').value = today;
            document.getElementById('corr-max-points').textContent = window.MAX_POINTS;
        });
    </script>
    
    <script>
        // -------------------------------------------------------------------------
        // LOGICA DI VISTA E UTILITY (Indipendente da Moduli/Firebase)
        // -------------------------------------------------------------------------

        let currentExamData = null; // Dati della verifica attualmente in correzione
        
        window.showLoading = () => document.getElementById('loading-overlay').classList.remove('hidden');
        window.hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');

        // Navigazione tra le viste
        window.showMainView = () => {
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('correction-view').classList.add('hidden');
            window.hideLoading();
        };

        window.loadCorrectionView = async (examId) => {
            window.showLoading();
            try {
                // Ho modificato il path per usare il path pubblico/condiviso, ma mantenendo la collection 'exams'
                const examRef = window.doc(window.db, `artifacts/${window.teacherId}/public/data/exams`, examId);
                const docSnap = await window.getDoc(examRef);
                
                if (docSnap.exists()) {
                    currentExamData = docSnap.data();
                    document.getElementById('main-view').classList.add('hidden');
                    document.getElementById('correction-view').classList.remove('hidden');
                    renderCorrectionForm(currentExamData);
                    updateFinalGrade(); // Calcola il voto iniziale
                } else {
                    console.error("Verifica non trovata o ID non valido.");
                    window.location.href = window.location.origin + window.location.pathname; // Torna alla home
                }
            } catch (error) {
                console.error("Errore nel caricamento della correzione:", error);
                window.location.href = window.location.origin + window.location.pathname; // Torna alla home
            } finally {
                window.hideLoading();
            }
        };

        // Funzione per generare un ID unico
        const generateUniqueID = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 5);

        // Funzione per pulire e standardizzare le risposte (tolleranza)
        const cleanAnswer = (s) => s.toString()
            .trim()
            .toUpperCase()
            .replace(/[^A-Z0-9\.\/\;\-\+\s]/g, '') // Rimuove caratteri non validi
            .replace(/\s+/g, '') // Rimuove tutti gli spazi
            .replace(/,/g, '.'); // Sostituisce la virgola col punto come separatore decimale

        // -------------------------------------------------------------------------
        // FUNZIONI NUMERICHE DI CALCOLO (CRITICHE)
        // -------------------------------------------------------------------------

        // Funzione per generare un numero binario con parte frazionaria
        function generateBinaryFractional(intBits, fracBits) {
            // Parte intera (es. 1 a 31 per 5 bit)
            const integerPart = Math.floor(Math.random() * (Math.pow(2, intBits) - 1)) + 1;
            let binaryValue = integerPart.toString(2) + '.';
            
            // Parte frazionaria
            let fractionalValue = 0;
            let tempFrac = Math.random(); 
            for (let i = 0; i < fracBits; i++) {
                tempFrac *= 2;
                let bit = Math.floor(tempFrac);
                binaryValue += bit;
                fractionalValue += bit * Math.pow(2, -(i + 1));
                tempFrac -= bit;
            }

            const decimalValue = integerPart + fractionalValue;
            
            // Fornisce 3 cifre decimali di precisione
            return { decimal: parseFloat(decimalValue.toFixed(4)), binary: binaryValue };
        }

        // Funzione per calcolare il Complemento a Due (8 bit)
        function toTwosComplement(num) {
            if (num >= 0) {
                return num.toString(2).padStart(8, '0');
            }
            
            const absNum = Math.abs(num);
            let bin = absNum.toString(2).padStart(8, '0');
            
            // 1. Inverti i bit
            let inverted = [...bin].map(b => b === '0' ? '1' : '0').join('');
            
            // 2. Aggiungi 1 (in binario)
            let carry = 1;
            let twosComp = '';
            for (let i = 7; i >= 0; i--) {
                let bit = parseInt(inverted[i], 10);
                let sum = bit + carry;
                twosComp = (sum % 2) + twosComp;
                carry = Math.floor(sum / 2);
            }
            return twosComp;
        }

        // Funzione per convertire CIDR a Maschera Decimale Puntata
        function cidrToDottedDecimal(mask) {
            let binaryMask = '1'.repeat(mask).padEnd(32, '0');
            let dotted = [];
            for (let i = 0; i < 4; i++) {
                dotted.push(parseInt(binaryMask.substring(i * 8, (i + 1) * 8), 2));
            }
            return dotted.join('.');
        }
        
        // Funzione per calcolare ID Rete/Broadcast (Semplice)
        function calculateNetworkIDs(ip, mask) {
            const octets = ip.split('.').map(o => parseInt(o));
            const ipBin = octets.map(o => o.toString(2).padStart(8, '0')).join('');
            
            const networkPart = ipBin.substring(0, mask);
            
            // Network ID (host part = 0)
            const netIDBinary = networkPart.padEnd(32, '0');
            let networkID = [];
            for (let n = 0; n < 4; n++) {
                networkID.push(parseInt(netIDBinary.substring(n * 8, n * 8 + 8), 2));
            }
            const netID = networkID.join('.');

            // Broadcast ID (host part = 1)
            const hostPart = '1'.repeat(32 - mask);
            const broadcastBinary = networkPart + hostPart;
            let broadcastID = [];
            for (let n = 0; n < 4; n++) {
                broadcastID.push(parseInt(broadcastBinary.substring(n * 8, n * 8 + 8), 2));
            }
            const bcastID = broadcastID.join('.');
            
            return { network: netID, broadcast: bcastID, maskDec: cidrToDottedDecimal(mask) };
        }
        
        // Funzione per calcolare Range Host (Avanzato T9)
        function calculateHostRange(ip, mask) {
            const { network, broadcast, maskDec } = calculateNetworkIDs(ip, mask);
            const networkParts = network.split('.').map(Number);
            const broadcastParts = broadcast.split('.').map(Number);

            // Primo Host (Network ID + 1 nel quarto ottetto)
            networkParts[3] += 1;
            const firstHost = networkParts.join('.');

            // Ultimo Host (Broadcast ID - 1 nel quarto ottetto)
            broadcastParts[3] -= 1;
            const lastHost = broadcastParts.join('.');
            
            return {
                networkID: network,
                firstHost: firstHost,
                lastHost: lastHost,
                maskDec: maskDec,
            };
        }


        // Conversione Decimale a Romano (fino a 999)
        function decToRoman(num) {
            const map = { 1000: 'M', 900: 'CM', 500: 'D', 400: 'CD', 100: 'C', 90: 'XC', 50: 'L', 40: 'XL', 10: 'X', 9: 'IX', 5: 'V', 4: 'IV', 1: 'I' };
            let roman = '';
            for (let i of Object.keys(map).map(Number).sort((a, b) => b - a)) {
                while (num >= i) {
                    roman += map[i];
                    num -= i;
                }
            }
            return roman;
        }

        // Calcolo Notazione Scientifica Binaria (Floating Point Semplificato)
        function calculateFloatingPoint(dec) {
            let num = Math.abs(dec);
            let binary = num.toString(2);
            let exponent;
            let mantissa;
            
            if (binary.includes('.')) {
                const index = binary.indexOf('.');
                
                if (index > 1) { 
                    exponent = index - 1;
                } else if (index === 1) { // 1.xxx
                    exponent = 0;
                } else { // 0.xxx
                    let nonZeroIndex = binary.substring(2).search(/1/);
                    exponent = -(nonZeroIndex + 1);
                }
            } else {
                exponent = binary.length - 1;
            }
            
            const normalizedBinary = num.toString(2).replace('.', '').replace(/^0+/, ''); 
            const firstOne = normalizedBinary.indexOf('1');
            mantissa = normalizedBinary.substring(firstOne + 1).padEnd(14, '0').substring(0, 14);

            return { exponent, mantissa };
        }
        
        // Funzione per la Divisione Binaria (T8)
        function binaryDivide(dividendDec, divisorDec) {
            const quotientDec = Math.floor(dividendDec / divisorDec);
            const remainderDec = dividendDec % divisorDec;
            
            if (quotientDec === 0 || divisorDec === 0) return null; // Evita banali o divisione per zero
            
            return {
                quotientBin: quotientDec.toString(2),
                remainderBin: remainderDec.toString(2),
            };
        }


        // -------------------------------------------------------------------------
        // LOGICA DI GENERAZIONE ESERCIZI (MAX 11 DOMANDE)
        // -------------------------------------------------------------------------

        const conversionTypes = [
            { from: 10, to: 2, bits: 10 }, { from: 2, to: 10, bits: 10 }, 
            { from: 8, to: 16, bits: 12 }, { from: 16, to: 8, bits: 12 }, 
            { from: 2, to: 16, bits: 16 }, { from: 16, to: 2, bits: 16 }, 
            { from: 10, to: 8, bits: 10 }, { from: 8, to: 10, bits: 10 }
        ];

        // T1: Conversion
        const addConversions = (count, questions) => {
            for (let k = 0; k < count; k++) {
                const cType = conversionTypes[k % conversionTypes.length];
                let numDec, numInput, baseFrom, baseTo;
                baseFrom = cType.from;
                baseTo = cType.to;
                
                const minVal = baseFrom === 2 ? 512 : 64;
                numDec = Math.floor(Math.random() * (Math.pow(2, cType.bits) - minVal)) + minVal;

                if (baseFrom === 10) numInput = numDec;
                else if (baseFrom === 2) numInput = numDec.toString(2);
                else if (baseFrom === 8) numInput = numDec.toString(8);
                else if (baseFrom === 16) numInput = numDec.toString(16).toUpperCase();

                let solution;
                if (baseTo === 10) solution = numDec.toString();
                else if (baseTo === 2) solution = numDec.toString(2);
                else if (baseTo === 8) solution = numDec.toString(8);
                else if (baseTo === 16) solution = numDec.toString(16).toUpperCase();

                const labelFrom = baseFrom === 10 ? "Decimale (base 10)" : baseFrom === 2 ? "Binario (base 2)" : baseFrom === 8 ? "Ottale (base 8)" : "Esadecimale (base 16)";
                const labelTo = baseTo === 10 ? "DECIMALE (base 10)" : baseTo === 2 ? "BINARIO (base 2)" : baseTo === 8 ? "OTTALE (base 8)" : "ESADECIMALE (base 16)";
                
                const questionText = `[T1] CONVERTI il numero ${labelFrom}: **${numInput}** in ${labelTo}.`;
                questions.push({ type: 'conversion', text: questionText, base: baseTo, correct: solution });
            }
        };

        // T2: Binary Fraction
        const addBinaryFractions = (count, questions) => {
            for (let j = 0; j < count; j++) {
                const fracNum = generateBinaryFractional(5, 5);
                const precision = j % 2 === 0 ? 3 : 2; // Alterna 2 e 3 cifre
                const solution = fracNum.decimal.toFixed(precision);
                const questionText = `[T2] FRAZIONI BINARIE: Dato il numero binario con la virgola **${fracNum.binary}**, calcola il suo equivalente in Base DECIMALE. Fornisci il risultato con **${precision}** cifre decimali, separatore decimale punto (es. 12.75${precision === 3 ? '0' : ''}).`;
                questions.push({ type: 'fraction', text: questionText, base: 10, correct: solution });
            }
        };

        // T3: Binary Ops (+, *)
        const addBinaryOps = (count, questions) => {
            for (let j = 0; j < count; j++) {
                const op = j % 2 === 0 ? '+' : '*'; // Alterna Addizione e Moltiplicazione
                const num1Dec = Math.floor(Math.random() * 20) + 10;
                const num2Dec = Math.floor(Math.random() * 8) + 2;
                const num1Bin = num1Dec.toString(2);
                const num2Bin = num2Dec.toString(2);
                let resultDec; 
                if (op === '+') resultDec = num1Dec + num2Dec;
                if (op === '*') resultDec = num1Dec * num2Dec;
                const solution = resultDec.toString(2);
                const questionText = `[T3] OPERAZIONI BINARIE: Calcola **${num1Bin} ${op} ${num2Bin}** (in binario). Fornisci il risultato BINARIO.`;
                questions.push({ type: 'binop', text: questionText, base: 2, correct: solution });
            }
        };
        
        // T4: Roman Numerals
        const addRomanNumerals = (count, questions) => {
            for (let j = 0; j < count; j++) {
                const numDec = Math.floor(Math.random() * 950) + 50; // 50 - 999
                const solution = decToRoman(numDec);
                const questionText = `[T4] NUMERI ROMANI: Converti il numero DECIMALE **${numDec}** nel suo equivalente in Numeri Romani.`;
                questions.push({ type: 'roman', text: questionText, base: 'ROMAN', correct: solution });
            }
        };

        // T8: Binary Division (New Requirement)
        const addBinaryDivision = (count, questions) => {
            for (let j = 0; j < count; j++) {
                let dividendDec = 0;
                let divisorDec = 0;
                let result = null;
                
                // Loop per risultati non banali
                while (!result || parseInt(result.quotientBin, 2) < 4 || parseInt(result.quotientBin, 2) > 16 || parseInt(result.remainderBin, 2) > 7) {
                    dividendDec = Math.floor(Math.random() * 80) + 30;
                    divisorDec = Math.floor(Math.random() * 8) + 2;
                    result = binaryDivide(dividendDec, divisorDec);
                }

                const num1Bin = dividendDec.toString(2);
                const num2Bin = divisorDec.toString(2);
                
                const questionText = `[T8] DIVISIONE BINARIA: Calcola **${num1Bin} / ${num2Bin}** (in binario). Fornisci il risultato come QUOZIENTE e RESTO, separati da un punto e virgola (es. QuozienteBinario;RestoBinario).`;
                const solution = `${result.quotientBin};${result.remainderBin}`;
                questions.push({ type: 'bindiv', text: questionText, base: 'BIN;BIN', correct: solution });
            }
        };
        
        // T5: Simple Subnetting
        const addSimpleSubnetting = (count, questions) => {
            for (let j = 0; j < count; j++) {
                const octet1 = Math.floor(Math.random() * 40) + 140; // Class B/C range
                const octet2 = Math.floor(Math.random() * 255);
                const octet3 = 0; // Per semplicit√†
                const octet4 = 1; // Per semplicit√†
                const mask = Math.floor(Math.random() * (28 - 24)) + 24; // /24, /25, /26, /27
                const ip = `${octet1}.${octet2}.${octet3}.${octet4}`;

                const result = calculateNetworkIDs(ip, mask);

                const questionText = `[T5] SUBNETTING SEMPLICE: Data l'interfaccia **${ip}/${mask}**, calcola (in decimale): 1. L'ID di Rete, 2. L'ID di Broadcast, 3. La Maschera in decimale puntato. Separa i risultati con un punto e virgola (es. NetID;BroadcastID;Maschera).`;
                const solution = `${result.network};${result.broadcast};${result.maskDec}`;
                questions.push({ type: 'simpleip', text: questionText, base: 'IP;IP;MASK', correct: solution });
            }
        };

        // T6: Twos Complement
        const addTwosComplement = (count, questions) => {
            for (let j = 0; j < count; j++) {
                const isPositive = Math.random() < 0.5;
                let numDec;
                if (isPositive) {
                    numDec = Math.floor(Math.random() * 127) + 1; // 1 to 127
                } else {
                    numDec = -(Math.floor(Math.random() * 128) + 1); // -1 to -128
                }
                const solution = toTwosComplement(numDec);
                const questionText = `[T6] COMPLEMENTO A DUE: Rappresenta il numero DECIMALE **${numDec}** in Complemento a Due su **8 bit**. Fornisci la sequenza BINARIA (es. 10110110).`;
                questions.push({ type: 'twoscomp', text: questionText, base: 2, correct: solution });
            }
        };

        // T7: Floating Point
        const addFloatingPoint = (count, questions) => {
            for (let j = 0; j < count; j++) {
                const decNum = (Math.random() * 10) + 1.5; // 1.5 to 11.5
                const decNumRounded = parseFloat(decNum.toFixed(2));
                
                const { exponent, mantissa } = calculateFloatingPoint(decNumRounded);
                const questionText = `[T7] FLOATING POINT: Dato il numero DECIMALE **${decNumRounded}**, calcola la sua Notazione Scientifica Binaria (Semplificata, 14 bit di Mantissa). Fornisci Esponente e Mantissa separati da punto e virgola (es. EsponenteDecimale;MantissaBinaria).`;
                const solution = `${exponent};${mantissa}`;
                questions.push({ type: 'float', text: questionText, base: 'DEC;BIN', correct: solution });
            }
        };
        
        // T9: Advanced Subnetting
        const addAdvancedSubnetting = (count, questions) => {
            for (let j = 0; j < count; j++) {
                const octet1 = Math.floor(Math.random() * 40) + 140; // Class B/C range
                const octet2 = Math.floor(Math.random() * 255);
                const octet3 = Math.floor(Math.random() * 255);
                const octet4 = Math.floor(Math.random() * 255) + 1; // Not 0
                const mask = Math.floor(Math.random() * (30 - 24)) + 24; // /24 to /30
                const ip = `${octet1}.${octet2}.${octet3}.${octet4}`;

                const result = calculateHostRange(ip, mask);

                const questionText = `[T9] SUBNETTING AVANZATO: Data l'interfaccia **${ip}/${mask}**, calcola (in decimale): 1. ID di Rete, 2. Primo Host Utile, 3. Ultimo Host Utile, 4. Maschera in decimale puntato. Separa i risultati con un punto e virgola (es. NetID;PrimoHost;UltimoHost;Maschera).`;
                const solution = `${result.networkID};${result.firstHost};${result.lastHost};${result.maskDec}`;
                questions.push({ type: 'advip', text: questionText, base: 'IP;IP;IP;MASK', correct: solution });
            }
        };


        function generateExam(type) {
            const questions = [];

            // --- EXECUTION LOGIC (11 QUESTIONS TOTAL) ---

            if (type === 'A') {
                // T1: Conversion (5) | T2: Binary Fraction (2) | T3: Binary Ops (+, *) (2) | T4: Roman Numerals (1) | T8: Binary Division (1)
                addConversions(5, questions);
                addBinaryFractions(2, questions);
                addBinaryOps(2, questions);
                addRomanNumerals(1, questions);
                addBinaryDivision(1, questions);
            } else if (type === 'B') {
                // T1: Conversion (3) | T2: Binary Fraction (2) | T3: Binary Ops (+, *) (1) | T4: Roman Numerals (1) | T8: Binary Division (1) | T5: Simple Subnetting (3)
                addConversions(3, questions);
                addBinaryFractions(2, questions);
                addBinaryOps(1, questions);
                addRomanNumerals(1, questions);
                addBinaryDivision(1, questions);
                addSimpleSubnetting(3, questions);
            } else if (type === 'C') {
                // T1: Conversion (2) | T2: Binary Fraction (1) | T5: Simple Subnetting (2) | T6: Twos Complement (2) | T7: Floating Point (2) | T8: Binary Division (1) | T4: Roman Numerals (1)
                addConversions(2, questions);
                addBinaryFractions(1, questions);
                addSimpleSubnetting(2, questions);
                addTwosComplement(2, questions);
                addFloatingPoint(2, questions);
                addBinaryDivision(1, questions);
                addRomanNumerals(1, questions);
            } else if (type === 'D') {
                // T1: Conversion (2) | T2: Binary Fraction (1) | T3: Binary Ops (+, *) (1) | T4: Roman Numerals (1) | T5: Simple Subnetting (2) | T6: Twos Complement (1) | T7: Floating Point (1) | T8: Binary Division (1) | T9: Advanced Subnetting (1)
                addConversions(2, questions);
                addBinaryFractions(1, questions);
                addBinaryOps(1, questions);
                addRomanNumerals(1, questions);
                addSimpleSubnetting(2, questions);
                addTwosComplement(1, questions);
                addFloatingPoint(1, questions);
                addBinaryDivision(1, questions);
                addAdvancedSubnetting(1, questions);
            }

            // Shuffle the final 11 questions
            for (let i = questions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [questions[i], questions[j]] = [questions[j], questions[i]];
            }

            // Assign points (1 point per question)
            return questions.map((q, index) => ({
                ...q,
                id: index + 1,
                points: 1
            }));
        }

        // -------------------------------------------------------------------------
        // LOGICA FIREBASE E UI
        // -------------------------------------------------------------------------
        
        // Funzione per aggiornare i container dei link di correzione
        window.updateLinkContainers = async () => {
            if (!window.db || !window.teacherId) return;

            // Uso il path pubblico per consentire il recupero della verifica senza autenticazione specifica
            const examsColRef = window.collection(window.db, `artifacts/${window.teacherId}/public/data/exams`);
            const q = window.query(examsColRef, window.where("teacherId", "==", window.teacherId));
            
            try {
                const querySnapshot = await window.getDocs(q);
                const examsByType = { 'A': [], 'B': [], 'C': [], 'D': [] };

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.type && data.student && data.examId) {
                        examsByType[data.type]?.push({
                            ...data,
                            examId: doc.id
                        });
                    }
                });

                Object.keys(examsByType).forEach(type => {
                    const container = document.getElementById(`link-container-${type}`);
                    const message = document.getElementById(`link-message-${type}`);
                    if (container) {
                        if (examsByType[type].length > 0) {
                            message.classList.add('hidden');
                            container.innerHTML = `<h4 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-1">Verifiche Tipo ${type} salvate:</h4>`;
                            examsByType[type].sort((a, b) => b.timestamp - a.timestamp).forEach(exam => {
                                const url = window.location.origin + window.location.pathname + `?examId=${exam.examId}`;
                                const linkElement = document.createElement('div');
                                linkElement.className = 'bg-gray-100 p-3 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center code-font text-sm';
                                linkElement.innerHTML = `
                                    <span class="font-medium text-indigo-700">${exam.student.cognome.toUpperCase()} ${exam.student.nome} (${exam.student.classe})</span>
                                    <a href="${url}" target="_blank" class="text-blue-500 hover:text-blue-700 underline mt-1 sm:mt-0 break-all">
                                        Link Correzione
                                    </a>
                                `;
                                container.appendChild(linkElement);
                            });
                        } else {
                            message.classList.remove('hidden');
                            message.textContent = `Nessuna verifica di Tipo ${type} generata.`;
                        }
                    }
                });

            } catch (error) {
                console.error("Errore nel recupero dei link di correzione:", error);
            }
        };

        // Funzione principale per la generazione PDF e salvataggio
        window.handleGeneration = async (type, isStudentVersion) => {
            const nome = document.getElementById('nome-studente').value.trim();
            const cognome = document.getElementById('cognome-studente').value.trim();
            const classe = document.getElementById('classe-studente').value.trim();
            const data = document.getElementById('data-verifica').value.trim();

            if (!nome || !cognome || !classe || !data || !window.teacherId) {
                console.error("Dati incompleti");
                // Uso un messaggio discreto al posto dell'alert
                const message = document.createElement('div');
                message.className = 'fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl animate-bounce';
                message.textContent = 'Errore: Compila tutti i campi base (Nome, Cognome, Classe, Data)!';
                document.body.appendChild(message);
                setTimeout(() => message.remove(), 3000);
                return;
            }

            window.showLoading();
            
            try {
                // 1. Genera le domande
                const examQuestions = generateExam(type);

                // 2. Prepara i dati della verifica
                const examId = generateUniqueID();
                const examData = {
                    examId: examId,
                    teacherId: window.teacherId,
                    type: type,
                    student: { nome, cognome, classe, data },
                    questions: examQuestions,
                    maxPoints: window.MAX_POINTS,
                    timestamp: Date.now(),
                    results: null // Inizializzato a null per la correzione
                };

                // 3. Salva la verifica su Firestore (path pubblico per la correzione)
                const examRef = window.doc(window.db, `artifacts/${window.teacherId}/public/data/exams`, examId);
                await window.setDoc(examRef, examData);
                
                // 4. Genera il PDF
                renderPDF(examData, isStudentVersion);
                
                // 5. Aggiorna la lista dei link di correzione
                if (!isStudentVersion) {
                    await window.updateLinkContainers();
                }

            } catch (error) {
                console.error("Errore durante la generazione della verifica:", error);
                // Uso un messaggio discreto al posto dell'alert
                const message = document.createElement('div');
                message.className = 'fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl animate-bounce';
                message.textContent = 'Errore di sistema! Controlla la console.';
                document.body.appendChild(message);
                setTimeout(() => message.remove(), 3000);
            } finally {
                window.hideLoading();
            }
        };

        // -------------------------------------------------------------------------
        // FUNZIONI DI CORREZIONE E VALUTAZIONE
        // -------------------------------------------------------------------------

        function renderCorrectionForm(data) {
            currentExamData = data;
            
            document.getElementById('corr-student-name').textContent = `${data.student.cognome.toUpperCase()} ${data.student.nome}`;
            document.getElementById('corr-class').textContent = data.student.classe;
            document.getElementById('corr-title').textContent = `Tipo ${data.type} del ${data.student.data}`;
            document.getElementById('corr-max-points').textContent = data.maxPoints;

            const formContainer = document.getElementById('correction-form');
            formContainer.innerHTML = '';
            
            // Inizializza il voto orale a 6.0 se non salvato precedentemente
            const initialVotoOrale = data.results?.votoOrale ?? 6.0;
            document.getElementById('voto-orale').value = initialVotoOrale;


            data.questions.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'p-5 rounded-xl border-2 border-gray-200 shadow-md transition duration-300 hover:border-indigo-400';
                
                const questionHtml = `
                    <p class="text-lg font-bold text-gray-800 mb-3">Domanda ${index + 1} (1 pt):</p>
                    <p class="text-base text-gray-700 mb-4 code-font bg-gray-50 p-3 rounded-lg">${q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                    
                    <div class="flex items-center space-x-4 mb-4">
                        <label class="flex items-center text-green-700 font-semibold cursor-pointer">
                            <input type="radio" name="result-${q.id}" value="1" data-q-id="${q.id}" class="form-radio h-5 w-5 text-green-600" onchange="updateScore(${q.id}, 1)" ${data.results?.scores?.[q.id] === 1 ? 'checked' : ''}>
                            <span class="ml-2">Corretto (1 pt)</span>
                        </label>
                        <label class="flex items-center text-red-700 font-semibold cursor-pointer">
                            <input type="radio" name="result-${q.id}" value="0" data-q-id="${q.id}" class="form-radio h-5 w-5 text-red-600" onchange="updateScore(${q.id}, 0)" ${data.results?.scores?.[q.id] === 0 ? 'checked' : 'checked'}>
                            <span class="ml-2">Sbagliato (0 pt)</span>
                        </label>
                    </div>
                    
                    <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-200">
                        <p class="text-sm font-semibold text-indigo-700">SOLUZIONE CORRETTA:</p>
                        <code class="code-font text-base text-indigo-900 break-all">
                            ${q.correct}
                        </code>
                    </div>
                    
                    <div class="mt-4">
                        <label for="comment-${q.id}" class="block text-sm font-medium text-gray-700">Commento Docente (Opzionale):</label>
                        <textarea id="comment-${q.id}" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 text-sm">${data.results?.comments?.[q.id] || ''}</textarea>
                    </div>
                `;
                qDiv.innerHTML = questionHtml;
                formContainer.appendChild(qDiv);
            });
            updateScoreDisplay();
        }

        window.updateScore = (qId, score) => {
            if (!currentExamData.results) {
                currentExamData.results = { scores: {}, comments: {}, votoOrale: 6.0 };
            }
            currentExamData.results.scores[qId] = score;
            updateScoreDisplay();
        };

        function updateScoreDisplay() {
            let totalPoints = 0;
            const maxPoints = currentExamData.maxPoints;
            
            if (currentExamData.results && currentExamData.results.scores) {
                Object.values(currentExamData.results.scores).forEach(score => {
                    totalPoints += score;
                });
            }
            
            document.getElementById('corr-points').textContent = totalPoints;
            updateFinalGrade();
        }

        window.updateFinalGrade = () => {
            const totalPoints = parseInt(document.getElementById('corr-points').textContent);
            const maxPoints = currentExamData?.maxPoints || window.MAX_POINTS;
            const votoOrale = parseFloat(document.getElementById('voto-orale').value);
            
            // Voto Scritto in base 10
            const writtenGradeBase10 = (totalPoints / maxPoints) * 10;
            document.getElementById('voto-scritto-base').textContent = writtenGradeBase10.toFixed(2);
            
            // Voto Finale ponderato (70% scritto, 30% orale)
            const finalGrade = (writtenGradeBase10 * 0.7) + (votoOrale * 0.3);
            
            // Arrotondamento per difetto
            const finalGradeFloored = Math.floor(finalGrade * 10) / 10; 
            
            document.getElementById('corr-grade-floored').textContent = finalGradeFloored.toFixed(1);
            
            // Aggiorna voto orale salvato
            if (!currentExamData.results) {
                currentExamData.results = { scores: {}, comments: {}, votoOrale: 6.0 };
            }
            currentExamData.results.votoOrale = votoOrale;
        };
        
        // -------------------------------------------------------------------------
        // FUNZIONE DI SALVATAGGIO E DOWNLOAD PDF RISULTATI
        // -------------------------------------------------------------------------

        window.saveAndDownloadResultsPDF = async () => {
            window.showLoading();
            
            // 1. Aggiorna i commenti finali prima di salvare
            currentExamData.questions.forEach(q => {
                const commentElement = document.getElementById(`comment-${q.id}`);
                if (commentElement) {
                    if (!currentExamData.results.comments) currentExamData.results.comments = {};
                    currentExamData.results.comments[q.id] = commentElement.value.trim();
                }
            });
            
            // 2. Aggiorna il voto orale salvato
            currentExamData.results.votoOrale = parseFloat(document.getElementById('voto-orale').value);
            
            // 3. Calcola i voti finali e aggiungili al data model
            const totalPoints = parseInt(document.getElementById('corr-points').textContent);
            const writtenGradeBase10 = (totalPoints / currentExamData.maxPoints) * 10;
            const finalGrade = (writtenGradeBase10 * 0.7) + (currentExamData.results.votoOrale * 0.3);
            currentExamData.results.finalGrade = Math.floor(finalGrade * 10) / 10;
            currentExamData.results.writtenGrade = writtenGradeBase10;
            currentExamData.results.totalPoints = totalPoints;

            try {
                // 4. Salva i risultati nel documento esistente
                const examRef = window.doc(window.db, `artifacts/${window.teacherId}/public/data/exams`, currentExamData.examId);
                await window.setDoc(examRef, currentExamData);

                // 5. Genera il PDF dei Risultati
                renderResultsPDF(currentExamData);
                
            } catch (error) {
                console.error("Errore durante il salvataggio dei risultati:", error);
                const message = document.createElement('div');
                message.className = 'fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl animate-bounce';
                message.textContent = 'Errore nel salvataggio! Controlla la console.';
                document.body.appendChild(message);
                setTimeout(() => message.remove(), 3000);
            } finally {
                window.hideLoading();
            }
        };

        // -------------------------------------------------------------------------
        // LOGICA DI RENDERING PDF
        // -------------------------------------------------------------------------

        function renderPDF(data, isStudentVersion) {
            const printArea = document.getElementById('print-area');
            let content = '';

            const title = isStudentVersion ? `Verifica ${data.type} (ALUNNO)` : `Verifica ${data.type} (DOCENTE CON SOLUZIONI)`;
            const headerColor = isStudentVersion ? 'text-indigo-600' : 'text-green-600';

            content += `
                <div class="print-header">
                    <h1 class="${headerColor}">${title}</h1>
                    <p><strong>Argomenti:</strong> Sistemi di Numerazione, Operazioni Binarie, Subnetting e Rappresentazione Dati</p>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <p><strong>Studente:</strong> ${data.student.cognome.toUpperCase()} ${data.student.nome} (${data.student.classe})</p>
                        <p><strong>Data:</strong> ${new Date(data.student.data).toLocaleDateString('it-IT')}</p>
                        <p><strong>Punti Max:</strong> ${data.maxPoints}</p>
                    </div>
                    ${!isStudentVersion ? `<p style="text-align: right; margin-top: 5px; font-weight: bold; color: #6366f1;">ID Verifica: ${data.examId}</p>` : ''}
                </div>
            `;

            data.questions.forEach((q, index) => {
                const isCorrect = data.results?.scores?.[q.id] === 1;
                const isIncorrect = data.results?.scores?.[q.id] === 0;

                const statusTag = isCorrect ? 'CORRETTO' : (isIncorrect ? 'ERRATO' : '');
                const statusClass = isCorrect ? 'bg-green-100 text-green-800' : (isIncorrect ? 'bg-red-100 text-red-800' : '');

                const commentHtml = data.results?.comments?.[q.id] 
                    ? `<div style="margin-top: 5px; padding: 5px; border-left: 3px solid #f97316; font-size: 8pt;">
                         <strong>Commento Docente:</strong> ${data.results.comments[q.id]}
                       </div>`
                    : '';

                content += `
                    <div class="question-item">
                        <p class="question-text">${index + 1}. ${q.text.replace(/\*\*(.*?)\*\*/g, '<span>$1</span>')}</p>
                        ${isStudentVersion ? '<span class="answer-line"></span><span class="answer-line"></span>' : `<div class="solution-box">Soluzione: ${q.correct}</div>`}
                        ${data.results ? `<span class="text-xs font-bold ${statusClass} p-1 rounded-sm">${statusTag} (Punti: ${data.results.scores?.[q.id] || 0}/1)</span>${commentHtml}` : ''}
                    </div>
                `;
            });

            printArea.innerHTML = content;
            window.print();
        }
        
        function renderResultsPDF(data) {
            const printArea = document.getElementById('print-area');
            let content = '';
            
            const totalPoints = data.results.totalPoints;
            const finalGrade = data.results.finalGrade;
            const writtenGrade = data.results.writtenGrade.toFixed(2);
            const votoOrale = data.results.votoOrale.toFixed(1);

            content += `
                <div class="print-header">
                    <h1 class="text-red-700">GRIGLIA DI CORREZIONE E RISULTATI</h1>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <p><strong>Studente:</strong> ${data.student.cognome.toUpperCase()} ${data.student.nome} (${data.student.classe})</p>
                        <p><strong>Data Verifica:</strong> ${new Date(data.student.data).toLocaleDateString('it-IT')}</p>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; border: 1px solid #e5e7eb; padding: 10px; background-color: #f3f4f6; border-radius: 5px;">
                        <p style="font-size: 11pt;"><strong>Punti Totali:</strong> ${totalPoints}/${data.maxPoints}</p>
                        <p style="font-size: 11pt;"><strong>Voto Scritto (Base 10):</strong> ${writtenGrade}</p>
                        <p style="font-size: 11pt;"><strong>Voto Orale (30%):</strong> ${votoOrale}</p>
                        <p style="font-size: 14pt; font-weight: bold; color: #ef4444;"><strong>VOTO FINALE:</strong> ${finalGrade.toFixed(1)}</p>
                    </div>
                    <p style="margin-top: 10px; font-size: 9pt; color: #6b7280;">Formula: (Voto Scritto * 0.7) + (Voto Orale * 0.3). Arrotondato per difetto.</p>
                </div>
            `;

            data.questions.forEach((q, index) => {
                const score = data.results.scores?.[q.id] || 0;
                const comment = data.results.comments?.[q.id] || '';

                const statusText = score === 1 ? 'CORRETTO' : 'ERRATO';
                const statusClass = score === 1 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

                content += `
                    <div class="question-item" style="border-left-color: ${score === 1 ? '#10b981' : '#ef4444'};">
                        <p class="question-text">${index + 1}. ${q.text.replace(/\*\*(.*?)\*\*/g, '<span>$1</span>')}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                             <div class="solution-box" style="border-color: #3b82f6; background-color: #eff6ff; color: #1e40af;">Soluzione: ${q.correct}</div>
                             <span class="text-xs font-bold ${statusClass} p-1 rounded-sm">${statusText} (Punti: ${score}/1)</span>
                        </div>
                        ${comment ? `<div style="margin-top: 8px; padding: 5px; border-left: 3px solid #f97316; font-size: 9pt;">
                                       <strong>Commento Docente:</strong> ${comment}
                                     </div>` : ''}
                    </div>
                `;
            });

            printArea.innerHTML = content;
            window.print();
        }

    </script>
</body>
</html>
