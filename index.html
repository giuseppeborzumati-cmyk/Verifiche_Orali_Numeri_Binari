
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Verifiche Informatica - Borzumati</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .code-font { font-family: 'Roboto Mono', monospace; }
        .code-block { background-color: #1e293b; color: #f8fafc; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; }

        /* Stili per la stampa PDF (ottimizzazione 2 pagine A4) */
        @media print {
            body { font-family: sans-serif !important; font-size: 10pt; background: white !important; }
            body > *:not(.print-container) { display: none !important; }
            .print-container { 
                display: block !important; 
                max-width: none !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                box-shadow: none !important; 
                height: auto;
            }
            @page { margin: 1cm; }
            
            .print-header { border-bottom: 2px solid #6366f1; padding-bottom: 0.5rem; margin-bottom: 1rem; }
            .print-header h1 { font-size: 14pt !important; font-weight: bold; }
            .print-header p { font-size: 9pt !important; color: #374151; }
            
            .question-item { 
                margin-bottom: 1.2rem; 
                page-break-inside: avoid;
                border-left: 3px solid #6366f1;
                padding-left: 0.5rem;
            }
            .question-text { font-weight: 700; color: #1f2937; margin-bottom: 0.3rem; }
            .answer-line { 
                height: 1.2em; 
                display: block; 
                border-bottom: 1px dashed #9ca3af; 
                width: 100%; 
                margin-top: 0.2rem; 
            }
            .solution-box { 
                border: 1px solid #10b981; 
                background-color: #d1fae5; 
                padding: 0.2rem 0.5rem; 
                border-radius: 4px; 
                margin-top: 0.4rem; 
                font-size: 9pt;
            }
        }

        /* Stili per i pulsanti animati */
        .action-button { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); font-weight: 700; position: relative; overflow: hidden; }
        .action-button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
        .action-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.2); transform: skewX(-20deg); transition: all 0.7s; }
        .action-button:hover::before { left: 100%; }
        .bg-gradient-blue { background-image: linear-gradient(to right, #4c66ff 0%, #00c6ff 100%); }
        .bg-gradient-green { background-image: linear-gradient(to right, #10b981 0%, #1d7c4c 100%); }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 sm:p-8">

    <!-- Area di caricamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center hidden">
        <div class="text-center text-white">
            <svg class="animate-spin h-10 w-10 text-indigo-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold">Caricamento dati in corso... (Connessione a Firebase)</p>
        </div>
    </div>
    
    <!-- Sezione Dati Studente/Docente e Introduzione -->
    <div id="main-view" class="w-full max-w-7xl mx-auto bg-white rounded-xl shadow-[0_25px_50px_-12px_rgba(0,0,0,0.5)] p-6 sm:p-12 mb-8 space-y-10">
        <header class="text-center pb-6 border-b-4 border-indigo-500">
            <h1 class="text-4xl sm:text-6xl font-black leading-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-purple-600"> GENERATORE VERIFICHE INFORMATICA </span>
            </h1>
            <p class="text-xl text-gray-700 mt-2">Prof. Giuseppe Borzumati | Argomenti: Sistemi di Numerazione & Networking</p>
        </header>

        <!-- Dati Studente per la Generazione (Globali) -->
        <div class="bg-indigo-50 p-8 rounded-2xl shadow-inner border border-indigo-200">
            <h2 class="text-2xl font-bold text-indigo-800 mb-5 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 mr-2 text-indigo-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                </svg> 
                Dati Base
                <span id="teacher-id" class="code-font text-xs ml-4 p-1 bg-indigo-200 text-indigo-800 rounded"></span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div> <input type="text" id="nome-studente" placeholder="Nome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="text" id="cognome-studente" placeholder="Cognome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="text" id="classe-studente" placeholder="Classe (es. 4B)" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
                <div> <input type="date" id="data-verifica" value="" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg"> </div>
            </div>
            <p class="text-sm text-indigo-600 mt-4 font-semibold">Tutti i campi sono obbligatori per generare il link di correzione.</p>
        </div>

        <!-- Contenitore delle Verifiche (4 Blocchi) -->
        <div class="space-y-12">

            <!-- BLOCCO 1: Verifiche Numeriche PURE -->
            <div id="blocco-verifica-a" class="p-8 bg-red-50 border-t-8 border-t-red-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-red-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¢</span> VERIFICA A: Base, Frazioni Binarie & Operazioni
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Conversione Base (2, 8, 10, 16), Frazioni Binarie, Numeri Romani e Addizione/Moltiplicazione Binaria (17 Domande).</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('A', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('A', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-A" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-red-600 border-b border-red-300 pb-1">Link di Correzione Generati (Verifica A):</h4>
                    <p class="text-sm text-gray-500" id="link-message-A">Nessuna verifica di Tipo A generata.</p>
                </div>
            </div>

            <!-- BLOCCO 2: Subnetting Semplice + Conversioni Miste -->
            <div id="blocco-verifica-b" class="p-8 bg-purple-50 border-t-8 border-t-purple-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-purple-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üåê</span> VERIFICA B: Networking Semplice & Conversioni
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Subnetting (Network ID, Broadcast ID, Maschera) e mix di conversioni numeriche Basi 2, 8, 10, 16 (17 Domande).</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('B', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('B', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-B" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-purple-600 border-b border-purple-300 pb-1">Link di Correzione Generati (Verifica B):</h4>
                    <p class="text-sm text-gray-500" id="link-message-B">Nessuna verifica di Tipo B generata.</p>
                </div>
            </div>

            <!-- BLOCCO 3: Complemento a Due, Floating Point e IP Avanzato -->
            <div id="blocco-verifica-c" class="p-8 bg-teal-50 border-t-8 border-t-teal-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-teal-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¨</span> VERIFICA C: Complemento a Due, Floating Point e IP Avanzato
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Rappresentazione in Complemento a Due (8 bit), Notazione Floating Point (Esponente/Mantissa) e Subnetting complesso (17 Domande).</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('C', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('C', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-C" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-teal-600 border-b border-teal-300 pb-1">Link di Correzione Generati (Verifica C):</h4>
                    <p class="text-sm text-gray-500" id="link-message-C">Nessuna verifica di Tipo C generata.</p>
                </div>
            </div>
            
            <!-- BLOCCO 4: Riepilogo Completo e Problemi Critici (Verifica D) -->
            <div id="blocco-verifica-d" class="p-8 bg-yellow-50 border-t-8 border-t-yellow-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-yellow-800 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">‚≠ê</span> VERIFICA D: Riepilogo Completo & Problemi Critici
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Mix bilanciato di tutti gli argomenti (Base, Frazioni, Complemento a Due, Floating Point, Subnetting Avanzato) in un'unica prova (17 Domande).</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('D', true)"> üìÑ Genera PDF Alunno </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-8 rounded-xl text-xl" onclick="handleGeneration('D', false)"> üéì Genera PDF Docente (Soluzioni) </button>
                </div>
                <div id="link-container-D" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-yellow-600 border-b border-yellow-300 pb-1">Link di Correzione Generati (Verifica D):</h4>
                    <p class="text-sm text-gray-500" id="link-message-D">Nessuna verifica di Tipo D generata.</p>
                </div>
            </div>

        </div>

        <footer class="text-center pt-8 text-gray-500 text-sm border-t border-gray-200">
            <p>Sistema di Generazione Verifiche v5.1 | Per l'Insegnante Giuseppe Borzumati. Assicurati che il pop-up del browser sia consentito per scaricare il PDF.</p>
        </footer>
    </div>

    <!-- VISTA DI CORREZIONE (Caricata tramite link condivisibile) -->
    <div id="correction-view" class="hidden w-full max-w-5xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10 mb-8 space-y-8">
        <header class="text-center pb-4 border-b-4 border-green-500">
            <h1 class="text-4xl font-extrabold text-green-700 leading-tight">Griglia di Correzione Interattiva</h1>
            <p class="text-lg text-gray-600 mt-1">
                Studente: <span id="corr-student-name" class="font-extrabold text-indigo-600"></span> - 
                Classe: <span id="corr-class" class="font-extrabold text-indigo-600"></span> - 
                Verifica <span id="corr-title" class="font-bold"></span>
            </p>
        </header>

        <!-- Tabella Punteggio e Voto -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 bg-yellow-50 p-6 rounded-xl border-2 border-yellow-300 shadow-lg">
            <div class="col-span-1 lg:col-span-3">
                <h2 class="text-2xl font-bold text-yellow-800 mb-2 border-b border-yellow-400 pb-1">Valutazione</h2>
            </div>
            
            <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-blue-800">Punti Ottenuti:</p>
                <p class="text-4xl font-extrabold text-blue-600 mt-1"><span id="corr-points">0</span> / <span id="corr-max-points">17</span></p>
            </div>
            
            <div class="bg-purple-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-purple-800">Voto Orale (Base 10):</p>
                <input type="number" id="voto-orale" min="0" max="10" step="0.1" value="6.0" onchange="updateFinalGrade()" class="p-2 border-2 border-purple-500 rounded-lg w-full mt-1 text-xl font-bold">
            </div>
            
            <div class="bg-red-100 p-4 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-red-800">Voto Finale (Arrotondato per Difetto):</p>
                <p class="text-4xl font-extrabold text-red-600 mt-1"><span id="corr-grade-floored">0</span> / 10</p>
            </div>
            
            <div class="col-span-1 lg:col-span-3 bg-gray-100 p-4 rounded-lg border border-gray-300" id="conversion-explanation">
                <p class="text-sm font-bold text-gray-700">Formula di Calcolo:</p>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded"> Voto Scritto Base 10 = (Punti Ottenuti / 17) * 10 = <span id="voto-scritto-base">0.00</span> </code>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded"> Voto Finale = (Voto Scritto * 0.7) + (Voto Orale * 0.3) </code>
            </div>
        </div>

        <!-- Esercizi con Correzione -->
        <div id="correction-form" class="space-y-6"> 
            <!-- Gli esercizi e i campi di input saranno popolati qui dal JS -->
        </div>

        <button class="action-button bg-gradient-blue text-white py-4 px-8 rounded-xl text-lg mt-8 w-full" onclick="saveAndDownloadResultsPDF()"> Salva Risultati e Scarica PDF dei Commenti </button>
        <button class="action-button bg-gray-400 hover:bg-gray-500 text-gray-900 py-3 px-6 rounded-lg text-lg w-full" onclick="window.location.href = window.location.origin + window.location.pathname"> Torna alla Generazione Verifiche </button>
    </div>

    <!-- Contenitore Nascosto per la Stampa PDF (Stile ottimizzato per PDF) -->
    <div id="print-area" class="print-container hidden"></div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabili Globali del Modulo
        window.db = null;
        window.auth = null;
        window.teacherId = null;
        window.MAX_POINTS = 17; // Punti massimi per la verifica

        // Configurazione Firebase fornita dall'utente
        const firebaseConfig = {
            apiKey: "AIzaSyDtruKdnoFjMqob-1zf-Zw0hXn8j_YwVio",
            authDomain: "verifichenumeribinari.firebaseapp.com",
            projectId: "verifichenumeribinari",
            storageBucket: "verifichenumeribinari.firebasestorage.app",
            messagingSenderId: "648812468179",
            appId: "1:648812468179:web:1a0e2d65cb1aae28e60126",
            measurementId: "G-K5SL1808G4"
        };

        // Funzione di Inizializzazione Firebase
        async function initializeFirebase() {
            try {
                // 1. Inizializzazione App
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // 2. Autenticazione Anonima
                await signInAnonymously(window.auth);
                window.teacherId = window.auth.currentUser.uid;
                
                // 3. Nascondi Overlay e Avvia l'app
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('teacher-id').textContent = `Docente ID: ${window.teacherId.substring(0, 8)}...`;

                // 4. Carica i link di correzione esistenti
                await window.updateLinkContainers();

                // 5. Verifica se √® una vista di correzione
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('examId');
                if (examId) {
                    window.showLoading();
                    await window.loadCorrectionView(examId);
                } else {
                    window.showMainView();
                }

            } catch (error) {
                console.error("Errore fatale nell'inizializzazione di Firebase e Auth:", error);
                document.getElementById('loading-overlay').classList.add('hidden');
                alert("Errore di connessione al database. Controlla la console per i dettagli.");
            }
        }

        // ESPORTA LE FUNZIONI DI FIRESTORE NEL CONTESTO GLOBALE
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.doc = doc;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;

        // Esegui l'inizializzazione al caricamento
        window.addEventListener('load', () => {
            initializeFirebase();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data-verifica').value = today;
        });
    </script>
    
    <script>
        // -------------------------------------------------------------------------
        // LOGICA DI VISTA E UTILITY (Indipendente da Moduli/Firebase)
        // -------------------------------------------------------------------------

        let currentExamData = null; // Dati della verifica attualmente in correzione
        
        window.showLoading = () => document.getElementById('loading-overlay').classList.remove('hidden');
        window.hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');

        // Navigazione tra le viste
        window.showMainView = () => {
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('correction-view').classList.add('hidden');
            window.hideLoading();
        };

        window.loadCorrectionView = async (examId) => {
            window.showLoading();
            try {
                const examRef = window.doc(window.db, "exams", examId);
                const docSnap = await window.getDoc(examRef);
                
                if (docSnap.exists()) {
                    currentExamData = docSnap.data();
                    document.getElementById('main-view').classList.add('hidden');
                    document.getElementById('correction-view').classList.remove('hidden');
                    renderCorrectionForm(currentExamData);
                    updateFinalGrade(); // Calcola il voto iniziale
                } else {
                    alert("Verifica non trovata o ID non valido.");
                    window.location.href = window.location.origin + window.location.pathname; // Torna alla home
                }
            } catch (error) {
                console.error("Errore nel caricamento della correzione:", error);
                alert("Errore nel caricamento del documento dal database.");
                window.location.href = window.location.origin + window.location.pathname; // Torna alla home
            } finally {
                window.hideLoading();
            }
        };

        // Funzione per generare un ID unico
        const generateUniqueID = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 5);

        // Funzione per pulire e standardizzare le risposte (tolleranza)
        const cleanAnswer = (s) => s.toString()
            .trim()
            .toUpperCase()
            .replace(/[^A-Z0-9\.\/\;\-\+\s]/g, '') // Rimuove caratteri non validi
            .replace(/\s+/g, ''); // Rimuove tutti gli spazi

        // -------------------------------------------------------------------------
        // FUNZIONI NUMERICHE DI CALCOLO (CRITICHE)
        // -------------------------------------------------------------------------

        // Funzione per generare un numero binario con parte frazionaria
        function generateBinaryFractional(intBits, fracBits) {
            const integerPart = Math.floor(Math.random() * (Math.pow(2, intBits) - 1)) + 1;
            let fractionalValue = 0;
            let binFractional = '';
            let tempFrac = Math.random(); 
            
            for (let i = 0; i < fracBits; i++) {
                tempFrac *= 2;
                let bit = Math.floor(tempFrac);
                binFractional += bit;
                fractionalValue += bit * Math.pow(2, -(i + 1));
                tempFrac -= bit;
            }

            const decimalValue = integerPart + fractionalValue;
            const binaryValue = integerPart.toString(2) + '.' + binFractional;
            
            // Fornisce 3 cifre decimali di precisione
            return { decimal: parseFloat(decimalValue.toFixed(4)), binary: binaryValue };
        }

        // Funzione per calcolare il Complemento a Due (8 bit)
        function toTwosComplement(num) {
            if (num >= 0) {
                return num.toString(2).padStart(8, '0');
            }
            
            // Per i numeri negativi:
            const absNum = Math.abs(num);
            let bin = absNum.toString(2).padStart(8, '0');
            
            // 1. Inverti i bit
            let inverted = [...bin].map(b => b === '0' ? '1' : '0').join('');
            
            // 2. Aggiungi 1 (in binario)
            let carry = 1;
            let twosComp = '';
            for (let i = 7; i >= 0; i--) {
                let bit = parseInt(inverted[i], 10);
                let sum = bit + carry;
                twosComp = (sum % 2) + twosComp;
                carry = Math.floor(sum / 2);
            }
            return twosComp;
        }

        // Funzione per calcolare ID Rete/Broadcast
        function calculateNetworkIDs(ip, mask) {
            const octets = ip.split('.').map(o => parseInt(o));
            const ipBin = octets.map(o => o.toString(2).padStart(8, '0')).join('');
            
            const networkPart = ipBin.substring(0, mask);
            
            // Network ID (host part = 0)
            const netIDBinary = networkPart.padEnd(32, '0');
            let networkID = [];
            for (let n = 0; n < 4; n++) {
                networkID.push(parseInt(netIDBinary.substring(n * 8, n * 8 + 8), 2));
            }
            const netID = networkID.join('.');

            // Broadcast ID (host part = 1)
            const hostPart = '1'.repeat(32 - mask);
            const broadcastBinary = networkPart + hostPart;
            let broadcastID = [];
            for (let n = 0; n < 4; n++) {
                broadcastID.push(parseInt(broadcastBinary.substring(n * 8, n * 8 + 8), 2));
            }
            const bcastID = broadcastID.join('.');
            
            return { network: `${netID}/${mask}`, broadcast: `${bcastID}/${mask}` };
        }

        // Conversione Decimale a Romano (fino a 999)
        function decToRoman(num) {
            const map = { 1000: 'M', 900: 'CM', 500: 'D', 400: 'CD', 100: 'C', 90: 'XC', 50: 'L', 40: 'XL', 10: 'X', 9: 'IX', 5: 'V', 4: 'IV', 1: 'I' };
            let roman = '';
            for (let i of Object.keys(map).map(Number).sort((a, b) => b - a)) {
                while (num >= i) {
                    roman += map[i];
                    num -= i;
                }
            }
            return roman;
        }
        
        // Calcolo Notazione Scientifica Binaria (Floating Point Semplificato)
        function calculateFloatingPoint(dec) {
            let num = Math.abs(dec);
            let binary = num.toString(2);
            let exponent;
            let mantissa;
            
            if (binary.includes('.')) {
                // Esempio: 101.101 -> 1.01101 * 2^2. L'esponente √® la posizione della virgola
                const index = binary.indexOf('.');
                
                if (index === 1) { // 1.xxx
                    exponent = 0;
                } else if (index > 1) { // N > 1
                    exponent = index - 1;
                } else { // 0.xxx (Notazione Normalizzata non usa 0.M)
                    // Se il numero √® < 1, si sposta la virgola a destra: 0.00101 -> 1.01 * 2^-3
                    let nonZeroIndex = binary.substring(2).search(/1/);
                    if (nonZeroIndex === -1) { // Solo zero
                         exponent = 0;
                    } else {
                        exponent = -(nonZeroIndex + 1);
                    }
                }
            } else {
                // Esempio: 101 -> 1.01 * 2^2
                exponent = binary.length - 1;
            }
            
            // Rimuovi la virgola e il bit nascosto (il primo 1)
            const normalizedBinary = binary.replace('.', '').replace(/^0+/, ''); // Rimuove zeri iniziali e virgola
            const firstOne = normalizedBinary.indexOf('1');
            mantissa = normalizedBinary.substring(firstOne + 1).padEnd(14, '0').substring(0, 14);

            return { exponent, mantissa };
        }


        // -------------------------------------------------------------------------
        // LOGICA DI GENERAZIONE ESERCIZI
        // -------------------------------------------------------------------------

        function generateExam(type) {
            const questions = [];
            
            // Base Conversion types for mixing
            const conversionTypes = [
                { from: 10, to: 2, bits: 10 }, { from: 2, to: 10, bits: 10 }, 
                { from: 8, to: 16, bits: 12 }, { from: 16, to: 8, bits: 12 }, 
                { from: 2, to: 16, bits: 16 }, { from: 16, to: 2, bits: 16 }, 
                { from: 10, to: 8, bits: 10 }, { from: 8, to: 10, bits: 10 }
            ];

            const numConversions = type === 'A' ? 10 : (type === 'B' ? 6 : (type === 'C' ? 4 : 2)); // Tipo D ha 2 conversioni
            
            // Logica per le Conversioni
            if (type !== 'D') {
                for (let k = 0; k < numConversions; k++) {
                    const cType = conversionTypes[k % conversionTypes.length];
                    let numDec, numInput, baseFrom, baseTo;
                    baseFrom = cType.from;
                    baseTo = cType.to;
                    
                    const minVal = baseFrom === 2 ? 512 : 64;
                    numDec = Math.floor(Math.random() * (Math.pow(2, cType.bits) - minVal)) + minVal;

                    if (baseFrom === 10) numInput = numDec;
                    else if (baseFrom === 2) numInput = numDec.toString(2);
                    else if (baseFrom === 8) numInput = numDec.toString(8);
                    else if (baseFrom === 16) numInput = numDec.toString(16).toUpperCase();

                    let solution;
                    if (baseTo === 10) solution = numDec.toString();
                    else if (baseTo === 2) solution = numDec.toString(2);
                    else if (baseTo === 8) solution = numDec.toString(8);
                    else if (baseTo === 16) solution = numDec.toString(16).toUpperCase();

                    const labelFrom = baseFrom === 10 ? "Decimale (base 10)" : baseFrom === 2 ? "Binario (base 2)" : baseFrom === 8 ? "Ottale (base 8)" : "Esadecimale (base 16)";
                    const labelTo = baseTo === 10 ? "DECIMALE (base 10)" : baseTo === 2 ? "BINARIO (base 2)" : baseTo === 8 ? "OTTALE (base 8)" : "ESADECIMALE (base 16)";
                    
                    const questionText = `CONVERTI il numero ${labelFrom}: **${numInput}** in ${labelTo}.`;
                    questions.push({ type: 'conversion', text: questionText, base: baseTo, correct: solution });
                }
            }


            // Frazioni Binarie (Tipo A, B e D)
            if (type === 'A' || type === 'B' || type === 'D') {
                const fracCount = type === 'D' ? 3 : 3;
                for (let j = 0; j < fracCount; j++) {
                    const fracNum = generateBinaryFractional(type === 'D' ? 7 : 5, type === 'D' ? 7 : 5);
                    const solution = fracNum.decimal.toFixed(type === 'D' ? 3 : 2); // 3 cifre per D, 2 per A/B
                    const questionText = `Dato il numero binario con la virgola **${fracNum.binary}**, calcola il suo equivalente in Base DECIMALE. Fornisci il risultato con ${type === 'D' ? 'tre' : 'due'} cifre decimali, separatore decimale punto (es. 12.75${type === 'D' ? '0' : ''}).`;
                    questions.push({ type: 'fraction', text: questionText, base: 10, correct: solution });
                }
            }
            
            // Operazioni e Romani (Tipo A)
            if (type === 'A') {
                // 2 Operazioni Binarie
                for (let j = 0; j < 2; j++) {
                    const op = j === 0 ? '+' : '*';
                    const num1Dec = Math.floor(Math.random() * 20) + 10;
                    const num2Dec = Math.floor(Math.random() * 8) + 2;
                    const num1Bin = num1Dec.toString(2);
                    const num2Bin = num2Dec.toString(2).padStart(num1Bin.length, '0');
                    let resultDec; 
                    if (op === '+') resultDec = num1Dec + num2Dec;
                    if (op === '*') resultDec = num1Dec * num2Dec;
                    const solution = resultDec.toString(2);
                    const questionText = `Esegui l'operazione binaria di ${op === '+' ? 'ADDIZIONE' : 'MOLTIPLICAZIONE'} tra **${num1Bin}** e **${num2Bin}**. Fornisci il risultato in Binario (base 2).`;
                    questions.push({ type: 'operation', text: questionText, base: 2, correct: solution });
                }
                // 2 Numeri Romani
                for (let j = 0; j < 2; j++) {
                    const num = Math.floor(Math.random() * 999) + 1;
                    const solution = decToRoman(num);
                    const questionText = `CONVERTI IL NUMERO DECIMALE ${num} IN NUMERO ROMANO.`;
                    questions.push({ type: 'roman', text: questionText, base: 'ROM', correct: solution });
                }
            }

            // Esercizi di Networking (Tipo B, C e D)
            if (type === 'B' || type === 'C' || type === 'D') {
                const numIPQuestions = type === 'D' ? 6 : 4;
                const maskStart = type === 'B' ? 24 : (type === 'C' ? 20 : 16); // B:/24+, C:/20+, D:/16+ (Avanzato)
                
                for (let j = 0; j < numIPQuestions; j++) {
                    // Generazione di IP: Classe C per B, Misto per C/D
                    const oct1 = type === 'B' ? (192 + Math.floor(Math.random() * 10)) : (172 + Math.floor(Math.random() * 10));
                    const oct2 = Math.floor(Math.random() * 256);
                    const oct3 = Math.floor(Math.random() * 256);
                    const oct4 = Math.floor(Math.random() * 256);
                    const mask = maskStart + Math.floor(Math.random() * (28 - maskStart)); // Limite max /28 per complessit√† accettabile
                    
                    const ip = `${oct1}.${oct2}.${oct3}.${oct4}`;
                    const ids = calculateNetworkIDs(ip, mask);

                    if (j % 2 === 0) { // Network ID
                        const solution = ids.network;
                        const questionText = `Dato l'indirizzo IP: **${ip}/${mask}**, determina l'indirizzo di Rete (Network ID) in formato decimale con la maschera (es. 192.168.1.0/26).`;
                        questions.push({ type: 'ip_net', text: questionText, base: 'IP', correct: cleanAnswer(solution) });
                    } else { // Broadcast ID
                        const solution = ids.broadcast;
                        const questionText = `Dato l'indirizzo IP: **${ip}/${mask}**, determina l'indirizzo di Broadcast (Broadcast ID) in formato decimale con la maschera (es. 192.168.1.255/26).`;
                        questions.push({ type: 'ip_broadcast', text: questionText, base: 'IP', correct: cleanAnswer(solution) });
                    }
                }
            }

            // Esercizi Avanzati (Tipo C e D)
            if (type === 'C' || type === 'D') {
                const advancedCount = type === 'D' ? 3 : 3;
                
                // Complemento a Due (3 domande)
                for (let j = 0; j < advancedCount; j++) {
                    const numDec = Math.floor(Math.random() * 127) + 1;
                    const sign = Math.random() > 0.5 ? 1 : -1;
                    const numSigned = numDec * sign;
                    const solution = toTwosComplement(numSigned);
                    const questionText = `Rappresenta il numero decimale **${numSigned}** in Complemento a Due (Two's Complement) utilizzando 8 bit.`;
                    questions.push({ type: 'twos_complement', text: questionText, base: 'BIN', correct: solution });
                }
                
                // Notazione Floating Point (3 domande)
                for (let j = 0; j < advancedCount; j++) {
                    const numDec = (Math.random() * 50) + 0.5;
                    const { exponent, mantissa } = calculateFloatingPoint(numDec);
                    const solution = `${exponent};${mantissa}`; // E;M
                    const questionText = `Dato il numero decimale **${numDec.toFixed(4)}**, indicalo in Notazione Scientifica Binaria Normalizzata ($$1.M \cdot 2^E$$) e fornisci solo l'Esponente (E) e i primi 14 bit della Mantissa (M), separati da un punto e virgola (es. E;MANTISSA).`;
                    questions.push({ type: 'float', text: questionText, base: 'E; M', correct: solution });
                }
            }
            
            // Logica specifica per D per garantire 17 domande esatte dopo aver popolato le categorie specifiche
            if (type === 'D') {
                // Rimuovi 1 conversione e 1 frazione per arrivare a 17 se necessario (attualmente ne genera 2+3+3+3+6 = 17)
                while (questions.length > window.MAX_POINTS) {
                    questions.pop();
                }
            }


            // Assicura che la lunghezza finale sia 17
            while (questions.length < window.MAX_POINTS) {
                // Aggiungi conversioni semplici se mancano
                const cType = conversionTypes[Math.floor(Math.random() * conversionTypes.length)];
                let numDec = Math.floor(Math.random() * 255) + 64;
                let numInput = numDec.toString(cType.from);
                let solution = numDec.toString(cType.to).toUpperCase();
                let labelFrom = cType.from === 10 ? "Decimale (base 10)" : cType.from === 2 ? "Binario (base 2)" : cType.from === 8 ? "Ottale (base 8)" : "Esadecimale (base 16)";
                let labelTo = cType.to === 10 ? "DECIMALE (base 10)" : cType.to === 2 ? "BINARIO (base 2)" : cType.to === 8 ? "OTTALE (base 8)" : "ESADECIMALE (base 16)";
                const questionText = `CONVERTI il numero ${labelFrom}: **${numInput}** in ${labelTo}.`;
                questions.push({ type: 'conversion', text: questionText, base: cType.to, correct: solution });
            }


            return { 
                questions: questions.slice(0, window.MAX_POINTS).map(q => ({...q, userAnswer: '', isCorrect: false, points: 1})),
                type: type, 
                timestamp: Date.now(), 
                id: generateUniqueID(),
                meta: {
                    nome: document.getElementById('nome-studente').value.trim(),
                    cognome: document.getElementById('cognome-studente').value.trim(),
                    classe: document.getElementById('classe-studente').value.trim(),
                    data: document.getElementById('data-verifica').value,
                    teacherId: window.teacherId
                }
            };
        }
        
        // -------------------------------------------------------------------------
        // FUNZIONI DI GESTIONE DATI FIRESTORE
        // -------------------------------------------------------------------------

        // Salva la verifica generata (solo le domande/soluzioni)
        async function saveExamToDB(examData) {
            try {
                const examRef = window.doc(window.db, "exams", examData.id);
                // Aggiungiamo un campo di ricerca per l'ID del docente/tipo
                await window.setDoc(examRef, {
                    ...examData,
                    meta: {
                         ...examData.meta,
                         searchKey: `${examData.meta.classe}-${examData.meta.cognome}-${examData.type}`.toUpperCase()
                    }
                });
                return examData.id;
            } catch (e) {
                console.error("Errore nel salvataggio della verifica su Firestore:", e);
                alert("Impossibile salvare la verifica sul database.");
                return null;
            }
        }
        
        // Aggiorna l'elenco dei link di correzione
        window.updateLinkContainers = async () => {
            if (!window.teacherId || !window.db) return;

            try {
                // Query per tutte le verifiche generate da questo docente
                const q = window.query(window.collection(window.db, "exams"), 
                                        window.where("meta.teacherId", "==", window.teacherId));
                const querySnapshot = await window.getDocs(q);
                
                const examsByType = { A: [], B: [], C: [], D: [] };
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.type) {
                        examsByType[data.type].push(data);
                    }
                });

                ['A', 'B', 'C', 'D'].forEach(type => {
                    const container = document.getElementById(`link-container-${type}`);
                    const message = document.getElementById(`link-message-${type}`);
                    const exams = examsByType[type].sort((a, b) => b.timestamp - a.timestamp); // Pi√π recenti in alto

                    if (exams.length === 0) {
                        message.classList.remove('hidden');
                        container.querySelector('h4').classList.add('hidden');
                        container.querySelectorAll('.link-item').forEach(el => el.remove());
                    } else {
                        message.classList.add('hidden');
                        container.querySelector('h4').classList.remove('hidden');
                        // Rimuovi vecchi link e aggiungi nuovi
                        container.querySelectorAll('.link-item').forEach(el => el.remove());

                        exams.forEach(exam => {
                            const link = window.location.origin + window.location.pathname + `?examId=${exam.id}`;
                            const date = new Date(exam.timestamp).toLocaleDateString('it-IT');
                            const item = document.createElement('div');
                            item.className = 'link-item flex flex-col sm:flex-row justify-between items-center p-3 bg-white rounded-lg border border-gray-200 shadow-sm';
                            item.innerHTML = `
                                <p class="text-sm font-medium text-gray-700 w-full sm:w-1/2 mb-2 sm:mb-0">
                                    <span class="text-indigo-600 font-bold">${exam.meta.cognome} ${exam.meta.nome}</span> (${exam.meta.classe}) - ${date}
                                </p>
                                <a href="${link}" target="_blank" class="code-font text-xs text-blue-500 hover:text-blue-700 truncate w-full sm:w-1/3">
                                    ${link}
                                </a>
                                <button class="ml-4 p-2 text-red-500 hover:text-red-700 transition" onclick="deleteExam('${exam.id}', event)">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            `;
                            container.appendChild(item);
                        });
                    }
                });
            } catch (error) {
                console.error("Errore nel recupero dei link:", error);
                alert("Impossibile caricare i link di correzione. Ricarica la pagina.");
            }
        };
        
        // Elimina un esame da Firestore
        window.deleteExam = async (examId, event) => {
            event.stopPropagation();
            if (!confirm("Sei sicuro di voler eliminare questa verifica?")) return;

            try {
                const examRef = window.doc(window.db, "exams", examId);
                await window.setDoc(examRef, { isDeleted: true }, { merge: true }); // Soft delete
                alert("Verifica eliminata con successo.");
                window.updateLinkContainers();
            } catch (e) {
                console.error("Errore nell'eliminazione della verifica:", e);
                alert("Impossibile eliminare la verifica.");
            }
        };


        // -------------------------------------------------------------------------
        // GESTIONE CORREZIONE E VOTO
        // -------------------------------------------------------------------------

        // Renderizza la vista di correzione
        function renderCorrectionForm(data) {
            document.getElementById('corr-student-name').textContent = `${data.meta.cognome} ${data.meta.nome}`;
            document.getElementById('corr-class').textContent = data.meta.classe;
            document.getElementById('corr-title').textContent = data.type;
            document.getElementById('corr-max-points').textContent = data.questions.length;
            
            const formContainer = document.getElementById('correction-form');
            formContainer.innerHTML = '';
            
            data.questions.forEach((q, index) => {
                const qNum = index + 1;
                const solutionText = q.correct.length > 50 ? `${q.correct.substring(0, 50)}...` : q.correct;
                
                const questionElement = document.createElement('div');
                questionElement.className = 'p-5 rounded-lg shadow-md border border-gray-200';
                questionElement.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <p class="text-lg font-bold text-gray-800">DOMANDA ${qNum}. (1 Punto)</p>
                        <div id="status-${qNum}" class="px-3 py-1 rounded-full text-sm font-semibold text-white bg-gray-400">NON CORRETTO</div>
                    </div>
                    <p class="text-gray-700 mb-4">${q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-500 mb-1">Risposta Corretta:</label>
                            <div class="code-font text-sm p-3 bg-green-50 text-green-800 border border-green-300 rounded-lg">
                                ${solutionText}
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label for="input-${qNum}" class="block text-sm font-medium text-gray-500 mb-1">Risposta Inserita (Docente):</label>
                            <input type="text" id="input-${qNum}" 
                                class="p-3 border-2 border-indigo-300 rounded-lg w-full code-font text-base focus:ring-indigo-500 focus:border-indigo-500" 
                                placeholder="Risposta studente" oninput="checkCorrection(${qNum})">
                        </div>
                    </div>
                    
                    <div class="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <textarea id="comment-${qNum}" rows="1" class="w-full sm:w-2/3 p-3 border rounded-lg text-sm focus:ring-yellow-500 focus:border-yellow-500" placeholder="Aggiungi un commento didattico per lo studente..."></textarea>
                        <div class="sm:ml-4 mt-3 sm:mt-0">
                            <button class="action-button bg-gradient-green text-white py-2 px-4 rounded-lg text-sm" onclick="manualCorrection(${qNum}, true)">‚úÖ Corretto</button>
                            <button class="action-button bg-gradient-red text-white py-2 px-4 rounded-lg text-sm" onclick="manualCorrection(${qNum}, false)">‚ùå Errato</button>
                        </div>
                    </div>
                `;
                formContainer.appendChild(questionElement);
            });
            updateTotalPoints();
        }

        // Funzione di verifica automatica/assistita
        window.checkCorrection = (qNum) => {
            const input = document.getElementById(`input-${qNum}`);
            const status = document.getElementById(`status-${qNum}`);
            const qData = currentExamData.questions[qNum - 1];
            
            const userAnswer = cleanAnswer(input.value);
            const correctAnswer = cleanAnswer(qData.correct);

            qData.userAnswer = input.value.trim(); // Salva la risposta non pulita

            let isTolerantMatch = false;
            // Tolleranza: Check con spazio tolto e case insensitive
            if (userAnswer === correctAnswer) {
                 isTolerantMatch = true;
            } else if (qData.type === 'ip_net' || qData.type === 'ip_broadcast') {
                // Per IP, tolleranza su /mask se non presente nella risposta
                if (correctAnswer.startsWith(userAnswer) && userAnswer.length > 0) {
                    isTolerantMatch = true;
                }
            }


            if (isTolerantMatch) {
                // Suggerisci Corretto
                status.className = 'px-3 py-1 rounded-full text-sm font-semibold text-white bg-green-500';
                status.textContent = 'AUTOMATICO: CORRETTO';
                qData.isCorrect = true;
            } else if (userAnswer.length > 0) {
                 // Suggerisci Errato
                status.className = 'px-3 py-1 rounded-full text-sm font-semibold text-white bg-red-500';
                status.textContent = 'AUTOMATICO: ERRATO';
                qData.isCorrect = false;
            } else {
                 // In attesa
                status.className = 'px-3 py-1 rounded-full text-sm font-semibold text-white bg-gray-400';
                status.textContent = 'NON CORRETTO';
                qData.isCorrect = false;
            }
            
            updateTotalPoints();
        };

        // Correzione manuale (override del docente)
        window.manualCorrection = (qNum, isCorrect) => {
            const status = document.getElementById(`status-${qNum}`);
            const qData = currentExamData.questions[qNum - 1];
            
            qData.isCorrect = isCorrect;
            
            if (isCorrect) {
                status.className = 'px-3 py-1 rounded-full text-sm font-semibold text-white bg-indigo-600';
                status.textContent = 'MANUALE: CORRETTO';
            } else {
                status.className = 'px-3 py-1 rounded-full text-sm font-semibold text-white bg-red-600';
                status.textContent = 'MANUALE: ERRATO';
            }
            
            updateTotalPoints();
        };

        // Aggiorna il punteggio totale e il voto scritto
        function updateTotalPoints() {
            if (!currentExamData || !currentExamData.questions) return;
            
            let totalPoints = currentExamData.questions.filter(q => q.isCorrect).length;
            document.getElementById('corr-points').textContent = totalPoints;
            
            // Calcolo voto scritto base 10
            const maxPoints = currentExamData.questions.length;
            const writtenGrade = (totalPoints / maxPoints) * 10;
            
            document.getElementById('voto-scritto-base').textContent = writtenGrade.toFixed(2);
            currentExamData.writtenGrade = writtenGrade;

            updateFinalGrade();
        }

        // Calcola e aggiorna il voto finale
        window.updateFinalGrade = () => {
            const writtenGrade = currentExamData?.writtenGrade || 0;
            const oralGrade = parseFloat(document.getElementById('voto-orale').value) || 0;
            
            const finalGrade = (writtenGrade * 0.7) + (oralGrade * 0.3);
            const finalGradeFloored = Math.floor(finalGrade);
            
            document.getElementById('corr-grade-floored').textContent = finalGradeFloored;
        };


        // -------------------------------------------------------------------------
        // GESTIONE GENERAZIONE PDF E SALVATAGGIO FINALE
        // -------------------------------------------------------------------------

        // Gestore principale della generazione (Alunno/Docente)
        window.handleGeneration = async (type, isStudent) => {
            const nome = document.getElementById('nome-studente').value.trim();
            const cognome = document.getElementById('cognome-studente').value.trim();
            const classe = document.getElementById('classe-studente').value.trim();
            const data = document.getElementById('data-verifica').value;
            
            if (!nome || !cognome || !classe || !data) {
                alert("Per favore, inserisci Nome, Cognome, Classe e Data per generare la verifica e il link di correzione.");
                return;
            }
            
            window.showLoading();
            const examData = generateExam(type);
            
            // 1. Salva la verifica su Firestore per ottenere l'ID
            const savedId = await saveExamToDB(examData);
            window.hideLoading();

            if (savedId) {
                // 2. Genera il PDF
                generatePrintHTML(examData, isStudent);
                
                // 3. Aggiorna i link
                await window.updateLinkContainers();
                
                // 4. Stampa/Download
                setTimeout(() => window.print(), 200);
            }
        };

        // Genera l'HTML ottimizzato per la stampa (PDF)
        function generatePrintHTML(exam, isStudent) {
            const printArea = document.getElementById('print-area');
            const date = new Date(exam.meta.data).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });

            // Aggiungi un div per la verifica e il numero di pagina
            const verificationHTML = `
                <div class="print-container">
                    <div class="print-header p-4">
                        <h1 class="text-2xl text-center font-extrabold text-gray-900">VERIFICA DI INFORMATICA - TIPO ${exam.type}</h1>
                        <div class="flex justify-between text-sm mt-2 text-gray-700">
                            <p><strong>DOCENTE:</strong> Prof. G. Borzumati</p>
                            <p><strong>CLASSE:</strong> ${exam.meta.classe}</p>
                            <p><strong>DATA:</strong> ${date}</p>
                        </div>
                        <div class="text-center mt-3 p-2 bg-gray-100 rounded-md border border-gray-300">
                             <p><strong>STUDENTE:</strong> ____________________________________________________________________</p>
                        </div>
                    </div>
                    
                    <p class="px-4 pb-2 text-xs font-semibold text-gray-600">
                        Istruzioni: Riporta la risposta finale negli spazi sottostanti. Non sono ammesse correzioni o cancellature. Punteggio massimo: ${exam.questions.length} Punti.
                    </p>
                    
                    <ol class="print-list list-decimal px-8 pt-2">
                        ${exam.questions.map((q, index) => {
                            const qText = q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                            const solution = !isStudent ? `<div class="solution-box code-font">SOLUZIONE: ${q.correct}</div>` : '';
                            
                            return `
                                <li class="question-item">
                                    <p class="question-text">${qText}</p>
                                    <span class="answer-line"></span>
                                    ${solution}
                                </li>
                            `;
                        }).join('')}
                    </ol>
                    
                    <footer class="text-center text-xs text-gray-500 pt-8 mt-12 border-t border-gray-200">
                        ${isStudent ? `Verifica ${exam.type} per ${exam.meta.cognome} ${exam.meta.nome} | ID Traccia: ${exam.id}` : `SOLUZIONI - Non mostrare agli studenti | ID Traccia: ${exam.id}`}
                    </footer>
                </div>
            `;
            printArea.innerHTML = verificationHTML;
        }

        // Salva i risultati della correzione e genera il PDF finale
        window.saveAndDownloadResultsPDF = async () => {
            if (!currentExamData) return;

            window.showLoading();
            
            // 1. Aggiorna i dati con l'ultima correzione manuale e automatica
            updateTotalPoints(); 
            const totalPoints = currentExamData.questions.filter(q => q.isCorrect).length;
            const oralGrade = parseFloat(document.getElementById('voto-orale').value) || 0;
            const finalGrade = (currentExamData.writtenGrade * 0.7) + (oralGrade * 0.3);
            
            // 2. Aggiungi commenti del docente e voti all'oggetto
            currentExamData.questions = currentExamData.questions.map((q, index) => {
                const commentElement = document.getElementById(`comment-${index + 1}`);
                q.docentComment = commentElement ? commentElement.value.trim() : '';
                q.userAnswer = document.getElementById(`input-${index + 1}`).value.trim(); // Ultima risposta inserita dal docente
                return q;
            });
            
            currentExamData.results = {
                corrected: true,
                totalPoints: totalPoints,
                writtenGrade: currentExamData.writtenGrade.toFixed(2),
                oralGrade: oralGrade.toFixed(1),
                finalGrade: Math.floor(finalGrade)
            };
            
            // 3. Salva i risultati aggiornati su Firestore (merge)
            try {
                const examRef = window.doc(window.db, "exams", currentExamData.id);
                await window.setDoc(examRef, currentExamData);
            } catch (e) {
                console.error("Errore nel salvataggio dei risultati:", e);
                alert("Impossibile salvare i risultati sul database. Procedi con il download, ma il salvataggio √® fallito.");
            }
            
            // 4. Genera l'HTML del PDF dei risultati
            generateResultsPrintHTML(currentExamData);
            
            // 5. Stampa/Download
            window.hideLoading();
            setTimeout(() => window.print(), 200);
        };

        // Genera l'HTML per la stampa dei risultati (voto e commenti)
        function generateResultsPrintHTML(exam) {
            const printArea = document.getElementById('print-area');
            const date = new Date(exam.meta.data).toLocaleDateString('it-IT');

            const resultsHTML = `
                <div class="print-container">
                    <div class="print-header p-4">
                        <h1 class="text-2xl text-center font-extrabold text-green-700">GRIGLIA DI VALUTAZIONE E RISULTATI</h1>
                        <div class="flex justify-between text-sm mt-2 text-gray-700">
                            <p><strong>DOCENTE:</strong> Prof. G. Borzumati</p>
                            <p><strong>CLASSE:</strong> ${exam.meta.classe}</p>
                            <p><strong>DATA:</strong> ${date}</p>
                        </div>
                        <div class="text-center mt-3 p-2 bg-yellow-100 rounded-md border border-yellow-300">
                             <p><strong>STUDENTE:</strong> ${exam.meta.cognome} ${exam.meta.nome}</p>
                        </div>
                    </div>
                    
                    <div class="p-4 mb-4 bg-gray-50 border border-gray-300 rounded-lg grid grid-cols-3 gap-4">
                        <div><p class="text-sm font-semibold">Punti Totali:</p><p class="text-xl font-bold text-blue-600">${exam.results.totalPoints} / 17</p></div>
                        <div><p class="text-sm font-semibold">Voto Scritto (Base 10):</p><p class="text-xl font-bold text-purple-600">${exam.results.writtenGrade}</p></div>
                        <div><p class="text-sm font-semibold">Voto Finale Arrotondato:</p><p class="text-3xl font-extrabold text-red-600">${exam.results.finalGrade}</p></div>
                    </div>

                    <h2 class="text-lg font-bold text-gray-800 border-b pb-1 mt-4">Dettaglio Correzione</h2>
                    
                    <ol class="list-decimal px-8 pt-2">
                        ${exam.questions.map((q, index) => {
                            const isCorrect = q.isCorrect;
                            const qText = q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                            const statusClass = isCorrect ? 'text-green-600' : 'text-red-600';
                            const statusText = isCorrect ? 'CORRETTO (+1)' : 'ERRATO (0)';
                            
                            const commentBlock = q.docentComment ? 
                                `<div class="mt-1 p-2 bg-yellow-50 border-l-4 border-yellow-400 text-xs">${q.docentComment}</div>` : '';
                                
                            return `
                                <li class="question-item ${isCorrect ? 'border-green-500' : 'border-red-500'}">
                                    <p class="text-xs font-semibold ${statusClass}">${statusText}</p>
                                    <p class="question-text text-sm">${qText}</p>
                                    <p class="text-xs mt-1"><strong>Risposta Studente:</strong> ${q.userAnswer || 'N/D'}</p>
                                    <div class="code-font text-xs text-green-800"><strong>Soluzione:</strong> ${q.correct}</div>
                                    ${commentBlock}
                                </li>
                            `;
                        }).join('')}
                    </ol>
                    
                    <footer class="text-center text-xs text-gray-500 pt-8 mt-12 border-t border-gray-200">
                        Griglia Valutazione ${exam.type} per ${exam.meta.cognome} ${exam.meta.nome} | ID Traccia: ${exam.id}
                    </footer>
                </div>
            `;
            printArea.innerHTML = resultsHTML;
        }

        // Inizializza la vista al primo caricamento
        window.addEventListener('load', () => {
            document.getElementById('loading-overlay').classList.remove('hidden');
        });
    </script>
</body>
</html>
