<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Verifiche Informatica - Borzumati</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .code-font { font-family: 'Roboto Mono', monospace; }

        /* Stili per la stampa PDF (ottimizzazione 2 pagine A4) */
        @media print {
            body { font-family: sans-serif !important; font-size: 10pt; }
            body > *:not(.print-container) { display: none !important; }
            .print-container {
                display: block !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                height: auto;
                page-break-after: always;
            }
            @page { margin: 1cm; }
            .print-header h1 { font-size: 16pt !important; }
            .print-header p { font-size: 9pt !important; }
            .print-list { columns: 2; column-gap: 20px; } /* Layout su due colonne */
            .print-list li { break-inside: avoid; margin-bottom: 0.7rem !important; } 
            .print-list p { margin-top: 0.1rem !important; } 
            .print-list span { height: 1.5em !important; }
        }

        /* Stili per i pulsanti animati (Effetto Shine) */
        .action-button {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-weight: 700;
            position: relative;
            overflow: hidden;
        }
        .action-button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
        .action-button::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: skewX(-20deg);
            transition: all 0.7s;
        }
        .action-button:hover::before { left: 100%; }

        /* Gradienti personalizzati per i pulsanti */
        .bg-gradient-blue { background-image: linear-gradient(to right, #2563eb 0%, #3b82f6 100%); }
        .bg-gradient-green { background-image: linear-gradient(to right, #10b981 0%, #059669 100%); }
        .bg-gradient-red { background-image: linear-gradient(to right, #ef4444 0%, #b91c1c 100%); }
        .bg-gradient-gray { background-image: linear-gradient(to right, #4b5563 0%, #6b7280 100%); }

        /* Stili per la vista Correzione */
        .feedback-correct { border: 3px solid #10b981; background-color: #d1fae5; }
        .feedback-wrong { border: 3px solid #ef4444; background-color: #fee2e2; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 sm:p-8">

    <!-- Sezione Dati Studente/Docente e Introduzione -->
    <div id="main-view" class="w-full max-w-7xl mx-auto bg-white rounded-xl shadow-[0_25px_50px_-12px_rgba(0,0,0,0.5)] p-6 sm:p-12 mb-8 space-y-10">
        <header class="text-center pb-6 border-b-4 border-indigo-500">
            <h1 class="text-4xl sm:text-6xl font-black leading-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-purple-600">
                    GENERATORE VERIFICHE INFORMATICA
                </span>
            </h1>
            <p class="text-xl text-gray-700 mt-2">Prof. Giuseppe Borzumati | Argomento: Sistemi di Numerazione & Networking Avanzato</p>
        </header>

        <!-- Dati Studente per la Generazione (Globali) -->
        <div class="bg-indigo-50 p-8 rounded-2xl shadow-inner border border-indigo-200">
            <h2 class="text-2xl font-bold text-indigo-800 mb-5 flex items-center">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 mr-2 text-indigo-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                 </svg>
                Dati Studente per la Verifica
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <input type="text" id="nome-studente" placeholder="Nome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <p class="text-xs text-indigo-500 mt-1">Nome obbligatorio per il link.</p>
                </div>
                <div>
                    <input type="text" id="cognome-studente" placeholder="Cognome" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <p class="text-xs text-indigo-500 mt-1">Cognome obbligatorio per il link.</p>
                </div>
                <div>
                    <input type="text" id="classe-studente" placeholder="Classe (es. 4B)" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <p class="text-xs text-indigo-500 mt-1">Es. 3A, 4B, ecc.</p>
                </div>
                <div>
                    <input type="date" id="data-verifica" value="" class="p-4 border-2 border-indigo-300 rounded-xl w-full focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <p class="text-xs text-indigo-500 mt-1">Data di svolgimento.</p>
                </div>
            </div>
        </div>

        <!-- Contenitore delle Verifiche (4 Blocchi) -->
        <div class="space-y-12">
            
            <!-- BLOCCO 1: Verifiche Numeriche PURE -->
            <div id="blocco-verifica-a" class="p-8 bg-red-50 border-t-8 border-t-red-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-red-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¢</span> VERIFICA A: Base & Operazioni Binarie (Liv. Base)
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Binario, Decimale, Ottale, Esadecimale, Frazioni Binarie, Numeri Romani e Addizione/Moltiplicazione Binaria. **20 Esercizi / 20 Punti**</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="handleGeneration('A')">
                        Genera Link Correzione
                    </button>
                    <button class="flex-1 action-button bg-gradient-gray text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="downloadBlankPDF('A')">
                        Scarica PDF Studente (Vuoto)
                    </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="downloadSolutionPDF('A')">
                        Scarica PDF Docente (Soluzioni)
                    </button>
                </div>
                <div id="link-container-A" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-red-600 border-b border-red-300 pb-1">Link Attivi per Correzione (Verifica A):</h4>
                </div>
            </div>

            <!-- BLOCCO 2: Indirizzamento IP (Subnetting) + Conversione Avanzata -->
            <div id="blocco-verifica-b" class="p-8 bg-purple-50 border-t-8 border-t-purple-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-purple-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üåê</span> VERIFICA B: Networking (ID/Broadcast) e Sistemi di Numerazione
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Subnetting (Network ID, Broadcast ID, Maschera) e mix di conversioni numeriche Basi 2, 8, 10, 16. **20 Esercizi / 20 Punti**</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="handleGeneration('B')">
                        Genera Link Correzione
                    </button>
                    <button class="flex-1 action-button bg-gradient-gray text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="downloadBlankPDF('B')">
                        Scarica PDF Studente (Vuoto)
                    </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="downloadSolutionPDF('B')">
                        Scarica PDF Docente (Soluzioni)
                    </button>
                </div>
                <div id="link-container-B" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-purple-600 border-b border-purple-300 pb-1">Link Attivi per Correzione (Verifica B):</h4>
                </div>
            </div>

            <!-- BLOCCO 3: Complemento a Due, IP e Floating Point -->
            <div id="blocco-verifica-c" class="p-8 bg-teal-50 border-t-8 border-t-teal-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-teal-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üî¨</span> VERIFICA C: Complemento a Due, Floating Point e IP Avanzato
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Rappresentazione in Complemento a Due (8 bit), Esponente/Mantissa e Subnetting complesso. **20 Esercizi / 20 Punti**</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="handleGeneration('C')">
                        Genera Link Correzione
                    </button>
                    <button class="flex-1 action-button bg-gradient-gray text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="downloadBlankPDF('C')">
                        Scarica PDF Studente (Vuoto)
                    </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="downloadSolutionPDF('C')">
                        Scarica PDF Docente (Soluzioni)
                    </button>
                </div>
                <div id="link-container-C" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-teal-600 border-b border-teal-300 pb-1">Link Attivi per Correzione (Verifica C):</h4>
                </div>
            </div>

            <!-- BLOCCO 4: VERIFICA D (MASTER - TUTTO) -->
            <div id="blocco-verifica-d" class="p-8 bg-indigo-50 border-t-8 border-t-indigo-500 rounded-2xl shadow-3xl">
                <h3 class="text-3xl font-bold text-indigo-700 mb-4 flex items-center">
                    <span class="mr-3 text-4xl">üöÄ</span> VERIFICA D: Master (C2, Float, ASCII, Base Identification)
                </h3>
                <p class="text-gray-600 mb-6">Tracce: Include tutti gli argomenti avanzati, pi√π ASCII, Sottrazione Binaria e Identificazione Base. **20 Esercizi / 20 Punti**</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button class="flex-1 action-button bg-gradient-blue text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="handleGeneration('D')">
                        Genera Link Correzione
                    </button>
                    <button class="flex-1 action-button bg-gradient-gray text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="downloadBlankPDF('D')">
                        Scarica PDF Studente (Vuoto)
                    </button>
                    <button class="flex-1 action-button bg-gradient-green text-white py-4 px-4 rounded-xl text-lg" 
                            onclick="downloadSolutionPDF('D')">
                        Scarica PDF Docente (Soluzioni)
                    </button>
                </div>
                <div id="link-container-D" class="mt-6 space-y-3">
                    <h4 class="text-lg font-semibold text-indigo-600 border-b border-indigo-300 pb-1">Link Attivi per Correzione (Verifica D):</h4>
                </div>
            </div>

        </div>

        <footer class="text-center pt-8 text-gray-500 text-sm border-t border-gray-200">
            <p>&copy; Materiale didattico per l'Insegnante Giuseppe Borzumati. Sistema v5.0.</p>
        </footer>
    </div>

    <!-- VISTA DI CORREZIONE/VALUTAZIONE DOCENTE -->
    <div id="correction-view" class="hidden w-full max-w-5xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10 mb-8 space-y-8">
        <header class="text-center pb-4 border-b-4 border-green-500">
            <h1 class="text-4xl font-extrabold text-green-700 leading-tight">Scheda di Valutazione Docente</h1>
            <p class="text-lg text-gray-600 mt-1">Studente: <span id="corr-student-name" class="font-extrabold text-indigo-600"></span> - Verifica <span id="corr-title"></span></p>
        </header>
        
        <!-- Tabella Punteggio e Voto -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 bg-yellow-50 p-6 rounded-xl border-2 border-yellow-300 shadow-lg">
            
            <div class="col-span-1 lg:col-span-3">
                <h2 class="text-2xl font-bold text-yellow-800 mb-2 border-b border-yellow-400 pb-1">Griglia di Valutazione (Punti Max: 20)</h2>
            </div>
            
            <div class="bg-blue-100 p-4 rounded-lg shadow-md col-span-1 lg:col-span-1">
                <p class="text-sm font-semibold text-blue-800">Punti Ottenuti:</p>
                <p class="text-4xl font-extrabold text-blue-600 mt-1"><span id="corr-points">0</span> / 20</p>
            </div>
            
            <div class="bg-red-100 p-4 rounded-lg shadow-md col-span-1 lg:col-span-1">
                <p class="text-sm font-semibold text-red-800">Voto Finale (Base 10, Arrotondato per Difetto):</p>
                <p class="text-4xl font-extrabold text-red-600 mt-1"><span id="corr-grade-floored">0</span> / 10</p>
            </div>

            <div class="bg-purple-100 p-4 rounded-lg shadow-md col-span-1 lg:col-span-1">
                <p class="text-sm font-semibold text-purple-800">Note/Aggiustamento Voto (Solo Informativo):</p>
                <input type="number" id="voto-orale" min="0" max="10" step="0.1" value="0.0" 
                       class="p-2 border-2 border-purple-500 rounded-lg w-full mt-1 text-xl font-bold text-center">
            </div>

            <div class="col-span-1 lg:col-span-3 bg-gray-100 p-4 rounded-lg border border-gray-300" id="conversion-explanation">
                <p class="text-sm font-bold text-gray-700">Il voto finale √® calcolato esclusivamente sul punteggio scritto (20 punti).</p>
                <code class="code-font text-xs block mt-1 p-2 bg-white rounded">
                    Voto Finale Base 10 = (0 / 20) * 10 = 0.00
                </code>
            </div>
        </div>

        <!-- Esercizi con Correzione -->
        <div id="correction-form" class="space-y-6">
            <!-- Gli esercizi e i campi di input saranno popolati qui dal JS -->
        </div>

        <button class="action-button bg-gray-700 hover:bg-gray-800 text-white py-4 px-8 rounded-xl text-lg mt-8 w-full" 
                onclick="promptDownloadResultsPDF()">
            Scarica PDF dei Risultati e Commenti (Richiede Password)
        </button>
        
        <button class="action-button bg-gray-400 hover:bg-gray-500 text-gray-900 py-3 px-6 rounded-lg text-lg w-full" 
                onclick="showMainView()">
            Torna alla Generazione Verifiche
        </button>
    </div>

    <script>
        // -------------------------------------------------------------------------
        // VARIABILI GLOBALI E UTILIT√Ä
        // -------------------------------------------------------------------------

        const STORAGE_KEY = 'borzumati_exams';
        const MAX_POINTS = 20; // Punti effettivi per la valutazione
        const TEACHER_PASSWORD = 'borzumati2025'; // Password per il PDF completo
        const INITIAL_CHAR_CODE = 65; // 'A'

        // Funzione per generare un ID unico
        const generateUniqueID = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
        
        // Funzione per generare un numero binario con parte frazionaria
        function generateBinaryFractional(intBits, fracBits) {
            const integerPart = Math.floor(Math.random() * (Math.pow(2, intBits) - 1)) + 1;
            let fractionalPart = 0;
            for (let i = 0; i < fracBits; i++) {
                if (Math.random() > 0.5) { fractionalPart += Math.pow(2, -(i + 1)); }
            }
            
            let binInteger = integerPart.toString(2);
            let binFractional = '';
            let tempFrac = fractionalPart;
            for (let i = 0; i < fracBits; i++) {
                tempFrac *= 2;
                binFractional += Math.floor(tempFrac);
                tempFrac -= Math.floor(tempFrac);
            }
            
            const decimalValue = integerPart + fractionalPart;
            const binaryValue = binInteger + (binFractional.length > 0 ? '.' + binFractional : '');
            
            return { decimal: parseFloat(decimalValue.toFixed(4)), binary: binaryValue };
        }
        
        // Funzione per calcolare il Complemento a Due (8 bit)
        function toTwosComplement(num) {
            if (num >= 128 || num < -128) return 'Overflow'; // Limite di 8 bit
            if (num < 0) {
                let bin = Math.abs(num).toString(2).padStart(8, '0');
                let inverted = [...bin].map(b => b === '0' ? '1' : '0').join('');
                let carry = 1;
                let twosComp = '';
                for (let i = 7; i >= 0; i--) {
                    let bit = parseInt(inverted[i], 10);
                    let sum = bit + carry;
                    twosComp = (sum % 2) + twosComp;
                    carry = Math.floor(sum / 2);
                }
                return twosComp;
            }
            return num.toString(2).padStart(8, '0');
        }

        // Conversione Decimale a Romano (semplificata fino a 999)
        function decToRoman(num) {
            const map = { 1000: 'M', 900: 'CM', 500: 'D', 400: 'CD', 100: 'C', 90: 'XC', 50: 'L', 40: 'XL', 10: 'X', 9: 'IX', 5: 'V', 4: 'IV', 1: 'I' };
            let roman = '';
            for (let i of Object.keys(map).reverse()) {
                while (num >= parseInt(i)) {
                    roman += map[i];
                    num -= parseInt(i);
                }
            }
            return roman;
        }

        // Calcola l'ID di Network
        function calculateNetworkID(ipBinary, mask) {
            const networkPart = ipBinary.substring(0, mask);
            const hostPart = '0'.repeat(32 - mask);
            const netBinary = networkPart + hostPart;
            
            let netDecimals = [];
            for (let n = 0; n < 4; n++) {
                const octetBinary = netBinary.substring(n * 8, n * 8 + 8);
                netDecimals.push(parseInt(octetBinary, 2));
            }
            return netDecimals.join('.');
        }

        // Calcola l'ID di Broadcast
        function calculateBroadcastID(ipBinary, mask) {
            const networkPart = ipBinary.substring(0, mask);
            const hostPart = '1'.repeat(32 - mask);
            const broadcastBinary = networkPart + hostPart;
            
            let broadcastDecimals = [];
            for (let n = 0; n < 4; n++) {
                const octetBinary = broadcastBinary.substring(n * 8, n * 8 + 8);
                broadcastDecimals.push(parseInt(octetBinary, 2));
            }
            return broadcastDecimals.join('.');
        }

        // Converte CIDR a Maschera Decimale
        function cidrToMask(mask) {
            let binaryMask = '1'.repeat(mask) + '0'.repeat(32 - mask);
            let maskDecimals = [];
            for (let i = 0; i < 4; i++) {
                maskDecimals.push(parseInt(binaryMask.substring(i * 8, i * 8 + 8), 2));
            }
            return maskDecimals.join('.');
        }
        
        // Converte IP Decimale a Binario (32 bit)
        function ipToBinary(ip) {
            return (ip.split('.').map(o => parseInt(o).toString(2).padStart(8, '0'))).join('');
        }
        
        // Floating Point (Single Precision Example - 8 bit Exponent, 14 bit Mantissa)
        function floatToBinary(num) {
            const sign = num < 0 ? 1 : 0;
            const absNum = Math.abs(num);
            const binaryRepresentation = absNum.toString(2);
            
            let exponent;
            let normalizedBinary;

            if (binaryRepresentation.includes('.')) {
                const index = binaryRepresentation.indexOf('.');
                // Spostamento della virgola per normalizzare a 1.M
                exponent = index - 1;
                normalizedBinary = binaryRepresentation.slice(0, index) + binaryRepresentation.slice(index + 1);
            } else {
                exponent = binaryRepresentation.length - 1;
                normalizedBinary = binaryRepresentation;
            }
            
            // Mantissa (escludendo il bit implicito)
            const mantissa = normalizedBinary.substring(1, 15).padEnd(14, '0').substring(0, 14);
            
            // Biased exponent (E+127, ma per semplicit√† usiamo solo E)
            const solution = `${exponent}; ${mantissa}`; 
            
            return { binary: binaryRepresentation, exponent: exponent, mantissa: mantissa, solution: solution };
        }
        
        // Conversione ASCII (Decimal) a Carattere
        function decToChar(dec) {
            return String.fromCharCode(dec);
        }
        
        // Conversione ASCII (Carattere) a Binario
        function charToBinary(char) {
            return char.charCodeAt(0).toString(2).padStart(8, '0');
        }

        // -------------------------------------------------------------------------
        // LOGICA DI GENERAZIONE ESERCIZI
        // -------------------------------------------------------------------------

        function generateExam(type) {
            let questions = [];
            
            // Tipi di conversione base per Verifica A, B, C
            const conversionTypes = [
                { from: 10, to: 2, bits: 10 }, { from: 2, to: 10, bits: 10 }, 
                { from: 8, to: 16, bits: 12 }, { from: 16, to: 8, bits: 12 }, 
                { from: 2, to: 16, bits: 16 }, { from: 16, to: 2, bits: 16 }, 
                { from: 10, to: 8, bits: 10 }, { from: 8, to: 10, bits: 10 }
            ];

            // Funzione helper per creare una conversione semplice
            const createSimpleConversion = (cType) => {
                let numDec, numInput;
                const minVal = 64; 
                numDec = Math.floor(Math.random() * (Math.pow(2, cType.bits) - minVal)) + minVal;
                
                if (cType.from === 10) numInput = numDec;
                else if (cType.from === 2) numInput = numDec.toString(2);
                else if (cType.from === 8) numInput = numDec.toString(8);
                else if (cType.from === 16) numInput = numDec.toString(16).toUpperCase();

                let solution;
                if (cType.to === 10) solution = numDec.toString();
                else if (cType.to === 2) solution = numDec.toString(2);
                else if (cType.to === 8) solution = numDec.toString(8);
                else if (cType.to === 16) solution = numDec.toString(16).toUpperCase();

                const labelFrom = cType.from === 10 ? "Decimale (base 10)" : cType.from === 2 ? "Binario (base 2)" : cType.from === 8 ? "Ottale (base 8)" : "Esadecimale (base 16)";
                const labelTo = cType.to === 10 ? "DECIMALE (base 10)" : cType.to === 2 ? "BINARIO (base 2)" : cType.to === 8 ? "OTTALE (base 8)" : "ESADECIMALE (base 16)";

                const questionText = `CONVERTI il numero ${labelFrom}: **${numInput}** in ${labelTo}.`;
                return { type: 'conversion', text: questionText, base: cType.to, correct: solution };
            };
            
            // GENERAZIONE ESERCIZI BASE (Comune)
            for (let k = 0; k < 8; k++) {
                questions.push(createSimpleConversion(conversionTypes[k]));
            }

            // Aggiungi esercizi specifici per tipo
            switch(type) {
                case 'A':
                    // Conversione base A (10x)
                    for (let k = 8; k < 12; k++) questions.push(createSimpleConversion(conversionTypes[k % conversionTypes.length]));

                    // Frazioni (3x)
                    for (let j = 0; j < 3; j++) {
                        const fracNum = generateBinaryFractional(5, 5);
                        const solution = fracNum.decimal.toFixed(2);
                        const questionText = `Dato il numero binario con la virgola **${fracNum.binary}**, calcola il suo equivalente in Base DECIMALE. Fornisci il risultato con due cifre decimali, separatore decimale punto (es. 12.75).`;
                        questions.push({ type: 'fraction', text: questionText, base: 10, correct: solution });
                    }
                    // Operazioni Binarie (3x: 2+, 1*)
                    for (let j = 0; j < 3; j++) {
                        const op = j === 0 || j === 1 ? '+' : '*';
                        const num1Dec = Math.floor(Math.random() * 20) + 10;
                        const num2Dec = Math.floor(Math.random() * 8) + 2;
                        const num1Bin = num1Dec.toString(2);
                        const num2Bin = num2Dec.toString(2).padStart(num1Bin.length, '0');
                        
                        let resultDec;
                        if (op === '+') resultDec = num1Dec + num2Dec;
                        if (op === '*') resultDec = num1Dec * num2Dec;
                        const solution = resultDec.toString(2);

                        const questionText = `Esegui l'operazione binaria di ${op === '+' ? 'ADDIZIONE' : 'MOLTIPLICAZIONE'} tra **${num1Bin}** e **${num2Bin}**. Fornisci il risultato in Binario.`;
                        questions.push({ type: 'operation', text: questionText, base: 2, correct: solution });
                    }
                    // Romano (2x)
                    for (let j = 0; j < 2; j++) {
                        const num = Math.floor(Math.random() * 999) + 1;
                        const solution = decToRoman(num);
                        const questionText = `CONVERTI IL NUMERO DECIMALE **${num}** IN NUMERO ROMANO.`;
                        questions.push({ type: 'roman', text: questionText, base: 'ROM', correct: solution });
                    }
                    // Riempi con conversioni semplici
                    while (questions.length < MAX_POINTS) questions.push(createSimpleConversion(conversionTypes[Math.floor(Math.random() * conversionTypes.length)]));

                    break;
                
                case 'B':
                    // Conversioni base B (10x)
                    for (let k = 8; k < 12; k++) questions.push(createSimpleConversion(conversionTypes[k % conversionTypes.length]));
                    
                    // IP Subnetting (4x)
                    for (let j = 0; j < 4; j++) {
                        const oct1 = 192 + Math.floor(Math.random() * 10);
                        const oct2 = Math.floor(Math.random() * 256);
                        const oct3 = Math.floor(Math.random() * 256);
                        const oct4 = Math.floor(Math.random() * 256);
                        const mask = 24 + Math.floor(Math.random() * 5); 
                        const ip = `${oct1}.${oct2}.${oct3}.${oct4}`;
                        const ipBin = ipToBinary(ip);

                        if (j % 3 === 0) { // Network ID
                            const networkID = calculateNetworkID(ipBin, mask);
                            const solution = `${networkID}/${mask}`;
                            const questionText = `Dato l'indirizzo IP: **${ip}/${mask}**, determina l'indirizzo di Rete (Network ID) in formato decimale con la maschera.`;
                            questions.push({ type: 'ip_net', text: questionText, base: 'IP', correct: solution });
                        } else if (j % 3 === 1) { // Broadcast ID
                            const broadcastID = calculateBroadcastID(ipBin, mask);
                            const solution = `${broadcastID}/${mask}`;
                            const questionText = `Dato l'indirizzo IP: **${ip}/${mask}**, determina l'indirizzo di Broadcast (Broadcast ID) in formato decimale con la maschera.`;
                            questions.push({ type: 'ip_broadcast', text: questionText, base: 'IP', correct: solution });
                        } else { // Subnet Mask
                            const solution = cidrToMask(mask);
                            const questionText = `Dato il prefisso CIDR **/${mask}**, scrivi la Subnet Mask in notazione decimale puntata.`;
                            questions.push({ type: 'ip_mask', text: questionText, base: 'MASK', correct: solution });
                        }
                    }

                    // Frazioni (2x)
                    for (let j = 0; j < 2; j++) {
                        const fracNum = generateBinaryFractional(5, 5);
                        const solution = fracNum.decimal.toFixed(2);
                        const questionText = `Dato il binario frazionario **${fracNum.binary}**, converti in Base 10 (2 cifre decimali).`;
                        questions.push({ type: 'fraction', text: questionText, base: 10, correct: solution });
                    }

                    // Operazioni (2x: 1+, 1*)
                    for (let j = 0; j < 2; j++) {
                        const op = j === 0 ? '+' : '*';
                        const num1Dec = Math.floor(Math.random() * 20) + 10;
                        const num2Dec = Math.floor(Math.random() * 8) + 2;
                        const num1Bin = num1Dec.toString(2);
                        const num2Bin = num2Dec.toString(2).padStart(num1Bin.length, '0');
                        
                        let resultDec;
                        if (op === '+') resultDec = num1Dec + num2Dec;
                        if (op === '*') resultDec = num1Dec * num2Dec;
                        const solution = resultDec.toString(2);

                        const questionText = `Esegui l'operazione binaria di ${op === '+' ? 'ADDIZIONE' : 'MOLTIPLICAZIONE'} tra **${num1Bin}** e **${num2Bin}**.`;
                        questions.push({ type: 'operation', text: questionText, base: 2, correct: solution });
                    }

                    // Riempi
                    while (questions.length < MAX_POINTS) questions.push(createSimpleConversion(conversionTypes[Math.floor(Math.random() * conversionTypes.length)]));
                    
                    break;

                case 'C':
                    // Conversioni base C (6x)
                    for (let k = 8; k < 12; k++) questions.push(createSimpleConversion(conversionTypes[k % conversionTypes.length]));

                    // IP Subnetting (4x)
                    for (let j = 0; j < 4; j++) {
                        const oct1 = 192 + Math.floor(Math.random() * 10);
                        const oct2 = Math.floor(Math.random() * 256);
                        const oct3 = Math.floor(Math.random() * 256);
                        const oct4 = Math.floor(Math.random() * 256);
                        const mask = 24 + Math.floor(Math.random() * 5); 
                        const ip = `${oct1}.${oct2}.${oct3}.${oct4}`;
                        const ipBin = ipToBinary(ip);

                        if (j % 2 === 0) {
                            const networkID = calculateNetworkID(ipBin, mask);
                            const solution = `${networkID}/${mask}`;
                            const questionText = `Dato l'indirizzo IP: **${ip}/${mask}**, determina l'indirizzo di Rete.`;
                            questions.push({ type: 'ip_net', text: questionText, base: 'IP', correct: solution });
                        } else { 
                            const broadcastID = calculateBroadcastID(ipBin, mask);
                            const solution = `${broadcastID}/${mask}`;
                            const questionText = `Dato l'indirizzo IP: **${ip}/${mask}**, determina l'indirizzo di Broadcast.`;
                            questions.push({ type: 'ip_broadcast', text: questionText, base: 'IP', correct: solution });
                        }
                    }

                    // Complemento a Due (4x: 2+, 2-)
                    for (let j = 0; j < 4; j++) {
                        const sign = j < 2 ? 1 : -1;
                        const numDec = Math.floor(Math.random() * 127) + 1;
                        const numSigned = numDec * sign;
                        const solution = toTwosComplement(numSigned);
                        const questionText = `Rappresenta il numero decimale **${numSigned}** in Complemento a Due (8 bit).`;
                        questions.push({ type: 'twos_complement', text: questionText, base: 'BIN', correct: solution });
                    }
                    
                    // Floating Point (4x)
                    for (let j = 0; j < 4; j++) {
                        const numDec = (Math.random() * 30) + 1.0; 
                        const floatData = floatToBinary(numDec);
                        const questionText = `Dato il numero decimale **${numDec.toFixed(3)}**, indicalo in Notazione Scientifica Binaria (Forma Normalizzata 1.M * 2^E) e fornisci solo l'Esponente (E) e i primi 14 bit della Mantissa (M), separati da un punto e virgola (E; M).`;
                        questions.push({ type: 'float', text: questionText, base: 'E; M', correct: floatData.solution });
                    }

                    // Riempi
                    while (questions.length < MAX_POINTS) questions.push(createSimpleConversion(conversionTypes[Math.floor(Math.random() * conversionTypes.length)]));

                    break;

                case 'D':
                    // Conversione Complesse (4x)
                    for (let k = 0; k < 4; k++) questions.push(createSimpleConversion(conversionTypes[k % conversionTypes.length]));

                    // IP (3x)
                    for (let j = 0; j < 3; j++) {
                        const oct1 = 192 + Math.floor(Math.random() * 10);
                        const oct2 = Math.floor(Math.random() * 256);
                        const oct3 = Math.floor(Math.random() * 256);
                        const oct4 = Math.floor(Math.random() * 256);
                        const mask = 25 + Math.floor(Math.random() * 4); 
                        const ip = `${oct1}.${oct2}.${oct3}.${oct4}`;
                        const ipBin = ipToBinary(ip);

                        if (j % 3 === 0) { // Network ID
                            const networkID = calculateNetworkID(ipBin, mask);
                            const solution = `${networkID}/${mask}`;
                            const questionText = `Dato l'indirizzo IP: **${ip}/${mask}**, determina l'indirizzo di Rete.`;
                            questions.push({ type: 'ip_net', text: questionText, base: 'IP', correct: solution });
                        } else if (j % 3 === 1) { // Broadcast ID
                            const broadcastID = calculateBroadcastID(ipBin, mask);
                            const solution = `${broadcastID}/${mask}`;
                            const questionText = `Dato l'indirizzo IP: **${ip}/${mask}**, determina l'indirizzo di Broadcast.`;
                            questions.push({ type: 'ip_broadcast', text: questionText, base: 'IP', correct: solution });
                        } else { // Subnet Mask
                            const solution = cidrToMask(mask);
                            const questionText = `Dato il prefisso CIDR **/${mask}**, scrivi la Subnet Mask decimale.`;
                            questions.push({ type: 'ip_mask', text: questionText, base: 'MASK', correct: solution });
                        }
                    }

                    // Complemento a Due (2x)
                    for (let j = 0; j < 2; j++) {
                        const sign = j < 1 ? 1 : -1;
                        const numDec = Math.floor(Math.random() * 127) + 1;
                        const numSigned = numDec * sign;
                        const solution = toTwosComplement(numSigned);
                        const questionText = `Rappresenta il decimale **${numSigned}** in Complemento a Due (8 bit).`;
                        questions.push({ type: 'twos_complement', text: questionText, base: 'BIN', correct: solution });
                    }
                    
                    // NEW: Subtraction (1x)
                    {
                        const num1Dec = Math.floor(Math.random() * 40) + 10;
                        const num2Dec = Math.floor(Math.random() * 20) + 5;
                        const num1Bin = num1Dec.toString(2);
                        const num2Bin = num2Dec.toString(2).padStart(num1Bin.length, '0');
                        const resultDec = num1Dec - num2Dec;
                        
                        // Per il risultato, il complemento a due per i negativi non √® necessario, basta il binario positivo
                        const solution = resultDec.toString(2); 

                        const questionText = `Esegui la sottrazione binaria **${num1Bin} - ${num2Bin}** utilizzando il Complemento a Due del sottraendo. Fornisci il risultato in Binario.`;
                        questions.push({ type: 'subtraction', text: questionText, base: 2, correct: solution });
                    }

                    // Floating Point (3x: 2x Normal, 1x Reverse)
                    for (let j = 0; j < 3; j++) {
                        if (j < 2) {
                            const numDec = (Math.random() * 30) + 1.0; 
                            const floatData = floatToBinary(numDec);
                            const questionText = `Dato il decimale **${numDec.toFixed(3)}**, fornisci Esponente (E) e i primi 14 bit della Mantissa (M) (formato E; M).`;
                            questions.push({ type: 'float', text: questionText, base: 'E; M', correct: floatData.solution });
                        } else {
                             // Reverse Floating Point (Man: 1.M * 2^E)
                            const exp = Math.floor(Math.random() * 5) + 1; // 1 a 5
                            const manDec = Math.random() * 0.9 + 1; // 1.xxxx
                            const numDec = manDec * Math.pow(2, exp);
                            
                            // Per la soluzione, usiamo solo il decimale (pi√π facile da verificare)
                            const solution = numDec.toFixed(3);
                            
                            // Costruiamo la Mantissa M (dopo l'1.)
                            const binary = manDec.toString(2);
                            const M_part = binary.substring(binary.indexOf('.') + 1, binary.indexOf('.') + 1 + 14).padEnd(14, '0');

                            const questionText = `Un numero √® rappresentato in Floating Point (Normalizzato) con Esponente E = **${exp}** e Mantissa M = **${M_part}**. Calcola il valore decimale. (3 cifre decimali, separatore punto).`;
                            questions.push({ type: 'float_reverse', text: questionText, base: 10, correct: solution });
                        }
                    }

                    // ASCII (2x)
                    {
                        const charDec = Math.floor(Math.random() * (90 - 65 + 1)) + 65; // A-Z
                        const char = decToChar(charDec);
                        const solutionBin = charToBinary(char);
                        const questionText = `Qual √® la rappresentazione binaria (8 bit) del carattere **${char}** (Codice ASCII)?`;
                        questions.push({ type: 'ascii_bin', text: questionText, base: 2, correct: solutionBin });
                    }
                    {
                        const string = "ProfB";
                        const charIndex = Math.floor(Math.random() * string.length);
                        const char = string[charIndex];
                        const solutionDec = char.charCodeAt(0).toString();
                        const questionText = `Qual √® il valore decimale (Codice ASCII) del carattere **${char}**?`;
                        questions.push({ type: 'ascii_dec', text: questionText, base: 10, correct: solutionDec });
                    }

                    // NEW: Base Identification (2x)
                    for (let j = 0; j < 2; j++) {
                        const targetBase = Math.random() > 0.5 ? 8 : 16;
                        const numDec = Math.floor(Math.random() * 255) + 10;
                        const numInBase = numDec.toString(targetBase).toUpperCase();
                        
                        // Formato richiesto: BASE; NUMERO_DECIMALE
                        const solution = `${targetBase}; ${numDec}`; 
                        const questionText = `Identifica la base 'b' e converti il numero in decimale: **${numInBase}$$_b$$ = ?$$_ {10}$$**. Rispondi nel formato: BASE; NUMERO_DECIMALE.`;
                        questions.push({ type: 'base_id', text: questionText, base: 'BASE; 10', correct: solution });
                    }

                    // Frazioni (2x)
                    for (let j = 0; j < 2; j++) {
                        const fracNum = generateBinaryFractional(4, 4);
                        const solution = fracNum.decimal.toFixed(3);
                        const questionText = `Dato il binario frazionario **${fracNum.binary}**, converti in Base 10 (3 cifre decimali).`;
                        questions.push({ type: 'fraction', text: questionText, base: 10, correct: solution });
                    }
                    
                    // Riempi con conversioni semplici
                    while (questions.length < MAX_POINTS) questions.push(createSimpleConversion(conversionTypes[Math.floor(Math.random() * conversionTypes.length)]));

                    break;
            }
            
            // Assicurati che siano esattamente 20 (non dovrebbero esserci problemi con la logica sopra, ma √® una sicurezza)
            questions = questions.slice(0, MAX_POINTS);

            return {
                questions: questions.map(q => ({...q, userAnswer: ''})),
                type: type,
                timestamp: Date.now(),
                id: generateUniqueID(),
                studentData: getStudentData() 
            };
        }

        // -------------------------------------------------------------------------
        // GESTIONE CORREZIONE E FEEDBACK
        // -------------------------------------------------------------------------

        let currentExamData = null; 

        // Genera il commento didattico in base all'errore
        function generateComment(qType, base) {
            if (qType === 'base_id') return "Verifica i possibili valori che pu√≤ assumere una cifra in quella base. La risposta deve essere BASE; NUMERO_DECIMALE.";
            if (qType === 'fraction') return "Verifica la formula: moltiplica il numero binario per le potenze negative di 2 (2‚Åª¬π, 2‚Åª¬≤, ecc.) dopo la virgola e presta attenzione all'arrotondamento.";
            if (qType === 'twos_complement') return "Complemento a Due: 1. Converti il modulo in binario (8 bit). 2. Inverti. 3. Somma 1.";
            if (qType === 'subtraction') return "Sottrazione in binario: Esegui l'addizione con il Complemento a Due del sottraendo. Ignora il riporto finale se presente.";
            if (qType.startsWith('ip_')) return "Controlla l'AND logico con la maschera per il Network ID o l'impostazione degli bit host a '1' per il Broadcast ID.";
            if (qType === 'float' || qType === 'float_reverse') return "Floating Point: La Mantissa (M) √® la parte dopo l'1. implicito (1.M). L'Esponente (E) √® lo spostamento della virgola. Controlla il formato richiesto (E; M) o l'arrotondamento decimale.";
            if (qType.startsWith('ascii_')) return "Codice ASCII: Ricorda che ogni carattere ha un suo valore numerico (Decimale) che pu√≤ essere convertito in Binario (8 bit).";
            if (qType === 'roman') return "Attenzione alla regola della sottrazione (IV, IX, XL, XC, ecc.) e all'ordine delle lettere.";
            return "Rivedi la metodologia di conversione tra le basi. Controlla di non aver inserito spazi o caratteri non necessari.";
        }

        // Verifica la risposta in tempo reale e fornisce feedback
        function checkAnswer(qNum) {
            const inputElement = document.getElementById(`answer-${qNum}`);
            const feedbackElement = document.getElementById(`feedback-${qNum}`);
            const commentElement = document.getElementById(`comment-${qNum}`);
            
            feedbackElement.className = 'mt-2 sm:mt-0 p-2 rounded-lg text-sm font-bold w-full sm:w-64 transition-all duration-200';
            
            const userAnswer = inputElement.value.trim().toUpperCase();
            const questionData = currentExamData.questions[qNum - 1];
            const correctAnswer = questionData.correct.toUpperCase();

            // Salva la risposta dello studente in tempo reale nell'oggetto dati
            questionData.userAnswer = userAnswer;
            
            // Funzione per pulire la risposta (rimuove spazi, accenti, ecc.)
            const clean = (s) => s.replace(/[^A-Z0-9\.\/\;\-\+\s]/g, '').replace(/\s+/g, '').toUpperCase();
            
            let isCorrect = false;
            let commentText = '';

            if (userAnswer === '') {
                feedbackElement.classList.add('border', 'border-yellow-400', 'bg-yellow-100', 'text-gray-700');
                feedbackElement.innerHTML = 'In attesa di risposta... (0 Punti)';
                commentText = `<span class="font-bold text-gray-700">Commento Docente:</span> Risposta ancora non inserita.`;
            } else if (clean(userAnswer) === clean(correctAnswer)) {
                isCorrect = true;
                feedbackElement.classList.add('feedback-correct', 'text-green-800');
                feedbackElement.innerHTML = '‚úÖ Risposta **CORRETTA**! (1 Punto)';
                commentText = `<span class="font-bold text-gray-700">Commento Docente:</span> Ottimo lavoro! La risposta corretta era **${correctAnswer}**.`;
            } else {
                feedbackElement.classList.add('feedback-wrong', 'text-red-800');
                feedbackElement.innerHTML = '‚ùå Risposta **ERRATA**. (0 Punti)';
                commentText = `<span class="font-bold text-gray-700">Commento Docente:</span> Risposta errata. La soluzione √® **${correctAnswer}**. ${generateComment(questionData.type, questionData.base)}`;
            }

            // Aggiorna il commento
            commentElement.innerHTML = commentText;

            // Aggiorna il punteggio globale
            updateFinalGrade();
        }

        // -------------------------------------------------------------------------
        // GESTIONE VISTE E DOWNLOAD PDF
        // -------------------------------------------------------------------------
        
        // Raccolta risultati (usato da updateFinalGrade e downloadResultsPDF)
        function gatherFinalResults() {
            let correctCount = 0;
            const resultsArray = [];

            currentExamData.questions.forEach((q, index) => {
                const qNum = index + 1;
                const isCorrect = (q.userAnswer.trim().toUpperCase() === q.correct.toUpperCase());
                correctCount += isCorrect ? 1 : 0;
                
                let commentText;
                if (q.userAnswer.trim() === '') {
                    commentText = 'Risposta non fornita. Esercizio non valutato.';
                } else if (isCorrect) {
                    commentText = `Risposta esatta. Ben fatto!`;
                } else {
                    commentText = `Risposta errata. La soluzione corretta √® **${q.correct}**. ${generateComment(q.type, q.base)}`;
                }

                resultsArray.push({
                    qNum: qNum,
                    isCorrect: isCorrect,
                    userAnswer: q.userAnswer || 'N.D.',
                    comment: commentText
                });
            });

            const gradeVerification = (correctCount / MAX_POINTS) * 10;
            const finalGradeFloored = Math.floor(gradeVerification);
            const votoOrale = document.getElementById('voto-orale') ? parseFloat(document.getElementById('voto-orale').value) : 0; // Solo per le note

            return {
                gradeFloored: finalGradeFloored.toFixed(0),
                gradeUnrounded: gradeVerification.toFixed(2),
                points: correctCount,
                maxPoints: MAX_POINTS,
                writtenGrade: gradeVerification.toFixed(2),
                votoOrale: votoOrale.toFixed(1),
                writtenFormula: `Voto Finale Base 10 = (${correctCount} / ${MAX_POINTS}) * 10 = ${gradeVerification.toFixed(2)}`,
                results: resultsArray,
                studentName: currentExamData.studentData.nome + ' ' + currentExamData.studentData.cognome,
                examType: currentExamData.type,
                examDate: currentExamData.studentData.data,
                studentClass: currentExamData.studentData.classe
            };
        }

        function updateFinalGrade() {
            const results = gatherFinalResults();

            document.getElementById('corr-points').textContent = results.points;
            document.getElementById('corr-grade-floored').textContent = results.gradeFloored;
            
            document.querySelector('#conversion-explanation code').innerHTML = results.writtenFormula;
            
            // Aggiorna lo stato dei dati nell'URL (per salvare le risposte dell'alunno se il docente ricarica)
            const encodedExam = btoa(JSON.stringify(currentExamData));
            window.location.hash = `examData=${encodedExam}`;
        }
        
        function getStudentData() {
            const nome = document.getElementById('nome-studente').value.trim();
            const cognome = document.getElementById('cognome-studente').value.trim();
            const classe = document.getElementById('classe-studente').value.trim();
            const data = document.getElementById('data-verifica').value;
            return { nome, cognome, classe, data };
        }

        // Inizializza la vista in base all'URL (se √® un link condivisibile)
        function initApp() {
            const hash = window.location.hash;
            if (hash.startsWith('#examData=')) {
                try {
                    const encodedData = hash.substring(10);
                    const examJson = atob(encodedData);
                    const exam = JSON.parse(examJson);
                    
                    currentExamData = exam;
                    showCorrectionView();
                } catch (e) {
                    console.error("Errore nel caricamento dei dati dall'URL. Ritorno alla vista principale.", e);
                    showMainView();
                }
            } else {
                updateLinkContainers();
                showMainView();
            }

            // Imposta la data di default
            const dateInput = document.getElementById('data-verifica');
            if (dateInput.value === "") {
                dateInput.value = new Date().toISOString().substring(0, 10);
            }
        }

        function showCorrectionView() {
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('correction-view').classList.remove('hidden');
            
            document.getElementById('corr-title').textContent = currentExamData.type;
            document.getElementById('corr-student-name').textContent = `${currentExamData.studentData.nome} ${currentExamData.studentData.cognome}`;

            populateCorrectionForm(currentExamData.questions);
            updateFinalGrade();
        }

        function showMainView() {
            window.location.hash = ''; 
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('correction-view').classList.add('hidden');
        }

        // Popola la griglia di correzione
        function populateCorrectionForm(questions) {
            const formContainer = document.getElementById('correction-form');
            formContainer.innerHTML = '';
            
            questions.forEach((q, index) => {
                const qNum = index + 1;
                
                const questionBlock = document.createElement('div');
                questionBlock.className = 'bg-white p-4 rounded-xl shadow-lg border border-gray-200';
                questionBlock.innerHTML = `
                    <p class="font-bold text-lg text-gray-800 mb-3">${qNum}. ${q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                    
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <input type="text" id="answer-${qNum}" 
                               class="answer-input p-3 border-2 border-gray-300 rounded-lg flex-1 code-font text-lg focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="Risposta in Base ${q.base}..."
                               value="${q.userAnswer || ''}"
                               oninput="checkAnswer(${qNum})">
                        
                        <div id="feedback-${qNum}" class="mt-2 sm:mt-0 p-2 rounded-lg text-sm font-bold w-full sm:w-64 border transition-all duration-200">
                             In attesa... (0 Punti)
                        </div>
                    </div>
                    <div id="comment-${qNum}" class="text-xs text-gray-600 mt-2 p-2 bg-gray-50 rounded-lg">
                        <span class="font-bold text-gray-700">Commento Docente:</span>
                        Il commento apparir√† dopo aver inserito e verificato la risposta.
                    </div>
                `;
                formContainer.appendChild(questionBlock);
            });
            
            // Verifica le risposte precaricate
            questions.forEach((q, index) => {
                if (q.userAnswer) {
                    checkAnswer(index + 1);
                }
            });
        }

        // -------------------------------------------------------------------------
        // GESTIONE LINK E UI
        // -------------------------------------------------------------------------
        
        function handleGeneration(type) {
            const data = getStudentData();

            if (!data.nome || !data.cognome) {
                alert('Attenzione: Inserisci NOME e COGNOME dello studente per generare il PDF e il link condivisibile.');
                return;
            }

            // Genera i dati (lo fa una sola volta e li memorizza per il link)
            const exam = generateExam(type);
            
            let exams = loadExams();
            exams[type].unshift(exam); 
            saveExams(exams);

            alert(`Dati verifica ${type} per ${data.nome} ${data.cognome} generati e link di correzione attivo!`);
            // Non faccio window.print() qui, i PDF vanno scaricati a parte.
        }

        function loadExams() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : { A: [], B: [], C: [], D: [] };
            } catch (e) {
                console.error("Errore nel caricamento da localStorage", e);
                return { A: [], B: [], C: [], D: [] };
            }
        }
        function saveExams(exams) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(exams));
                updateLinkContainers();
            } catch (e) {
                console.error("Errore nel salvataggio su localStorage", e);
            }
        }

        function updateLinkContainers() {
            const exams = loadExams();
            
            ['A', 'B', 'C', 'D'].forEach(type => {
                const container = document.getElementById(`link-container-${type}`);
                const typeColor = type === 'A' ? 'red' : type === 'B' ? 'purple' : type === 'C' ? 'teal' : 'indigo';
                
                container.innerHTML = `<h4 class="text-lg font-semibold text-${typeColor}-600 border-b border-${typeColor}-300 pb-1">Link Attivi per Correzione (Verifica ${type}):</h4>`;

                if (!exams[type] || exams[type].length === 0) {
                    container.innerHTML += `<p class="text-sm text-gray-500 mt-2">Nessuna verifica ${type} generata.</p>`;
                    return;
                }

                exams[type].forEach((exam) => {
                    const studentName = `${exam.studentData.nome} ${exam.studentData.cognome}`;
                    
                    const encodedExam = btoa(JSON.stringify(exam));
                    const shareableLink = `${window.location.origin}${window.location.pathname}#examData=${encodedExam}`;
                    
                    const linkHTML = `
                        <div class="flex items-center space-x-2 p-2 bg-gray-50 border border-${typeColor}-200 rounded-lg">
                            <a href="${shareableLink}" target="_blank"
                               class="flex-1 text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors truncate">
                                üîë Correzione Verifica ${type} - ${studentName} (${new Date(exam.timestamp).toLocaleDateString()})
                            </a>
                            <button onclick="copyToClipboard('${shareableLink}')" 
                                    class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-2 rounded">
                                Copia Link
                            </button>
                            <button onclick="removeExam('${type}', '${exam.id}')"
                                    class="text-xs bg-red-100 hover:bg-red-200 text-red-700 py-1 px-2 rounded">
                                X
                            </button>
                        </div>
                    `;
                    container.innerHTML += linkHTML;
                });
            });
        }
        
        function removeExam(type, id) {
            let exams = loadExams();
            exams[type] = exams[type].filter(exam => exam.id !== id);
            saveExams(exams);
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                // Use a custom alert for better UI/UX
                alert('Link copiato negli appunti! Condividilo con lo studente per la correzione.');
            } catch (err) {
                console.error('Impossibile copiare il testo', err);
            }
            document.body.removeChild(textarea);
        }
        
        // -------------------------------------------------------------------------
        // DOWNLOAD AUTOMATICO PDF (BLANK/SOLUTION/RESULTS)
        // -------------------------------------------------------------------------

        // Funzione per il download automatico del file
        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Scarica PDF VUOTO (STUDENTE) dalla vista principale
        function downloadBlankPDF(type) {
            const exams = loadExams();
            const exam = exams[type]?.[0]; // Prende l'ultima verifica generata
            
            if (!exam) {
                alert('Genera prima una verifica e un link per poter scaricare il PDF.');
                return;
            }

            const examTitle = type === 'A' ? 'Sistemi di Numerazione' :
                              type === 'B' ? 'IP e Sistemi Numerici' : 
                              type === 'C' ? 'Complemento a Due e Floating Point' : 
                              'Master: C2, Float, ASCII, Base ID';

            const pdfHTML = createPDFContent(type, exam.studentData, exam.questions, true, examTitle);
            
            const fileName = `Verifica_Studente_${type}_${exam.studentData.cognome}_${exam.studentData.nome}.html`;
            downloadFile(pdfHTML, fileName, 'text/html');
            alert(`Download del file "${fileName}" completato. Aprirlo e stamparlo per la verifica!`);
        }
        
        // Scarica PDF CON SOLUZIONI (DOCENTE) dalla vista principale
        function downloadSolutionPDF(type) {
            const exams = loadExams();
            const exam = exams[type]?.[0]; 

            if (!exam) {
                alert('Genera prima una verifica e un link per poter scaricare il PDF.');
                return;
            }

            const examTitle = type === 'A' ? 'Sistemi di Numerazione' :
                              type === 'B' ? 'IP e Sistemi Numerici' : 
                              type === 'C' ? 'Complemento a Due e Floating Point' : 
                              'Master: C2, Float, ASCII, Base ID';

            const pdfHTML = createPDFContent(type, exam.studentData, exam.questions, false, examTitle);
            
            const fileName = `Verifica_Docente_Soluzioni_${type}_${exam.studentData.cognome}_${exam.studentData.nome}.html`;
            downloadFile(pdfHTML, fileName, 'text/html');
            alert(`Download del file "${fileName}" completato. Aprirlo e stamparlo per la verifica!`);
        }

        // Funzione ottimizzata per il layout a 2 pagine di stampa
        function createPDFContent(type, data, questions, isStudent, examTitle) {
            const solutionListHTML = questions.map((q, index) => {
                // Sostituisci i campi da compilare con una linea per lo studente
                const qText = q.text.replace(/\*\*(.*?)\*\*/g, '<u class="font-bold text-gray-900">$1</u>');
                
                const answerArea = isStudent 
                    ? `<span class="border-b-2 border-dashed border-gray-400 w-full inline-block h-6 mt-1"></span>`
                    : `<p class="mt-0.5 text-xs font-bold text-green-700">SOLUZIONE: ${q.correct}</p>`;
                    
                return `
                    <li class="font-normal text-sm">
                        ${qText}
                        <div class="mt-0.5 pb-0">
                            ${answerArea}
                        </div>
                    </li>
                `;
            }).join('');

            const headerStyle = isStudent 
                ? 'border-blue-600 bg-blue-50 text-blue-900' 
                : 'border-green-600 bg-green-50 text-green-900';
            const headerText = isStudent ? 'STUDENTE' : 'DOCENTE - SOLUZIONI';

            return `
                <html>
                <head>
                    <title>Verifica ${type} - ${isStudent ? data.nome + ' ' + data.cognome : 'Soluzioni'}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
                        body { 
                            font-family: 'Inter', sans-serif; 
                            font-size: 11pt; 
                            margin: 0; 
                            padding: 0; 
                            background: #fff;
                            color: #1f2937;
                        }
                        .container { 
                            max-width: 21cm; 
                            margin: 0 auto; 
                            padding: 1cm;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 20px; 
                            padding-bottom: 10px; 
                            border-bottom: 4px solid #3b82f6; 
                            border-radius: 5px;
                        }
                        .header h1 { 
                            font-size: 18pt; 
                            font-weight: 900;
                            color: ${isStudent ? '#1e40af' : '#047857'};
                        }
                        .header p { 
                            font-size: 10pt; 
                            color: #4b5563; 
                            margin-top: 5px;
                        }
                        .data-box {
                            display: grid; 
                            grid-template-columns: repeat(4, 1fr); 
                            gap: 10px; 
                            font-size: 9pt; 
                            font-weight: bold; 
                            padding: 8px; 
                            border: 1px solid #d1d5db; 
                            background: #f9fafb;
                            margin-bottom: 20px;
                        }
                        .data-box span { 
                            font-weight: normal; 
                            display: block; 
                            border-bottom: 1px solid #4b5563; 
                            margin-top: 2px;
                        }
                        .questions { 
                            column-count: 2; 
                            column-gap: 25px; 
                            list-style: decimal; 
                            padding-left: 20px;
                        }
                        .questions li { 
                            margin-bottom: 15px; 
                            break-inside: avoid;
                        }
                        .questions strong { font-weight: 700; }
                        .questions u { text-decoration: none; font-weight: 700; }
                        .footer { 
                            margin-top: 30px; 
                            padding-top: 10px; 
                            border-top: 1px solid #d1d5db; 
                            text-align: center; 
                            font-size: 8pt; 
                            color: #6b7280;
                        }

                        @media print {
                            body { font-size: 10pt; }
                            @page { margin: 1.5cm; }
                            .data-box { grid-template-columns: repeat(2, 1fr); gap: 15px; }
                            .questions { column-gap: 20px; }
                            .questions li { margin-bottom: 10px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <header class="header ${headerStyle}">
                            <h1>VERIFICA DI INFORMATICA - ${type} (${headerText})</h1>
                            <p>Docente: Giuseppe Borzumati | Argomento: ${examTitle}</p>
                        </header>
                        <div class="data-box">
                            <p>Nome: <span>${data.nome} ${data.cognome}</span></p>
                            <p>Classe: <span>${data.classe}</span></p>
                            <p>Data: <span>${data.data}</span></p>
                            <p>Punti Valutati: <span>${MAX_POINTS} / ${MAX_POINTS}</span></p>
                        </div>
                        
                        <h2 style="font-size: 14pt; font-weight: 700; margin-bottom: 15px;">Esercizi (${MAX_POINTS} Punti)</h2>
                        
                        <ol class="questions">
                            ${solutionListHTML}
                        </ol>
                        <footer class="footer">
                            ${isStudent ? 'Rispondere in modo ordinato. Ogni esercizio vale 1 punto. Voto calcolato su 20 punti.' : 'Griglia Soluzioni Docente. Voto calcolato su 20 Punti.'}
                            <br>
                            &copy; Prof. B.
                        </footer>
                    </div>
                </body>
                </html>
            `;
        }
        
        // Chiede la password e poi procede al download dei risultati
        function promptDownloadResultsPDF() {
            const password = prompt("Inserisci la password docente per scaricare il PDF con Voto e Correzioni Complete:");
            
            if (password === TEACHER_PASSWORD) {
                downloadResultsPDF(true); // Con voto e commenti
            } else if (password !== null) {
                 // Senza password, scarica un PDF solo con i tentativi
                if (confirm("Password errata. Vuoi scaricare comunque il report con solo i tentativi dello studente (senza voto/commenti)?")) {
                    downloadResultsPDF(false); 
                }
            }
        }

        // Genera il PDF dei risultati con commenti (Download Automatico)
        function downloadResultsPDF(showDetailedResults) {
            if (!currentExamData) return;

            // Raccogli i risultati attuali dal modulo
            const finalResults = gatherFinalResults();
            const studentName = currentExamData.studentData.nome + ' ' + currentExamData.studentData.cognome;
            
            // Genera il contenuto HTML per i risultati
            const resultsHTML = createResultsPDFContent(finalResults, showDetailedResults);
            
            const fileName = `Risultati_Verifica_${currentExamData.type}_${studentName.replace(/\s/g, '_')}_${showDetailedResults ? 'COMPLETO' : 'TENTATIVI'}.html`;
            
            // Scarica il file HTML/Blob
            downloadFile(resultsHTML, fileName, 'text/html');

            alert(`Download del file "${fileName}" completato. Aprirlo e salvarlo come PDF per la conservazione!`);
        }

        // Contenuto HTML per il PDF dei risultati
        function createResultsPDFContent(results, showDetailedResults) {
            const { gradeFloored, points, maxPoints, writtenGrade, writtenFormula, studentName, examType, examDate, studentClass } = results;
            const examTitle = examType === 'A' ? 'Sistemi di Numerazione' :
                              examType === 'B' ? 'IP e Sistemi Numerici' : 
                              examType === 'C' ? 'Complemento a Due e Floating Point' : 
                              'Master: C2, Float, ASCII, Base ID';
            
            const exercisesHTML = results.results.map((result, index) => {
                const q = currentExamData.questions[index];
                const qNum = index + 
                1;
                
                const statusClass = result.isCorrect ? 'bg-green-100 border-green-400' : 'bg-red-100 border-red-400';
                const statusIcon = result.isCorrect ? '‚úÖ CORRETTA' : '‚ùå ERRATA';
                
                return `
                    <div class="p-3 border rounded-lg ${showDetailedResults ? statusClass : 'bg-gray-100 border-gray-300'} mb-4 break-inside-avoid-page">
                        <p class="text-sm font-bold text-gray-800 mb-1">Esercizio ${qNum}: ${q.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                        <p class="text-xs mb-1">Risposta Fornita: <span class="code-font font-medium">${result.userAnswer}</span></p>
                        
                        ${showDetailedResults ? `
                            <p class="text-xs mb-1">Risposta Corretta: <span class="code-font font-medium text-green-700">${q.correct}</span></p>
                            <p class="text-xs mb-1 ${result.isCorrect ? 'text-green-700' : 'text-red-700'}">Status: ${statusIcon} (Punti: ${result.isCorrect ? 1 : 0})</p>
                            <p class="text-xs font-semibold text-gray-600 mt-1 border-t border-gray-300 pt-1">Commento Docente: ${result.comment}</p>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // Se non sono mostrati i risultati dettagliati, nascondo anche il voto
            const scoreSummaryHTML = showDetailedResults ? `
                <div class="grid">
                    <div class="box blue">Punti Ottenuti: ${points} / ${maxPoints}</div>
                    <div class="box red">Voto Finale (Arrotondato): ${gradeFloored} / 10</div>
                </div>

                <div class="summary">
                    <p><strong>Voto Scritto (base 10):</strong> ${writtenGrade}</p>
                    <p><strong>Formula:</strong> ${writtenFormula}</p>
                    <p>Il Voto Finale √® calcolato solo sul punteggio scritto (20 punti).</p>
                </div>
                <h2>Dettaglio Esercizi e Feedback</h2>
            ` : `
                <h2 style="color:#ef4444;">REPORT TENTATIVI STUDENTE</h2>
                <p>Questo report mostra solo le risposte fornite dallo studente, senza valutazione o voto finale.</p>
                <h2>Tentativi Esercizi</h2>
            `;

            
            // Contenuto HTML completo per il download
            return `
                <html>
                <head>
                    <title>Scheda di Valutazione - Verifica ${examType} - ${studentName}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Inter:wght@400;700;900&display=swap');
                        body { font-family: 'Inter', sans-serif; font-size: 10pt; margin: 0; padding: 0; background: #fff; }
                        .container { max-width: 21cm; margin: 0 auto; padding: 1cm; }
                        h1 { font-size: 18pt; color: #1e40af; border-bottom: 2px solid #1e40af; padding-bottom: 5px; }
                        h2 { font-size: 14pt; margin-top: 20px; color: #4b5563; }
                        p { margin-bottom: 5px; }
                        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; }
                        .box { padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; }
                        .blue { background-color: #dbeafe; color: #1e40af; font-size: 12pt; }
                        .red { background-color: #fee2e2; color: #991b1b; font-size: 12pt; }
                        .code-font { font-family: 'Roboto Mono', monospace; }
                        .summary { margin-top: 20px; padding: 10px; background: #f3f4f6; border-left: 5px solid #6366f1; border-radius: 5px;}
                        .exercises { column-count: 2; column-gap: 20px; margin-top: 20px; }
                        .break-inside-avoid-page { break-inside: avoid; }
                        strong { font-weight: 700; }

                        @media print {
                            .container { padding: 0.5cm; }
                            @page { margin: 1cm; }
                            .grid { display: block; }
                            .box { margin-bottom: 10px; }
                            .exercises { column-count: 2; column-gap: 15px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>Scheda di Valutazione - Verifica ${examType}: ${examTitle}</h1>
                        <p><strong>Studente:</strong> ${studentName}</p>
                        <p><strong>Classe:</strong> ${studentClass}</p>
                        <p><strong>Data Verifica:</strong> ${examDate}</p>

                        ${scoreSummaryHTML}
                        
                        <div class="exercises">
                            ${exercisesHTML}
                        </div>
                    </div>
                </body>
                </html>
            `;
        }

        // Inizializza l'app al caricamento
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

